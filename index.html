<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<!-- iOS Fullscreen Support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AI OS">
<title>AI OS (Line Pro v13)</title>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
/* --- 00_vars.css --- */
:root {
    /* Modern Minimalist Theme */
    --bg-wallpaper: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Soft Blue-Grey Gradient */
    --dock-bg: rgba(255, 255, 255, 0.6);
    --app-bg: #ffffff;
    --card-bg: #ffffff;
    --accent: #000000; --accent-dark: #333333; /* Black Accent for Minimalist */
    --text-main: #1d1d1f;
    --text-sub: #86868b;
    --line-bubble-me: #000000; --line-text-me: #ffffff;
    --line-bubble-ai: #f2f2f7; --line-text-ai: #1d1d1f;
    --border: rgba(0, 0, 0, 0.05);
    --danger: #ff3b30;
    --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(255, 255, 255, 0.5);
    --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    --ease-spring: cubic-bezier(0.25, 0.8, 0.25, 1);
    --app-font-scale: 1;
    --transfer-bg: #f5f5f7; --transfer-accent: #000000;
}

/* Responsive Root Font Size */
html {
    font-size: clamp(12px, 3.5vw, 16px); /* Dynamic scaling based on viewport width */
}

/* Themes Fixed */
body.theme-blue { 
    --bg-wallpaper: linear-gradient(135deg, #e0f7fa 0%, #e3f2fd 100%); 
    --app-bg: #f0f8ff; 
    --accent: #bcdae7; --accent-dark: #9bbecf; 
    --line-bubble-me: #bcdae7; 
    --transfer-bg: #E0F7FA; --transfer-accent: #bcdae7;
}
body.theme-mono { --accent: #5D606C; --accent-dark: #3e404a; --line-bubble-me: #5D606C; --line-text-me: #ffffff;}
body.theme-mint {
    --bg-wallpaper: #D5EAE3; --app-bg: #F8F4E9; --card-bg: #ffffff; --dock-bg: rgba(248, 244, 233, 0.6);
    --accent: #775C55; --accent-dark: #5c4640; --text-main: #775C55; --text-sub: #9FA8A3;
    --line-bubble-me: #775C55; --line-text-me: #F8F4E9; --line-bubble-ai: #F8F4E9; --line-text-ai: #775C55; --border: #D5EAE3;
}
body.theme-yellow {
    --bg-wallpaper: linear-gradient(135deg, #fff9e6 0%, #fff0b3 100%);
    --app-bg: #fffdf5;
    --accent: #F8DE96; --accent-dark: #ffe082;
    --text-main: #8d6e63; --text-sub: #bcaaa4;
    --line-bubble-me: #F8DE96; --line-text-me: #5d4037;
    --line-bubble-ai: #ffffff; --line-text-ai: #5d4037;
    --transfer-bg: #fffde7; --transfer-accent: #fbc02d;
}


/* --- 01_base.css --- */
/* --- 修复安卓键盘顶起时幽灵页面弹出 BUG (全局版) --- */
.app-window:not(.active), .post-detail-view:not(.active), #xhs-profile-edit:not(.active) {
    display: none !important;
}

/* --- 防止输入框自动放大导致的画面抖动 --- */
input, textarea {
    font-size: 16px !important; /* 强制字号，禁止浏览器缩放 */
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; touch-action: manipulation; }
input, textarea { user-select: text; }
body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background: #222; height: 100vh; height: 100dvh; overflow: hidden; color: var(--text-main); font-size: 16px !important; display: flex; justify-content: center; align-items: center; }

/* Global Smooth Animations */
.btn-main, .nav-btn, .list-item, .wb-app-item, .circle-btn, .xhs-card, .music-box, .wb-deco-area { transition: transform 0.3s var(--ease-spring), opacity 0.2s, background 0.2s; cursor: pointer; touch-action: manipulation; }
.btn-main:active, .nav-btn:active, .list-item:active, .wb-app-item:active, .circle-btn:active, .xhs-card:active, .music-box:active, .wb-deco-area:active { transform: scale(0.95); }

/* Common Components */
.app-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--app-bg); z-index: 100; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.32, 1, 0.23, 1); display: flex; flex-direction: column; padding-top: max(var(--safe-top), 20px); pointer-events: none; will-change: transform; backface-visibility: hidden; }
.app-window.active { transform: translateX(0); pointer-events: auto; }

.nav-bar { height: 3.5rem; display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; background: rgba(249, 249, 249, 0.9); backdrop-filter: blur(10px); border-bottom: 0.5px solid var(--border); z-index: 10; position: relative; flex-shrink: 0; }
body.theme-mint .nav-bar { background: rgba(248, 244, 233, 0.95); }
.nav-title { font-size: calc(1.1rem * var(--app-font-scale)); font-weight: 600; max-width: 50%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: absolute; left: 50%; transform: translateX(-50%); text-align: center; cursor: pointer; }
.nav-btn { background: none; border: none; font-size: calc(1rem * var(--app-font-scale)); color: var(--accent-dark); cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.3rem; min-width: 3rem; z-index: 10; }
.nav-btn:active { opacity: 0.5; }

.scroll-content { flex: 1; overflow-y: auto; padding: 1.2rem; padding-bottom: 5rem; }
.list-group { background: var(--card-bg); border-radius: 0.8rem; overflow: hidden; margin-bottom: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
.list-item { padding: 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid var(--border); cursor: pointer; background: var(--card-bg); transition: background 0.2s; }
.list-item:last-child { border-bottom: none; }
.list-item:active:not(.multi-select) { background: rgba(0,0,0,0.05); transform: scale(0.98); }
.list-item.active-preset { border-left: 4px solid var(--accent); padding-left: 0.8rem; background: rgba(0,0,0,0.03); }

input[type="text"], input[type="password"], textarea, select { width: 100%; border: none; background: transparent; font-size: calc(1rem * var(--app-font-scale)); font-family: inherit; color: var(--text-main); }
textarea { resize: none; min-height: 5rem; line-height: 1.4; }

.btn-main { width: 100%; padding: 0.9rem; background: var(--text-main); color: white; border-radius: 0.8rem; font-size: calc(1rem * var(--app-font-scale)); border: none; font-weight: 600; margin-top: 0.6rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 0.5rem; transition: transform 0.15s; }
.btn-main:active { transform: scale(0.96); opacity: 0.9; } .btn-danger { background: var(--danger); }
.btn-main.loading { opacity: 0.6; pointer-events: none; }

.circle-btn { width: 2.2rem; height: 2.2rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; flex-shrink: 0; cursor: pointer; border: none; transition: transform 0.2s; }
.circle-btn:active { transform: scale(0.85); } .btn-ghost { background: transparent; color: var(--text-sub); } .btn-fill { background: var(--accent); color: white; }

.check-mark { color: var(--accent); font-weight: bold; }
.preset-tag { background: var(--accent); color: white; padding: 0.15rem 0.5rem; border-radius: 0.4rem; font-size: calc(0.75rem * var(--app-font-scale)); }

/* Animations */
@keyframes msg-pop-in { 0% { opacity: 0; transform: translateY(20px) scale(0.9); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes claim-pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes wave-anim { 0%,100%{height:4px;opacity:0.6} 50%{height:14px;opacity:1} }
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
@keyframes toast-in { 0% { opacity: 0; transform: translate(-50%, -20px); } 100% { opacity: 1; transform: translate(-50%, 0); } }
@keyframes breathe { 0%,100%{transform:scale(1);box-shadow: 0 10px 30px rgba(255,213,213,0.3);} 50%{transform:scale(1.02);box-shadow: 0 15px 40px rgba(255,213,213,0.5);} }
@keyframes rotate { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

/* Typing Indicator */
.typing-indicator { display: flex; gap: 4px; padding: 4px 8px; align-items: center; height: 24px; }
.typing-dot { width: 6px; height: 6px; background: #999; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
.typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* Modern UI Tokens - Soft UI / iOS Style */
.ui-modern { background: #F2F4F6 !important; }
.card-modern {
    background: #ffffff;
    border-radius: 24px; /* Larger radius */
    padding: 24px;
    box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04), 0 4px 10px rgba(0,0,0,0.01); /* Softer, diffused shadow */
    margin-bottom: 20px;
    display: flex; flex-direction: column; gap: 16px;
    border: 1px solid rgba(0,0,0,0.02);
}
.btn-pill {
    border-radius: 50px; padding: 14px 28px; font-weight: 600; font-size: 15px;
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.btn-pill:active { transform: scale(0.96); box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.btn-black { background: #000000; color: white; }
.btn-white { background: #ffffff; color: #1d1d1f; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
.btn-danger { background: #ff3b30; color: white; }
.btn-danger-soft { background: #fff2f2; color: #ff3b30; box-shadow: none; }
.input-modern {
    background: #f5f5f7; border: 1px solid transparent; border-radius: 16px;
    padding: 14px 18px; font-size: 16px; width: 100%; outline: none;
    transition: all 0.2s;
}
.input-modern:focus { background: #ffffff; border-color: rgba(0,0,0,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.label-modern {
    font-size: 13px; color: #86868b; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;
}


/* --- 02_home.css --- */
#iphone-screen {
    background: var(--bg-wallpaper); background-image: var(--bg-wallpaper-url, none); background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important;
    width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column;
}

/* Desktop Layout (Simulator Mode) */
@media (min-width: 769px) {
    #iphone-screen {
        max-width: 430px; max-height: 932px; border-radius: 40px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }
    body { background: #222; }
}
/* Mobile Layout (Full Screen) */
@media (max-width: 768px) {
    body { background: #000; }
    #iphone-screen { border-radius: 0; box-shadow: none; max-width: none; max-height: none; }
}

#home-screen {
    flex: 1; display: flex; flex-direction: column;
    padding-top: max(var(--safe-top), 10px);
    overflow: hidden;
    background: #f8f9fa;
}

.main-card {
    flex: 1;
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 2.2rem;
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
    margin: 0.6rem 1rem;
    padding: 1rem; /* Further reduced padding */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

.sub-card {
    height: 100px;
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.6);
    margin: 0 15px 25px 15px;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(31, 38, 135, 0.05);
}

.sub-banner { width: 100%; height: 100%; border-radius: 20px; overflow: hidden; position: relative; }
.sub-banner img { width: 100%; height: 100%; object-fit: cover !important; }
.sub-banner-text { display: none; }

/* Vinyl Player Style (Light Theme) */
.vinyl-player {
    width: 100%;
    aspect-ratio: 1;
    background: rgba(255,255,255,0.3);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 20px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    backdrop-filter: blur(5px);
}
.vinyl-player img { width: 100%; height: 100%; object-fit: cover; }

.vinyl-disc {
    width: 85%;
    height: 85%;
    /* Simplified background, mostly covered by img */
    background: radial-gradient(circle, #eef 0%, #fff 100%);
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 50%;
    position: relative;
    box-shadow: 0 4px 15px rgba(100,149,237,0.1);
    animation: rotate 8s linear infinite;
    animation-play-state: paused;
    overflow: hidden; /* Ensure image fits circle */
}
.vinyl-disc img {
    width: 100%; height: 100%; object-fit: cover;
}

/* Removed complex vinyl-disc::before and vinyl-cover styles as user wanted simple one image */
.vinyl-disc.playing { animation-play-state: running; }

.wb-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.wb-avatar-box { text-align: center; }
.wb-avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); box-shadow: 0 4px 10px rgba(0,0,0,0.1); object-fit: cover; }
.wb-date-box { text-align: right; color: var(--text-main); }
.wb-day { font-size: calc(24px * var(--app-font-scale)); font-weight: 300; letter-spacing: 1px; }
.wb-time { font-size: calc(14px * var(--app-font-scale)); opacity: 0.7; letter-spacing: 2px; }

/* Partner Widget (Deco) */
.wb-deco-area { 
    height: 100px;
    background: rgba(255,255,255,0.4); border-radius: 20px; 
    position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.5);
    cursor: pointer;
}
.wb-deco-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
.wb-deco-tag { position: absolute; bottom: 5px; right: 10px; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 8px; font-size: calc(10px * var(--app-font-scale)); color: var(--accent); font-weight: bold; }

.wb-apps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.wb-app-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
.wb-app-icon {
    width: 48px; height: 48px; border-radius: 14px; background: rgba(255,255,255,0.8);
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 4px 10px rgba(135, 169, 235, 0.15); color: var(--accent);
    font-size: 20px; transition: transform 0.1s; border: 1px solid rgba(255,255,255,0.6);
    overflow: hidden;
}
.wb-app-item:active .wb-app-icon { transform: scale(0.9); }
.wb-app-icon img { width: 100%; height: 100%; object-fit: cover; }
.wb-app-name { font-size: calc(10px * var(--app-font-scale)); color: var(--text-main); font-weight: 500; opacity: 0.8; }

.wb-status-box {
    width: 138.1px !important; height: 143.1px !important; flex: none;
    background: rgba(255,255,255,0.4); border-radius: 20px; padding: 10px;
    font-size: calc(11px * var(--app-font-scale)); color: #78909c; display: flex; flex-direction: column; justify-content: center; gap: 4px;
    border: 1px solid rgba(255,255,255,0.5);
}

/* Desktop Widget */
.zm-widget {
    height: 90px; background: rgba(255,255,255,0.45); border-radius: 24px; 
    margin-top: 15px; border: 1px solid rgba(255,255,255,0.6);
    display: flex; align-items: center; padding: 0 20px; gap: 18px; cursor: pointer;
    backdrop-filter: blur(8px); box-shadow: 0 8px 25px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}
.zm-widget:active { transform: scale(0.96); }
.zm-icon { width: 52px; height: 52px; background: linear-gradient(135deg, #FFD5D5, #FFAAAA); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05); overflow: hidden; }
.zm-icon img { width: 100%; height: 100%; object-fit: cover; }
.zm-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.zm-title { font-size: calc(16px * var(--app-font-scale)); font-weight: 600; color: var(--text-main); letter-spacing: 0.5px; }
.zm-sub { font-size: calc(12px * var(--app-font-scale)); color: var(--text-sub); margin-top: 4px; opacity: 0.8; }

/* New Layout Classes */
.top-info-row {
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 0 5px; margin-bottom: 10px;
}
.mid-content-grid {
    display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px;
    overflow: hidden;
}
.music-box {
    background: rgba(255,255,255,0.4); border-radius: 25px;
    padding: 15px; display: flex; flex-direction: column; gap: 10px;
}
.music-info { font-size: calc(12px * var(--app-font-scale)); text-align: center; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.music-ctrl { display: flex; justify-content: center; gap: 15px; margin-top: 5px; color: var(--accent); }

.apps-box {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start;
}

/* Dock Icons SVG sizing */
svg { width: 28px; height: 28px; stroke-width: 2; }


/* --- 03_chat.css --- */
/* Chat Interface */
#sub-chat-room {
    background: var(--app-bg) !important; /* Solid Background */
    /* No backdrop-filter on the window itself to avoid leaking desktop */
}

/* Decoration SVG Pattern */
#sub-chat-room::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.6;
}

#sub-chat-room .nav-bar { 
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    border-radius: 0 !important;
    width: 100% !important;
    z-index: 10;
}
#sub-chat-room .nav-title { font-size: calc(16px * var(--app-font-scale)); letter-spacing: 0.5px; font-weight: 700; color: var(--text-main); text-shadow: 0 1px 2px rgba(255,255,255,0.8); }

/* Image Layer (Bottom) */
#chat-bg-image { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    z-index: 0; 
    background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important; 
}

/* Glass/Blur Layer (Overlay) */
#chat-bg-layer { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    z-index: 1; 
    background-color: rgba(255, 255, 255, 0.4); /* White tint */
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    transition: opacity 0.3s; 
    /* Opacity is controlled by JS via settings */
}

/* Unified Chat Glass Container */
.chat-unified-glass {
    position: absolute;
    top: calc(10px + var(--safe-top));
    left: 15px;
    right: 15px;
    bottom: calc(15px + var(--safe-bottom));
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 35px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 50; /* Higher than bg layers */
}

/* Ensure messages are above background layers */
#chat-messages { z-index: 5; flex: 1; overflow-y: auto; padding: 15px; }

.avatar-circle { width: 44px; height: 44px; border-radius: 50%; background: #eee; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
.contact-row { display: flex; align-items: center; gap: 12px; width: 100%; }

/* Toast Notification System */
#global-toast {
    position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
    color: white; padding: 10px 20px; border-radius: 20px;
    font-size: calc(14px * var(--app-font-scale)); font-weight: 500;
    z-index: 20000; opacity: 0; pointer-events: none;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex; align-items: center; gap: 8px;
}
#global-toast.show { opacity: 1; transform: translate(-50%, 0); animation: toast-in 0.3s; }

/* 消息气泡系统 */
#chat-messages { padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; z-index: 1; position: relative; }
.msg-block { display: flex; gap: 8px; max-width: 90%; align-items: flex-start; transform-origin: bottom center; } 
.msg-block.me { align-self: flex-end; flex-direction: row-reverse; }
.msg-block.ai { align-self: flex-start; flex-direction: row; }
/* Modified Animation */
.bubble.new-bubble { animation: msg-pop-in 0.4s var(--ease-spring); }
.bubbles-stack { display: flex; flex-direction: column; gap: 6px; max-width: 100%; }
.msg-block.me .bubbles-stack { align-items: flex-end; }
.msg-block.ai .bubbles-stack { align-items: flex-start; }

.msg-avatar { width: 36px; height: 36px; border-radius: var(--avatar-radius, 50%); object-fit: cover; background: #ddd; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 0; transition: border-radius 0.3s; }

.bubble { 
    padding: 10px 14px; 
    font-size: var(--chat-font-size, calc(16px * var(--app-font-scale))); 
    line-height: 1.5; 
    position: relative; 
    word-wrap: break-word; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.03); /* Simplified Shadow */
    text-align: left; 
    white-space: pre-wrap; 
    user-select: text; 
    max-width: 100%; 
    cursor: default;
    backdrop-filter: blur(10px); /* Stronger Glass Bubble */
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.5); /* Whiter border */
}
/* 圆角逻辑 */
.bubble { border-radius: 16px; } /* Slightly tighter radius for cleaner look */
.msg-block.me .bubble:not(:first-child) { border-top-right-radius: 4px; }
.msg-block.me .bubble:not(:last-child) { border-bottom-right-radius: 4px; }
.msg-block.me .bubble:last-child { border-bottom-right-radius: 16px; }
.msg-block.ai .bubble:not(:first-child) { border-top-left-radius: 4px; }
.msg-block.ai .bubble:not(:last-child) { border-bottom-left-radius: 4px; }
.msg-block.ai .bubble:last-child { border-bottom-left-radius: 16px; }

.msg-block.me .bubble { 
    background: var(--line-bubble-me, rgba(255, 213, 213, 0.4)); /* More transparent */
    color: var(--line-text-me); 
    border: 1px solid rgba(255,255,255,0.4);
}
.msg-block.ai .bubble { 
    background: var(--line-bubble-ai, rgba(255, 255, 255, 0.3)); /* More transparent */
    color: var(--line-text-ai);
    border: 1px solid rgba(255,255,255,0.4);
}

/* Transfer Bubble Style */
.bubble.transfer-bubble {
    background: var(--transfer-bg) !important; color: #006064 !important;
    padding: 12px 18px; border-radius: 16px !important;
    min-width: 220px; border: 1px solid rgba(0,188,212,0.2);
    display: flex; flex-direction: column; gap: 8px;
}
.transfer-icon { 
    width: 32px; height: 32px; background: var(--transfer-accent); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    color: white; margin-right: 10px; flex-shrink: 0;
}
.transfer-amount { font-size: calc(24px * var(--app-font-scale)); font-weight: bold; font-family: 'SF Pro Display', sans-serif; }
.transfer-desc { font-size: calc(13px * var(--app-font-scale)); opacity: 0.7; }
.transfer-status { font-size: calc(12px * var(--app-font-scale)); margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(0,0,0,0.1); opacity: 0.6; }

.bubble img.chat-img { max-width: 100%; border-radius: 8px; display: block; }
.bubble img.emoticon-img { max-width: 120px; max-height: 120px; border-radius: 8px; display: block; }
.bubble.img-text-wrapper { padding: 0; overflow: hidden; cursor: pointer; position: relative; width: 140px; height: 140px; }
.img-text-mask { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.2s; }

.quote-ref { font-size: calc(12px * var(--app-font-scale)); color: rgba(0,0,0,0.5); border-left: 2px solid var(--accent); padding-left: 6px; margin-bottom: 4px; display: block; white-space: pre-wrap; word-break: break-word; max-width: 100%; }
.msg-block.me .quote-ref { color: rgba(255,255,255,0.7); border-color: rgba(255,255,255,0.7); }

/* 脚标 (Footer) */
.msg-footer-row { display: flex; align-items: center; gap: 6px; font-size: calc(10px * var(--app-font-scale)); color: rgba(0,0,0,0.4); font-weight: 500; margin-top: 2px; }
.msg-block.me .msg-footer-row { flex-direction: row-reverse; }
.read-status { color: var(--accent); margin-right: 4px; font-weight: bold; }

.ts-badge { align-self: center; background: rgba(0,0,0,0.05); color: #888; font-size: calc(11px * var(--app-font-scale)); padding: 2px 8px; border-radius: 10px; margin: 10px 0; font-weight: 500; }
.blocked-icon { width: 18px; height: 18px; background: #ff3b30; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: calc(14px * var(--app-font-scale)); font-weight: bold; margin-right: 5px; margin-left: 5px; align-self: center; }

/* 多选 Checkbox */
.msg-checkbox {
    width: 22px; height: 22px; border-radius: 50%; border: 2px solid #ccc;
    display: none; align-items: center; justify-content: center;
    background: white; flex-shrink: 0; cursor: pointer; 
    align-self: center; z-index: 50; transition: all 0.2s;
}
.msg-checkbox.checked { background: var(--accent); border-color: var(--accent); }
.msg-checkbox.checked::after { content: '✓'; color: white; font-size: calc(14px * var(--app-font-scale)); font-weight: bold; }
.chat-mode-select .msg-checkbox { display: flex; }
.msg-block.ai .msg-checkbox { margin-right: 12px; order: -1; }
.msg-block.me .msg-checkbox { margin-left: 12px; order: -1; } 

.quote-preview-bar { position: absolute; bottom: 100%; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-top: 0.5px solid var(--border); padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: calc(13px * var(--app-font-scale)); color: var(--text-sub); transform: translateY(100%); transition: transform 0.2s; z-index: 15; visibility: hidden; }
.quote-preview-bar.active { transform: translateY(0); visibility: visible; }
.quote-text { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 85%; border-left: 3px solid var(--accent); padding-left: 6px; }

.chat-input-area { 
    position: relative; 
    bottom: auto; width: 100%; left: auto;
    background: transparent; 
    backdrop-filter: none; -webkit-backdrop-filter: none;
    padding: 12px 15px; padding-bottom: 12px;
    border: none; 
    border-radius: 0;
    display: flex; align-items: flex-end; gap: 10px; z-index: 30; 
    transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1);
    box-shadow: none;
    border-top: 1px solid rgba(255,255,255,0.2);
}
.chat-input-area.input-up { transform: translateY(-320px); }

.chat-input { 
    flex: 1; 
    background: rgba(255, 255, 255, 0.85); 
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 24px; 
    padding: 8px 16px; font-size: calc(16px * var(--app-font-scale)); height: 40px; min-height: 40px; max-height: 120px; 
    line-height: 22px; margin: 0; 
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
    transition: background 0.2s, box-shadow 0.2s;
} 
.chat-input:focus { background: rgba(255,255,255,0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
body.theme-mint .chat-input { background: rgba(232, 239, 234, 0.6); }

/* Plus Menu & Emoticons */
.plus-menu-drawer { 
    position: absolute; bottom: 0; left: 0; width: 100%; height: 320px; 
    background: #f7f7f7; 
    z-index: 60; /* Higher than unified glass (50) */
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    grid-auto-rows: min-content;
    gap: 20px; 
    padding: 30px 20px;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1);
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    will-change: transform;
}
.plus-menu-drawer.active { transform: translateY(0); }
.plus-item { 
    display: flex; flex-direction: column; align-items: center; gap: 8px; 
    cursor: pointer; border: none; padding: 0; background: none;
    font-size: calc(12px * var(--app-font-scale)); color: #666;
}
.plus-item:active { transform: scale(0.95); background: none; }
.plus-icon-box {
    width: 60px; height: 60px; 
    background: #fff; border-radius: 16px; 
    display: flex; align-items: center; justify-content: center;
    font-size: calc(24px * var(--app-font-scale)); color: #333;
    border: 1px solid rgba(0,0,0,0.05);
}
#emoticon-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 320px; background: var(--card-bg); z-index: 60; /* Higher than unified glass */ display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s; border-top: 0.5px solid var(--border); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); will-change: transform; }
#emoticon-panel.active { transform: translateY(0); }

.emoticon-grid {
    padding: 15px;
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px; 
    overflow-y: auto;
    align-content: start; 
    flex: 1; 
    min-height: 0;
}

.emoticon-item {
    position: relative;
    width: 100%;
    padding-bottom: 100%; 
    height: 0;
    border-radius: 8px;
    overflow: hidden;
    background: #f5f5f5;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
}

.emoticon-item img {
    position: absolute; 
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover; 
    display: block;
    z-index: 1;
}

.emoticon-name {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(0,0,0,0.6); 
    color: white;
    font-size: calc(10px * var(--app-font-scale));
    text-align: center;
    padding: 4px 0;
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis; 
    z-index: 5; 
}

/* Drawer Overlay */
#drawer-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.2);
    z-index: 55; /* Between glass(50) and drawer(60) */
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
#drawer-overlay.active { opacity: 1; pointer-events: auto; }

/* Global Status Bar */
#global-status-bar {
    position: absolute; top: 0; left: 0; width: 100%; height: var(--safe-top, 20px);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 25px; padding-right: 45px; font-size: 14px; 
    font-weight: 300; /* Thin font as requested */
    color: var(--text-main);
    z-index: 2000; pointer-events: none;
    box-sizing: content-box; padding-top: 5px;
}
.gs-left { font-family: 'SF Pro Display', sans-serif; letter-spacing: 0.5px; }
.gs-right { display: flex; align-items: center; gap: 6px; }
.gs-icon { width: 18px; height: 18px; stroke-width: 1.5; }

/* Context Menu */
.ctx-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 900; background: rgba(0,0,0,0.2); opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(2px); }
.ctx-overlay.active { opacity: 1; pointer-events: auto; }
.ctx-menu { position: absolute; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-radius: 12px; width: 160px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.2s; }
.ctx-item { padding: 14px; text-align: center; border-bottom: 0.5px solid #ccc; font-size: calc(16px * var(--app-font-scale)); color: #007aff; cursor: pointer; } .ctx-item.danger { color: var(--danger); }

/* Settings Drawer */
#chat-settings-drawer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--app-bg); z-index: 200; transform: translateY(100%); transition: transform 0.3s; display: flex; flex-direction: column; padding-top: 44px; }
#chat-settings-drawer.active { transform: translateY(0); }
.avatar-uploader-row { display: flex; justify-content: space-around; padding: 20px 0; }
.upload-circle { width: 70px; height: 70px; border-radius: 50%; border: 2px dashed #ccc; overflow: hidden; display: flex; justify-content: center; align-items: center; } .upload-circle img { width: 100%; height: 100%; object-fit: cover; }
#summary-edit-panel { padding: 15px; background: #f0f0f5; border-radius: 8px; margin-top: 10px; }

/* Line UI Redesign */
#app-line {
    /* Push content down to leave room for simulated status bar space */
    padding-top: calc(max(var(--safe-top), 20px) + 20px) !important;
}

#app-line .bottom-nav {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: none;
    margin: 10px 15px 0 15px;
    border-radius: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    height: 65px;
    position: absolute;
    bottom: calc(10px + var(--safe-bottom));
    width: calc(100% - 30px);
    padding-bottom: 0;
}
#app-line .scroll-content { padding-bottom: 90px; }
#app-line .list-group, #contacts-list, #chat-list-container {
    background: transparent;
    box-shadow: none;
    border-radius: 0;
}
#app-line .list-item {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 18px;
    margin-bottom: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.02);
    transition: transform 0.2s;
}
#app-line .list-item:active { transform: scale(0.98); background: rgba(255,255,255,0.9); }
#app-line .nav-bar {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: none;
    
    /* FIX: Standard Layout to match Worldbook */
    margin: 0;
    border-radius: 0;
    width: 100%;
    position: relative;
    left: auto;
    top: auto;
    height: 50px;
    min-height: 50px;
    z-index: 50;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
#app-line .tab-content { padding-top: 0; background: var(--bg-wallpaper) !important; background-image: var(--bg-wallpaper-url) !important; background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important; }
.line-tabs { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
.tab-content { flex:1; overflow:hidden; display:none; flex-direction:column; width: 100%; height: 100%; }
.tab-content.active { display:flex; }
.bottom-nav { height: 60px; padding-bottom: env(safe-area-inset-bottom); background: rgba(255,255,255,0.95); border-top: 0.5px solid var(--border); display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; z-index:90; }
.nav-tab { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-sub); font-size: calc(10px * var(--app-font-scale)); cursor: pointer; width: 60px; }
.nav-tab.active { color: var(--text-main); font-weight: 600; }
.nav-tab svg { width: 24px; height: 24px; stroke-width: 1.5; }

/* Contacts Grid View to List View Update */
#contacts-list { display: flex; flex-direction: column; padding: 0; }
#contacts-list .list-item { 
    flex-direction: row; padding: 12px 20px; 
    align-items: center; text-align: left;
    height: 72px;
    margin: 5px 15px; /* Floating margin */
    width: calc(100% - 30px);
    border-radius: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
#contacts-list .contact-row { flex-direction: row; gap: 15px; }
#contacts-list .avatar-circle { width: 48px; height: 48px; border-radius: 8px; }

/* Transfer Receipt Style */
.bubble.transfer-receipt-bubble {
    background: var(--transfer-bg) !important; color: #006064 !important;
    padding: 12px 18px; border-radius: 16px !important;
    min-width: 180px; border: 1px solid rgba(0,188,212,0.2);
    display: flex; flex-direction: column; gap: 8px;
}
.receipt-icon { 
    width: 32px; height: 32px; background: var(--transfer-accent); 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; 
    color: white; margin-right: 10px; flex-shrink: 0; font-weight: bold;
}


/* --- 04_moments.css --- */
/* Moments UI - Modern Minimalist / Soft UI / iOS Style */
.moments-feed {
    padding: 0 1.2rem; /* Add side padding to container so cards float */
    background: #F8F9FA;
    min-height: 100%;
    padding-bottom: 7.5rem;
    padding-top: 0.6rem;
}

/* Header - Floating Profile Card */
.moment-header-area {
    background: #fff;
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); /* Soft floating shadow */
    border: none;
    position: relative;
}

/* Hidden Cover */
.moment-cover { display: none; }

.ins-header-container {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
}

.ins-top-row {
    display: flex;
    align-items: center;
    gap: 1.2rem; /* Space between avatar and stats */
}

.moment-avatar {
    width: 5.25rem; height: 5.25rem;
    border-radius: 50%;
    object-fit: cover;
    background: #f0f0f0; cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08); /* Soft avatar shadow */
    border: 3px solid #fff;
}

/* Stats - Pill Style? Or Clean Text */
.moment-stats-row {
    display: flex;
    justify-content: space-around;
    flex: 1;
    background: #F9FAFB; /* Subtle bg for stats pill */
    padding: 0.75rem;
    border-radius: 1.2rem; /* Pill shape container */
}

.moment-stat-item {
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer;
}

.moment-stat-num { font-size: 1.1rem; font-weight: 700; color: #333; }
.moment-stat-label { font-size: 0.75rem; color: #999; margin-top: 0.1rem; font-weight: 500; }

/* Bio Section */
.ins-bio-row {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding-left: 0.3rem;
}

.moment-username {
    color: #111; font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px;
}
.moment-sign {
    color: #666; font-size: 0.9rem; line-height: 1.5;
    white-space: pre-wrap;
}

/* Feed List */
.moment-list {
    background: transparent;
    padding-top: 0;
}

/* Card Style */
.moment-card {
    background: #fff;
    border-radius: 1.5rem; /* Large rounded corners */
    padding: 1.5rem; /* Large padding */
    margin-bottom: 1.2rem; /* Vertical stacking spacing */
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); /* Soft floating shadow */
    border: none;
    display: flex; flex-direction: column; gap: 1rem;
}
.moment-card:last-child { margin-bottom: 0; }

/* Inner Content Padding removed since card has padding */
.m-header, .m-content-box {
    padding: 0;
}

/* User Info Row */
.m-header { display: flex; align-items: center; gap: 0.75rem; position: relative; margin-bottom: 0.3rem; }
.m-avatar { width: 2.75rem; height: 2.75rem; border-radius: 50%; object-fit: cover; background: #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.m-info { display: flex; flex-direction: column; }
.m-name { color: #333; font-weight: 700; font-size: 1rem; letter-spacing: -0.3px; }

/* Content */
.m-text {
    font-size: 1rem; line-height: 1.6; color: #444;
    white-space: pre-wrap; margin-bottom: 0.75rem;
}
.m-text.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.m-expand-btn {
    color: #999; font-size: 0.9rem; cursor: pointer; margin-top: 0.25rem; display: none;
}

/* Image Grid */
.m-grid { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.6rem; border-radius: 1rem; overflow: hidden; }
/* Square grid for feed */
.m-grid img {
    width: calc(33.33% - 0.27rem);
    aspect-ratio: 1;
    object-fit: cover;
    cursor: zoom-in; background: #f0f0f0;
    border-radius: 0.5rem; /* Inner radius for images */
}
.m-grid.single img {
    width: 100%; max-width: 100%; aspect-ratio: auto; max-height: 25rem;
    border-radius: 1rem;
}

/* Action Bar */
.m-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; height: 1.75rem; }
.m-time { color: #ccc; font-size: 0.75rem; font-weight: 500; }

/* Icons */
.m-actions-row { display: flex; gap: 1rem; }
.m-action-btn {
    background: #f0f2f5;
    padding: 0;
    border-radius: 50%; /* Circle btn for dots */
    color: #666; font-size: 0.9rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center; width: 2rem; height: 2rem;
    transition: background 0.2s;
}
.m-action-btn:active { background: #e0e0e0; }

/* Like & Comment Popover - Horizontal Pill */
.m-popover {
    position: absolute; right: 2.8rem; top: -0.1rem;
    background: #333;
    border-radius: 1.2rem; /* Pill shape */
    display: flex; align-items: center;
    padding: 0 0.3rem; height: 2.25rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    opacity: 0; transform: scaleX(0); transform-origin: right; pointer-events: none;
    transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    color: white; overflow: hidden;
    white-space: nowrap; /* Prevent wrap */
    flex-direction: row; /* Force Horizontal */
}
.m-popover.show { opacity: 1; transform: scaleX(1); pointer-events: auto; }
.m-pop-item {
    font-size: 0.8rem; color: white; display: flex; align-items: center; gap: 0.4rem; cursor: pointer;
    padding: 0 1rem; height: 100%; font-weight: 600;
}
.m-pop-item:active { background: rgba(255,255,255,0.1); }
.m-pop-line { width: 1px; height: 1rem; background: rgba(255,255,255,0.2); }

/* Like Animation */
@keyframes like-bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}
.m-like-anim {
    animation: like-bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    fill: #ff3b30 !important; stroke: #ff3b30 !important; color: #ff3b30;
}

/* Delete Menu (Top Right 3 dots) */
.m-more-btn {
    color: #ccc; cursor: pointer;
    padding: 0.3rem; font-weight: bold; font-size: 1.25rem;
    line-height: 0.5; /* Tighten line height for dots */
    letter-spacing: 1px;
}
.m-menu-pop {
    position: absolute; right: 0; top: 1.8rem;
    background: white; border-radius: 0.75rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: none; flex-direction: column;
    z-index: 100; border: none;
    min-width: 6rem; overflow: hidden;
}
.m-menu-pop.active { display: flex; animation: fade-in 0.2s; }
.m-menu-item {
    padding: 0.75rem 1rem; font-size: 0.9rem; color: #333;
    border-bottom: 1px solid #f9f9f9; text-align: center; font-weight: 500;
}
.m-menu-item:last-child { border-bottom: none; }
.m-menu-item.danger { color: #ff3b30; }

/* Sticky Glass Header override */
#tab-moments .nav-bar {
    position: sticky; top: 0;
    background: rgba(255,255,255,0.85) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    box-shadow: none !important;
}

/* Message Board View Specifics */
#moments-msg-view .nav-bar {
    box-shadow: none !important;
    border-bottom: 1px solid #f0f0f0;
}
.msg-item {
    background: #fff;
    border-radius: 1rem;
    padding: 1rem;
    margin-bottom: 0.6rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: none !important; /* Override inline border */
    align-items: center !important;
}
.msg-av { width: 3rem !important; height: 3rem !important; border-radius: 0.75rem !important; }
.msg-content { margin-left: 0.6rem; }
.msg-name { font-size: 1rem !important; }
.msg-text { color: #555 !important; }

/* Button Pills */
.btn-pill-black {
    background: #000; color: white; border-radius: 2rem;
    padding: 0.5rem 1.25rem; font-weight: 600; font-size: 0.9rem; border: none; cursor: pointer;
}


/* --- 05_lifeos.css --- */
/* LifeOS App Styles */
#app-lifeos .nav-bar { background: rgba(255,245,245,0.95); }
#app-lifeos { background: linear-gradient(180deg, #fff0f5 0%, #fff 100%); }
.life-tabs { display: flex; justify-content: space-around; padding: 0.4rem; background: rgba(255,255,255,0.6); margin: 0.6rem 1rem; border-radius: 1.25rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); backdrop-filter: blur(10px); }
.life-tab-btn { padding: 0.6rem 1.25rem; border-radius: 1rem; color: var(--text-sub); font-size: calc(0.9rem * var(--app-font-scale)); font-weight: 600; transition: all 0.3s; flex: 1; text-align: center; }
.life-tab-btn.active { background: white; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

/* Focus Tab */
.focus-circle-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2.5rem 0; transition: all 0.5s; }
.focus-circle-container.compact { padding: 0.6rem 0; transform: scale(0.8); }
.focus-circle { width: 13.75rem; height: 13.75rem; border-radius: 50%; border: 6px solid rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: calc(3rem * var(--app-font-scale)); font-weight: 300; color: var(--text-main); position: relative; background: rgba(255,255,255,0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.05); font-variant-numeric: tabular-nums; }
.focus-circle.active { border-color: #FFD5D5; background: white; animation: breathe 4s infinite ease-in-out; }
.focus-controls { display: flex; gap: 1.25rem; margin-top: 2rem; align-items: center; }
.focus-chat-area { flex: 1; background: rgba(255,255,255,0.6); margin: 0 1rem 1rem 1rem; border-radius: 1.5rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.8); display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(10px); }
.focus-chat-area.active { display: flex; opacity: 1; }
/* Refined Focus Input */
.focus-duration-input {
    background: transparent; border: none; font-size: calc(1.5rem * var(--app-font-scale)); font-weight: bold; color: var(--text-main);
    width: 3.75rem; text-align: center; border-bottom: 2px solid var(--accent); border-radius: 0;
}

/* Care Tab - Calendar & Tips */
.care-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.3rem; margin: 1rem; }
.care-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: calc(0.9rem * var(--app-font-scale)); color: var(--text-main); cursor: pointer; transition: background 0.2s; }
.care-day.today { border: 1px solid var(--accent); }
.care-day.period { background: #FFD5D5; color: #d63031; font-weight: bold; }
.care-day.period-start { background: #ff7675; color: white; }
.care-day:active { transform: scale(0.9); background: rgba(0,0,0,0.05); }
.care-header { display: flex; justify-content: space-between; align-items: center; padding: 0 1.25rem; margin-top: 0.6rem; font-weight: bold; font-size: calc(1.1rem * var(--app-font-scale)); }
.care-tip-card { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); margin: 1rem; padding: 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.5); font-size: calc(0.8rem * var(--app-font-scale)); line-height: 1.5; color: #666; display: flex; gap: 0.6rem; align-items: start; }
.care-detail-opts { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.6rem; }
.care-tag { padding: 0.25rem 0.6rem; border-radius: 1.25rem; border: 1px solid var(--border); font-size: calc(0.75rem * var(--app-font-scale)); cursor: pointer; background: rgba(255,255,255,0.5); }
.care-tag.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Meds Tab */
.med-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.7); padding: 1.1rem 1.25rem; margin-bottom: 0.75rem; border-radius: 1.25rem; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: transform 0.2s; }
.med-item.done { opacity: 0.6; filter: grayscale(1); }
.med-time { font-size: calc(1.25rem * var(--app-font-scale)); font-weight: 600; color: var(--text-main); font-family: 'SF Pro Display'; }
.med-name { font-size: calc(0.9rem * var(--app-font-scale)); color: var(--text-sub); margin-left: 1rem; flex: 1; }
.med-check { width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 0.6rem; }
.med-check.checked { background: var(--accent); }
.med-check.checked::after { content: '✓'; color: white; font-size: calc(0.9rem * var(--app-font-scale)); font-weight: bold; }


/* --- 06_reading.css --- */
/* 共读功能样式 - Modern Minimalist / Soft UI */
#reading-drawer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F9FAFB; /* 更现代的灰白背景 */
    z-index: 300; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 1, 0.23, 1);
    display: flex; flex-direction: column;
}
#reading-drawer.active { transform: translateY(0); }
.reading-paper {
    flex: 1; margin: 0; background: transparent;
    padding: 25px 30px; overflow-y: auto;
    font-size: 18px; line-height: 2.0; color: #2c2c2c; font-family: 'Songti SC', serif; white-space: pre-wrap;
    word-wrap: break-word; word-break: break-all;
    transition: padding-bottom 0.3s;
}
.reading-settings-panel {
    position: absolute; top: 60px; left: 15px; width: 260px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-radius: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    padding: 25px; display: none; flex-direction: column; gap: 20px; z-index: 50;
    border: 1px solid rgba(255,255,255,0.5);
}
.reading-settings-panel.active { display: flex; animation: fade-in 0.2s; }
.reading-paper.shrink {
    height: 55% !important;
    flex: none !important;
    padding-bottom: 20px !important;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
/* 头部和底部 - iOS 极致毛玻璃 */
.reading-header {
    height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: none; box-shadow: 0 4px 20px rgba(0,0,0,0.03); z-index: 10;
}
.reading-footer {
    height: auto; padding: 12px 20px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
    background: rgba(255,255,255,0.8); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-top: none; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
    display: flex; justify-content: space-between; align-items: center; gap: 15px; z-index: 10;
    transition: opacity 0.3s, transform 0.3s;
}
.reading-footer.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
.color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
.color-opt {
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
    border: 2px solid rgba(255,255,255,0.5);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}
.color-opt:active { transform: scale(0.9); }

/* 悬浮玻璃胶囊按钮 */
.resonance-btn {
    display: flex; align-items: center; gap: 8px;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.6);
    padding: 10px 24px; border-radius: 50px;
    color: #333; font-size: 14px; font-weight: 600;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    transition: all 0.2s;
}
.resonance-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.6); }
.resonance-btn svg { color: #555; }

/* 心绪聊天框 - 悬浮卡片风格 */
.resonance-chat-box {
    position: absolute; bottom: 20px; left: 15px; right: 15px; width: auto; height: 50%;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
    border-radius: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
    transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.32, 1, 0.23, 1);
    z-index: 310; display: flex; flex-direction: column;
    border: none;
    overflow: hidden;
}
.resonance-chat-box.active { transform: translateY(0); }

/* 书架样式 - 现代极简 */
#reading-shelf {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F2F4F6; /* 柔和灰白背景 */
    z-index: 290; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1);
    display: flex; flex-direction: column;
}
#reading-shelf.active { transform: translateY(0); }
.shelf-grid { padding: 25px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; align-content: start; }
.book-item { display: flex; flex-direction: column; gap: 10px; cursor: pointer; position: relative; transition: transform 0.2s; }
.book-item:active { transform: scale(0.95); }
.book-cover {
    width: 100%; aspect-ratio: 2/3;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08), 0 2px 5px rgba(0,0,0,0.02); /* 柔和阴影 */
    display: flex; align-items: center; justify-content: center;
    color: #ddd; font-size: 28px; position: relative; overflow: hidden;
    border: 1px solid rgba(0,0,0,0.02);
}
.book-cover::after {
    content:''; position:absolute; top:0; right:0; bottom:0; left:0;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(0,0,0,0.02) 100%);
    pointer-events: none;
}
.book-cover.add {
    border: 2px dashed #d0d0d0; background: transparent; box-shadow: none; color: #ccc;
}
.book-cover.add::after { display:none; }
.book-title {
    font-size: 13px; text-align: center; color: #444; font-weight: 600;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4;
}
.book-del-btn {
    position: absolute; top: -8px; right: -8px;
    background: #ff3b30; color: white; border-radius: 50%;
    width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
    font-size: 12px; z-index: 10;
    box-shadow: 0 4px 10px rgba(255,59,48,0.3);
}

.res-chat-header {
    padding: 18px 25px; display: flex; justify-content: space-between; align-items: center;
    font-weight: 700; color: #333; font-size: 17px;
    border-bottom: 1px solid rgba(0,0,0,0.03);
}
.res-chat-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.res-chat-input-area {
    padding: 12px 15px;
    background: transparent;
    display: flex; gap: 8px;
    padding-bottom: calc(15px + env(safe-area-inset-bottom));
    align-items: center;
}
.res-chat-input-area .circle-btn { width: 32px; height: 32px; flex-shrink: 0; }
.res-chat-input-area input {
    background: #F2F4F6;
    border: 1px solid transparent;
    border-radius: 24px; padding: 12px 18px; flex: 1;
    box-shadow: none;
    transition: all 0.2s; font-size: 15px;
}
.res-chat-input-area input:focus { background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-color: rgba(0,0,0,0.1); }

.res-msg {
    padding: 12px 16px; border-radius: 18px; max-width: 85%;
    font-size: 15px; line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    animation: msg-pop-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: none;
}
.res-msg.ai {
    background: #F2F4F6; align-self: flex-start;
    border-bottom-left-radius: 4px; color: #333;
}
.res-msg.me {
    background: #000000; align-self: flex-end;
    border-bottom-right-radius: 4px; color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.history-drawer {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
    background: #fff;
    border-radius: 32px 32px 0 0;
    box-shadow: 0 -10px 60px rgba(0,0,0,0.15);
    transform: translateY(100%); transition: transform 0.3s;
    z-index: 320; display: flex; flex-direction: column; padding: 25px;
}
.history-drawer.active { transform: translateY(0); }


/* --- 07_xhs.css --- */
/* Little Green Book */
.xhs-feed-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
.xhs-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; display: flex; flex-direction: column; }
.xhs-img-box { width: 100%; aspect-ratio: 3/4; overflow: hidden; position: relative; background: #f0f0f0; } 
.xhs-img-box img { width: 100%; height: 100%; object-fit: cover; }
.xhs-info { padding: 8px; }
.xhs-title { font-size: calc(13px * var(--app-font-scale)); font-weight: 600; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
.xhs-user-row { display: flex; justify-content: space-between; align-items: center; font-size: calc(10px * var(--app-font-scale)); color: #999; }
.xhs-avatar { width: 16px; height: 16px; border-radius: 50%; object-fit: cover; margin-right: 4px; }
.xhs-like-box { display: flex; align-items: center; gap: 2px; }
.xhs-like-box svg { width: 12px; height: 12px; }
.xhs-like-box.liked { color: var(--danger); }
.xhs-like-box.liked svg { fill: var(--danger); }

/* Post Detail */
.post-detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; overflow-y: auto; }
.post-detail-view.active { transform: translateX(0); }
.post-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
.post-main-img { width: 100%; max-height: 500px; object-fit: contain; background: #000; }
.post-content-box { padding: 15px; }
.post-title-lg { font-size: calc(18px * var(--app-font-scale)); font-weight: 600; margin-bottom: 10px; }
.post-desc { font-size: calc(15px * var(--app-font-scale)); line-height: 1.6; color: #333; white-space: pre-wrap; margin-bottom: 15px; }
.post-date { font-size: calc(12px * var(--app-font-scale)); color: #ccc; margin-bottom: 20px; }
.comment-area { border-top: 0.5px solid #eee; padding: 15px; }
.comment-item { display: flex; gap: 10px; margin-bottom: 15px; }
.c-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
.c-content { flex: 1; font-size: calc(14px * var(--app-font-scale)); }
.c-name { color: #666; font-size: calc(12px * var(--app-font-scale)); margin-bottom: 2px; }
.c-text { color: #333; line-height: 1.4; }
.c-sub { margin-top: 4px; padding-left: 8px; border-left: 2px solid #eee; font-size: calc(13px * var(--app-font-scale)); color: #666; }


/* --- 08_schedule.css --- */
/* Timeline UI (Modern) */
.timeline-container { position: relative; }
/* Dotted line */
.timeline-container::before { 
    content:''; position:absolute; top:20px; bottom:20px; left:9px; width:0; 
    border-left: 2px dashed rgba(0,0,0,0.1); z-index:0; 
}
.timeline-item { display: flex; gap: 20px; margin-bottom: 25px; position: relative; z-index:1; }
.timeline-item:last-child { margin-bottom: 0; }

.tl-time {
    display: none; /* Hide old time */
}

.tl-dot { 
    width: 20px; height: 20px; border-radius: 50%; 
    background: white; border: 4px solid #eee; 
    flex-shrink: 0;
    transition: all 0.3s;
}
.timeline-item.done .tl-dot { border-color: var(--accent); background: var(--accent); }
.timeline-item.current .tl-dot { 
    border-color: var(--accent); background: white; 
    border-width: 6px;
    box-shadow: 0 0 0 4px rgba(255,255,255,0.8), 0 4px 12px rgba(0,0,0,0.1);
}

.tl-card { 
    flex: 1; 
    background: white; 
    border-radius: 16px; padding: 15px; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.03); 
    border: 1px solid rgba(0,0,0,0.02);
}

.tl-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px; display:flex; justify-content:space-between; }
.tl-time-badge { font-size:12px; background:#f5f5f5; padding:2px 8px; border-radius:8px; color:#666; font-family:'SF Pro Display'; }
.tl-desc { font-size: 13px; color: #666; line-height: 1.5; }

.tl-impact { 
    margin-top: 10px; padding: 10px; 
    background: #fdfdfd; 
    border-radius: 8px;
    border: 1px dashed #eee;
    font-size: 12px; 
    color: #888; 
    display:flex; align-items:center; gap:6px; 
}

.char-sel-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.char-sel-item { 
    background: white; border-radius: 20px; padding: 20px; 
    display: flex; flex-direction: column; align-items: center; gap: 10px; 
    cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
    transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.02);
}
.char-sel-item:active { transform: scale(0.96); }
.char-sel-av { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
.char-sel-name { font-size: 14px; font-weight: 600; color: #333; }


/* --- 09_misc.css --- */
.group-members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(3.75rem, 1fr));
    gap: 1.25rem;
    padding: 1rem;
}
.member-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    text-align: center;
}
.member-item img {
    width: 3.1rem;
    height: 3.1rem;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
}
.member-item span {
    font-size: calc(0.75rem * var(--app-font-scale));
    color: var(--text-sub);
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.member-item.add-btn img {
    border-style: dashed;
}

/* Owner Profile Card */
.owner-card {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 1.8rem;
    padding: 1.5rem;
    margin: 1.25rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.05);
    text-align: left;
    color: var(--text-main);
}
.owner-header { display:flex; align-items:center; gap:1.25rem; margin-bottom:1.5rem; }
.owner-av { width:5rem; height:5rem; border-radius:50%; object-fit:cover; border:3px solid rgba(255,255,255,0.8); box-shadow:0 5px 15px rgba(0,0,0,0.1); }
.owner-info-grid { display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
.owner-field { background:rgba(255,255,255,0.5); padding:0.75rem; border-radius:1rem; border:1px solid rgba(255,255,255,0.4); }
.owner-label { font-size: calc(0.7rem * var(--app-font-scale)); color:var(--text-sub); margin-bottom:0.25rem; text-transform:uppercase; letter-spacing:1px; }
.owner-val { font-size: calc(0.9rem * var(--app-font-scale)); font-weight:600; color:var(--text-main); background:transparent; border:none; width:100%; outline:none; }
.owner-bio { grid-column: span 2; min-height:5rem; }
.owner-bio textarea { width:100%; height:100%; background:transparent; border:none; font-size: calc(0.9rem * var(--app-font-scale)); color:var(--text-main); line-height:1.6; resize:none; }

/* Status Modal (Old) */
.status-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 80%; max-width: 20rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 1.25rem; padding: 1.25rem; z-index: 500; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
.status-modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
.status-row { display: flex; align-items: center; margin-bottom: 1rem; gap: 0.6rem; }
.status-icon { width: 1.5rem; text-align: center; font-size: calc(1.1rem * var(--app-font-scale)); }
.status-content { flex: 1; font-size: calc(0.9rem * var(--app-font-scale)); color: var(--text-main); font-weight: 500; border-bottom: 1px dashed var(--border); padding-bottom: 0.1rem;}

.diary-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    margin: 1rem 0;
    padding: 1.25rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    position: relative;
    transition: transform 0.2s;
}
.diary-card:active {
    transform: scale(0.98);
    background: rgba(0,0,0,0.02);
}
.diary-content {
    font-size: calc(0.8rem * var(--app-font-scale));
    line-height: 1.6;
    margin-bottom: 0.6rem;
    white-space: pre-wrap;
}
.diary-date {
    font-size: calc(0.75rem * var(--app-font-scale));
    color: var(--text-sub);
    text-align: right;
}
.diary-delete-btn {
    position: absolute;
    top: 0.6rem;
    right: 0.6rem;
    width: 1.8rem;
    height: 1.8rem;
    border-radius: 50%;
    background: rgba(255,59,48,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    cursor: pointer;
}
.diary-card:hover .diary-delete-btn,
.diary-card:active .diary-delete-btn {
    opacity: 1;
}
.wallet-card { background: linear-gradient(135deg, #26c281, #1e9e69); color: white; padding: 1.25rem; border-radius: 1rem; margin: 1rem; box-shadow: 0 4px 15px rgba(38, 194, 129, 0.3); display:flex; flex-direction:column; gap:0.3rem; }

/* 角色状态查看弹窗 - 纯CSS图标版 */
#char-status-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 800; opacity: 0; pointer-events: none; transition: opacity 0.3s; will-change: opacity; transform: translateZ(0); }
#char-status-modal.active { opacity: 1; pointer-events: auto; }
.status-card { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 90%; max-width: 22.5rem; background: var(--card-bg); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); display:flex; flex-direction:column; gap:1rem; will-change: transform; backface-visibility: hidden; }
#char-status-modal.active .status-card { transform: translate(-50%, -50%) scale(1); }
.status-header { display:flex; flex-direction:column; align-items:center; border-bottom:1px solid var(--border); padding-bottom:1rem; margin-bottom:0.3rem; }
.status-info-row { display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0; }
.status-icon-box { width: 2rem; height: 2rem; border-radius: 0.5rem; background: var(--app-bg); display: flex; justify-content: center; align-items: center; color: var(--accent); flex-shrink: 0; }
.status-label { font-size: calc(0.75rem * var(--app-font-scale)); color: var(--text-sub); margin-bottom: 0.1rem; }
.status-value { font-size: calc(0.9rem * var(--app-font-scale)); color: var(--text-main); font-weight: 500; }

/* Crop Modal */
#crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9000; display: none; flex-direction: column; }
#crop-modal.active { display: flex; }
#crop-area { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; }
#crop-img { max-width: none; position: absolute; transform-origin: center; cursor: grab; }
.crop-mask { position: absolute; width: 18.75rem; height: 18.75rem; border: 2px solid white; box-shadow: 0 0 0 9999px rgba(0,0,0,0.8); pointer-events: none; }
.crop-controls { height: 7.5rem; background: #111; display: flex; flex-direction: column; justify-content: center; padding: 0 1.25rem; gap: 1rem; }
.crop-btns { display: flex; justify-content: space-between; }
.crop-btn { color: white; background: none; border: none; font-size: calc(1rem * var(--app-font-scale)); padding: 0.6rem; }

/* Countdown Edit Modal */
#countdown-edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); z-index: 850; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
#countdown-edit-modal.active { opacity: 1; pointer-events: auto; }
.cd-edit-card {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 20rem; background: var(--card-bg);
    border-radius: 1.25rem; padding: 1.25rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex; flex-direction: column; gap: 1rem;
}
#countdown-edit-modal.active .cd-edit-card { transform: translate(-50%, -50%) scale(1); }
.cd-list-edit-container { max-height: 18rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.6rem; }
.cd-edit-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem; background: #f5f5f5; border-radius: 0.6rem; }
.cd-edit-item input { background: white; border: 1px solid #ddd; border-radius: 0.25rem; font-size: calc(0.9rem * var(--app-font-scale)); color: var(--text-main); padding: 0.25rem; }
.cd-edit-item input:focus { border-color: var(--accent); background: #fff; }
.cd-edit-del { color: var(--danger); cursor: pointer; padding: 0.3rem; }

/* Image Lightbox */
#image-lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}
#image-lightbox.show { display: flex; }
#image-lightbox img {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
}

/* --- New Diary Styles (Glassmorphism) --- */
.diary-entry-card {
    background: rgba(255, 255, 255, 0.65);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 1.25rem;
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    box-shadow: 0 8px 30px rgba(0,0,0,0.03);
    transition: transform 0.2s;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.diary-entry-card:active { transform: scale(0.98); }

.d-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; }
.d-date { font-weight: bold; font-size: 1rem; color: var(--text-main); font-family: 'SF Pro Display'; }
.d-tag { font-size: 0.6rem; padding: 0.1rem 0.5rem; border-radius: 0.6rem; font-weight: bold; }
.d-tag.me { background: rgba(255, 213, 213, 0.4); color: #c06c6c; border: 1px solid rgba(255, 213, 213, 0.6); }
.d-tag.ai { background: rgba(200, 220, 255, 0.4); color: #6a8caf; border: 1px solid rgba(200, 220, 255, 0.6); }

.d-card-content {
    font-size: 0.9rem; color: var(--text-main); opacity: 0.9; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.d-card-footer {
    border-top: 1px dashed rgba(0,0,0,0.05); padding-top: 0.5rem; margin-top: 0.3rem;
    display: flex; justify-content: space-between; color: #999; font-size: 0.75rem;
}

/* Diary Detail Paper Effect */
.d-detail-paper {
    background: rgba(255, 255, 255, 0.3); /* Lower opacity to show blur better */
    backdrop-filter: blur(50px) saturate(150%); /* Stronger blur & saturation */
    -webkit-backdrop-filter: blur(50px) saturate(150%);
    border-radius: 1.5rem;
    padding: 1.8rem;
    margin: 1.25rem 1rem;
    /* Multi-layered shadow for depth */
    box-shadow:
        0 20px 40px rgba(0,0,0,0.08),
        0 5px 15px rgba(0,0,0,0.05),
        inset 0 1px 0 rgba(255,255,255,0.6), /* Top highlight */
        inset 0 -1px 0 rgba(255,255,255,0.2); /* Bottom lowlight */
    border: 1px solid rgba(255, 255, 255, 0.5); /* Distinct border */
}
.d-detail-date { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.25rem; border-bottom: 2px solid rgba(255,255,255,0.5); padding-bottom: 0.6rem; display: flex; align-items: baseline; }
.d-detail-body { font-size: 1rem; line-height: 1.8; white-space: pre-wrap; color: var(--text-main); }

/* Comment Section */
.comment-section { padding: 0 1.25rem; }
.d-comment-item { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
.d-comment-av { width: 2.25rem; height: 2.25rem; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.d-comment-box {
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    padding: 0.75rem 1rem; border-radius: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1;
    border: 1px solid rgba(255,255,255,0.4);
}
.d-comment-box.me { background: linear-gradient(135deg, rgba(255, 240, 245, 0.8) 0%, rgba(255,255,255,0.8) 100%); border: 1px solid rgba(255, 213, 213, 0.3); }
.d-comment-name { font-size: 0.75rem; color: #999; margin-bottom: 0.25rem; }
.d-comment-text { font-size: 0.9rem; color: var(--text-main); line-height: 1.4; }

/* --- New Diary Home Styles --- */
.diary-header-hero {
    width: 100%; height: 11.25rem; /* Reduced height */
    background-size: cover; background-position: center;
    position: relative;
    border-radius: 0 0 1.8rem 1.8rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-bottom: 0; /* No Overlap */
    z-index: 1;
}
.diary-header-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.4));
    border-radius: 0 0 1.8rem 1.8rem;
    display: flex; flex-direction: column; justify-content: flex-end; padding: 1.5rem;
    color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.diary-header-title { font-size: 2rem; font-weight: 800; font-family: 'SF Pro Display', serif; letter-spacing: 2px; }
.diary-header-sub { font-size: 0.9rem; opacity: 0.9; margin-top: 0.3rem; font-weight: 300; letter-spacing: 1px; }

.diary-cards-container {
    padding: 0 1.25rem;
    position: relative; z-index: 2;
    display: flex; flex-direction: column; gap: 1rem;
    padding-bottom: 6rem;
}
.diary-book-card {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 1.5rem;
    padding: 1.25rem;
    display: flex; align-items: center; gap: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.6);
    transition: transform 0.2s;
    cursor: pointer;
}
.diary-book-card:active { transform: scale(0.98); }
.d-book-av { width: 3.5rem; height: 3.5rem; border-radius: 1.1rem; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.d-book-info { flex: 1; }
.d-book-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); margin-bottom: 0.25rem; }
.d-book-meta { font-size: 0.75rem; color: #999; }
.d-book-arrow { color: #ccc; font-size: 1.25rem; font-weight: 300; }

/* Override Line Background to be separate from Desktop */
#app-line .tab-content { 
    background-image: none !important; 
    background: var(--app-bg) !important;
}

/* Diary Meta Input */
.diary-meta-input {
    border: 1px solid rgba(255,255,255,0.6);
    border-radius: 12px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-family: inherit;
    font-size: 14px;
    color: var(--text-main);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.diary-meta-input:focus {
    background: rgba(255,255,255,0.8);
    border-color: var(--accent);
}

/* Dynamic Weather Backgrounds */
.diary-weather-bg {
    position: absolute; top:0; left:0; width:100%; height:100%;
    z-index: -1;
    transition: background 0.5s;
    overflow: hidden;
}

/* Weather Themes */
.w-sunny { background: linear-gradient(135deg, #fff5f7 0%, #ffeef2 100%); /* Very Pale Pink */ }
.w-cloudy { background: linear-gradient(135deg, #cfd9df 0%, #e2ebf0 100%); }
.w-rainy { background: linear-gradient(180deg, #e3ecf5 0%, #b8d2e8 100%); /* Pale Blue */ }
.w-snowy { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* Pale Frost */ }
.w-yin { background: linear-gradient(135deg, #e6e9f0 0%, #eef1f5 100%); /* Very Pale Gray */ }

/* Animations */
@keyframes snow {
    0% { transform: translateY(0) translateX(0); opacity: 0.8; }
    100% { transform: translateY(100vh) translateX(20px); opacity: 0; }
}
.snow-flake {
    position: absolute; width: 6px; height: 6px; 
    background: radial-gradient(circle, #fff 40%, rgba(255,255,255,0.5) 100%); /* Softer but bigger */
    box-shadow: 0 0 3px rgba(0,0,0,0.1); /* Slight shadow to see against white */
    border-radius: 50%;
    animation: snow 5s linear infinite; top:-10px;
}

@keyframes rain {
    0% { transform: translateY(0); opacity: 0.8; }
    100% { transform: translateY(100vh); opacity: 0.2; }
}
.rain-drop {
    position: absolute; width: 2px; height: 25px; /* Longer */
    background: linear-gradient(to bottom, rgba(130, 160, 200, 0), rgba(130, 160, 200, 0.8)); /* Blue-ish tint */
    animation: rain 0.8s linear infinite; top:-30px; /* Faster */
}

@keyframes sakura {
    0% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
.sakura-petal {
    position: absolute; width: 10px; height: 10px; background: #ffc0cb; 
    border-radius: 10px 0 10px 0; /* Leaf shape */
    animation: sakura 8s linear infinite; top:-20px;
}


/* --- 99_redesign.css --- */
/* ==========================================================================
   MODERN MINIMALIST UI REDESIGN (Chat Room Overrides)
   ========================================================================== */

/* 1. Background & Layout */
#sub-chat-room {
    background-color: #F8F9FA !important;
    background-image: none !important;
}

/* Hide old decoration/background layers */
#sub-chat-room::before { display: none !important; }
#sub-chat-room #chat-bg-image, 
#sub-chat-room #chat-bg-layer { display: block !important; }

/* 2. Main Chat Card Container - FULL SCREEN RESET */
.chat-unified-glass {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    
    /* Reset positioning to fill screen */
    top: 0 !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    padding-top: max(var(--safe-top), 20px) !important;
}

/* 3. Navigation Bar (Clean & Transparent) */
#sub-chat-room .nav-bar {
    background: #ffffff !important;
    border-bottom: 1px solid #f2f2f2 !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
}
#sub-chat-room .nav-title {
    color: #111 !important;
    font-weight: 700 !important;
    font-size: 17px !important;
    letter-spacing: -0.3px !important;
    text-shadow: none !important;
}
#sub-chat-room .nav-btn {
    color: #111 !important;
    opacity: 0.8;
}

/* 4. Messages (Minimalist Bubbles) */
.bubble {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;
    border: none !important;
}

/* Me: Black Pill */
.msg-block.me .bubble {
    background: #1a1a1a !important; /* Full Black */
    color: #ffffff !important;
    border-radius: 18px 18px 4px 18px !important;
}

/* AI: Light Gray Pill */
.msg-block.ai .bubble {
    background: #F2F4F6 !important; /* Very Light Gray */
    color: #1a1a1a !important;
    border-radius: 18px 18px 18px 4px !important;
}

/* 5. Input Area (Floating/Clean) */
.chat-input-area {
    background: #ffffff !important;
    border-top: 1px solid #f2f2f2 !important;
    padding: 15px 20px !important;
    gap: 12px !important;
    box-shadow: none !important;
}

.chat-input {
    background: #F8F9FA !important;
    border: 1px solid transparent !important;
    border-radius: 20px !important;
    color: #1a1a1a !important;
    font-size: 15px !important;
    padding: 10px 16px !important;
    height: 44px !important;
    box-shadow: none !important;
    transition: all 0.2s ease;
}
.chat-input:focus {
    background: #fff !important;
    border-color: #1a1a1a !important;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.05) !important;
}

/* Buttons */
/* Send Button: Black Circle (Minimalist) */
.chat-input-area .circle-btn.btn-fill {
    background: #1a1a1a !important;
    color: #fff !important;
    width: 40px !important;
    height: 40px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    border-radius: 50% !important; /* Keeping circle for icon consistency */
}

/* Action Icons */
.chat-input-area .circle-btn.btn-ghost {
    color: #999 !important;
}
.chat-input-area .circle-btn.btn-ghost:active {
    background: #f0f0f0 !important;
}

/* 6. Extra UI Elements */
/* Plus Menu - Match Card Style */
.plus-menu-drawer {
    background: #ffffff !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    border-top: none !important;
}
.plus-icon-box {
    background: #F8F9FA !important;
    color: #333 !important;
    border-radius: 18px !important;
    border: 1px solid rgba(0,0,0,0.03) !important;
}

/* Emoticon Panel */
#emoticon-panel {
    background: #ffffff !important;
    border-radius: 24px 24px 0 0 !important;
}

/* Quote Preview */
.quote-preview-bar {
    background: #f9f9f9 !important;
    border-top: 1px solid #eee !important;
    width: auto !important;
    left: 20px !important;
    right: 20px !important;
    border-radius: 12px 12px 0 0 !important;
    margin-bottom: 0 !important;
}

/* Adjust scroll content padding */
#chat-messages {
    padding: 20px !important;
}


/* Fix Status Bar Background */
.chat-unified-glass::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: max(var(--safe-top), 20px);
    background: #ffffff;
    z-index: 10;
    display: block !important;
}

/* --- Music Together Styles --- */
.mt-visual-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    min-height: 300px;
}
.mt-avatars {
    display: flex;
    align-items: center;
    gap: 60px; /* 头像间距 */
    position: relative;
    margin-bottom: 30px;
}
.mt-avatar-container {
    width: 70px;
    height: 70px;
    position: relative;
    z-index: 2;
}
.mt-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    object-fit: cover;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
/* 连体耳机线效果 */
.mt-cable {
    position: absolute;
    top: 35px; /* 头像中心高度 */
    left: 35px; /* 左头像中心 */
    right: 35px; /* 右头像中心 */
    height: 50px; /* 下垂深度 */
    border-bottom: 2px solid rgba(255,255,255,0.6);
    border-left: 2px solid rgba(255,255,255,0.6);
    border-right: 2px solid rgba(255,255,255,0.6);
    border-radius: 0 0 40px 40px; /* U型圆角 */
    z-index: 1;
    pointer-events: none;
}
.mt-headphone {
    position: absolute;
    top: 25px;
    width: 12px;
    height: 24px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.mt-headphone.left { right: -8px; }
.mt-headphone.right { left: -8px; }

.mt-cover-container {
    width: 220px;
    height: 220px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    margin-top: 10px;
    position: relative;
}
.mt-cover { width: 100%; height: 100%; object-fit: cover; transition: transform 20s linear; }
.mt-cover.playing { animation: rotate 20s linear infinite; border-radius: 50%; } /* 播放时变圆旋转 */

.mt-lyrics-area {
    height: 100px;
    overflow: hidden;
    mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
    -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
    text-align: center;
    margin-bottom: 10px;
    position: relative;
}
.mt-lyrics-scroll {
    transition: transform 0.3s ease-out;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 40px; /* 初始偏移 */
}
.mt-lyric-line {
    padding: 6px 10px;
    color: rgba(255,255,255,0.4);
    font-size: 14px;
    transition: all 0.3s;
    min-height: 30px;
}
.mt-lyric-line.active {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
    transform: scale(1.05);
}

.mt-controls-area {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 30px 30px 0 0;
    padding: 25px 25px;
    padding-bottom: max(25px, env(safe-area-inset-bottom));
    border-top: 1px solid rgba(255,255,255,0.1);
}
.mt-info { margin-bottom: 20px; }
.mt-song-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mt-song-artist { font-size: 14px; color: rgba(255,255,255,0.6); }

.mt-progress { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; font-size: 12px; color: rgba(255,255,255,0.5); font-family: 'SF Pro Display'; }
#mt-prog-bar { flex: 1; accent-color: white; height: 4px; border-radius: 2px; }

.mt-buttons { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; }
.mt-btn-main {
    width: 64px; height: 64px; border-radius: 50%;
    background: white; color: black; border: none;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 5px 20px rgba(255,255,255,0.2);
    transition: transform 0.1s;
}
.mt-btn-main:active { transform: scale(0.95); }
.mt-btn-sub { background: transparent; border: none; color: white; opacity: 0.7; transition: opacity 0.2s; }
.mt-btn-sub:active { opacity: 1; }

.mt-list-item {
    display: flex; align-items: center; padding: 10px; border-radius: 10px; margin-bottom: 5px; cursor: pointer;
}
.mt-list-item:active { background: rgba(255,255,255,0.1); }
.mt-list-item.active { background: rgba(255,255,255,0.15); }
.mt-list-item.active .mt-list-title { color: var(--accent); }

</style>
<style id="global-font-style"></style>
<!-- CSS_PLACEHOLDER -->
<style id="chat-custom-style"></style>
</head>
<body>

<!-- --- 01_modals.html --- -->
<div id="image-lightbox" onclick="Chat.hideImg()"><img id="lightbox-img" src=""></div>
<div id="text-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)" onclick="this.style.display='none'">
    <div style="background:rgba(255,255,255,0.95);padding:25px;border-radius:20px;width:80%;max-width:320px;max-height:60%;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,0.2)" onclick="event.stopPropagation()">
        <div id="text-modal-content" style="flex:1;overflow-y:auto;white-space:pre-wrap;font-size: calc(16px * var(--app-font-scale));line-height:1.6;color:#333;margin-bottom:20px"></div>
        <button class="btn-main" onclick="$('text-modal').style.display='none'" style="margin:0;background:var(--accent)">关闭</button>
    </div>
</div>
<div id="ctx-overlay" class="ctx-overlay" onclick="ContextMenu.hide()"><div id="ctx-menu" class="ctx-menu"><div class="ctx-item" onclick="ContextMenu.edit()">编辑</div><div class="ctx-item" onclick="ContextMenu.quote()">引用</div><div class="ctx-item" onclick="ContextMenu.multiSelect()">多选</div><div class="ctx-item" onclick="ContextMenu.recall()">撤回 (AI可见)</div><div class="ctx-item danger" onclick="ContextMenu.del()">删除 (无痕)</div></div></div>

<div id="global-toast"></div>

<!-- Crop Modal -->
<div id="crop-modal">
    <div id="crop-area" style="flex:1;background:#000;display:flex;justify-content:center;align-items:center;overflow:hidden;width:100%;height:100%">
        <img id="crop-img" style="max-width:100%;max-height:100%;display:block;">
    </div>
    <div class="crop-controls" style="height:60px;background:#000;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
        <div class="crop-btns" style="width:100%;padding:0 20px;">
            <button class="crop-btn" onclick="Crop.cancel()">取消</button>
            <button class="crop-btn" style="color:#26c281;font-weight:bold" onclick="Crop.done()">使用</button>
        </div>
    </div>
</div>
<input type="file" id="global-file-crop" hidden accept="image/*" onchange="Crop.loadFile(this)">

<div id="char-status-modal" onclick="CharStatus.hide()">
    <div class="status-card" onclick="event.stopPropagation()">
        <div class="status-header">
            <div style="position:absolute;right:20px;top:20px;color:var(--accent);cursor:pointer" onclick="CharStatus.refresh()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:20px;height:20px"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </div>
            <img id="char-status-avatar" src="" class="avatar-circle" style="width:64px;height:64px;margin-bottom:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
            <h3 style="margin:0;font-size:18px" id="char-status-title">状态</h3>
        </div>
        <div class="status-info-row">
            <div class="status-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
            <div><div class="status-label">地点</div><div class="status-value" id="disp-loc">--</div></div>
        </div>
        <div class="status-info-row">
            <div class="status-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.38 3.4a2 2 0 0 0-2-2h-12.76a2 2 0 0 0-2 2l-.38 2.6a2 2 0 0 0 1.98 2.2h13.52a2 2 0 0 0 1.98-2.2z"></path><path d="M16 8v11a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-11"></path></svg></div>
            <div><div class="status-label">衣着</div><div class="status-value" id="disp-cloth">--</div></div>
        </div>
        <div class="status-info-row">
            <div class="status-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>
            <div><div class="status-label">姿势</div><div class="status-value" id="disp-pose">--</div></div>
        </div>
        <div class="status-info-row">
            <div class="status-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
            <div><div class="status-label">想法</div><div class="status-value" id="disp-mind">--</div></div>
        </div>
        <div class="status-info-row">
            <div class="status-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></div>
            <div><div class="status-label">心情</div><div class="status-value" id="disp-mood">--</div></div>
        </div>
    </div>
</div>

<div id="countdown-edit-modal" onclick="Countdown.closeEdit()">
    <div class="cd-edit-card" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 10px 0;text-align:center">倒计时管理</h3>
        <div class="cd-list-edit-container" id="cd-edit-list-container">
            <!-- Dynamic Content -->
        </div>
        <button class="btn-main" onclick="Countdown.addNewItem()" style="background:#eee;color:#333;margin:0">+ 添加新事件</button>
        <button class="btn-main" onclick="Countdown.save()" style="background:var(--accent);margin:0">保存更改</button>
    </div>
</div>

<div id="emoticon-import-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);backdrop-filter:blur(5px);z-index:950;display:none;align-items:center;justify-content:center" onclick="this.style.display='none'">
    <div class="status-card" style="position:relative;transform:none;top:auto;left:auto;width:90%;max-width:320px" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 15px 0;text-align:center">导入表情包链接</h3>
        <textarea id="emoticon-import-text" placeholder="支持格式：&#10;1. 名字 链接 (每行一个)&#10;2. JSON数组" style="width:100%;height:200px;border:1px solid #ddd;border-radius:8px;padding:10px;font-size: calc(14px * var(--app-font-scale));background:#f9f9f9;resize:none"></textarea>
        <div style="display:flex;gap:10px;margin-top:15px">
            <button class="btn-main" onclick="$('emoticon-import-modal').style.display='none'" style="background:#eee;color:#333;margin:0">取消</button>
            <button class="btn-main" onclick="PlusMenu.doImpUrl()" style="background:var(--accent);margin:0">导入</button>
        </div>
    </div>
</div>

<div id="narrator-sel-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);backdrop-filter:blur(5px);z-index:999;display:none;align-items:center;justify-content:center" onclick="this.style.display='none'">
    <div class="status-card" style="position:relative;transform:none;top:auto;left:auto;width:80%;max-width:300px;display:flex;flex-direction:column;gap:15px" onclick="event.stopPropagation()">
        <h3 style="margin:0;text-align:center">选择旁白视角</h3>
        <button id="btn-narrator-1" class="btn-main" onclick="Chat.setNarrator('1')" style="background:#eee;color:#333;margin:0">第一人称 (我...)</button>
        <button id="btn-narrator-3" class="btn-main" onclick="Chat.setNarrator('3')" style="background:#eee;color:#333;margin:0">第三人称 (他/她...)</button>
        <button id="btn-narrator-off" class="btn-main" onclick="Chat.setNarrator('off')" style="background:#eee;color:#333;margin:0">关闭旁白</button>
        <div style="border-top:1px solid #eee;margin:5px 0"></div>
        <button class="btn-main" onclick="Chat.setNarrator('off');Toast.show('已重置旁白状态')" style="background:white;color:#ff3b30;border:1px solid #ff3b30;margin:0">一键重置</button>
    </div>
</div>

<div id="transfer-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);backdrop-filter:blur(5px);z-index:960;display:none;align-items:flex-end;justify-content:center;padding-bottom:env(safe-area-inset-bottom);transition:opacity 0.3s" onclick="Transfer.close()">
    <div class="plus-menu-drawer" style="position:relative;bottom:0;height:auto;border-radius:20px 20px 0 0;display:flex;flex-direction:column;gap:15px;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1);background:var(--card-bg);backdrop-filter:blur(20px);" onclick="event.stopPropagation()">
        <div style="text-align:center;font-weight:bold;font-size: calc(18px * var(--app-font-scale));margin-bottom:10px">转账</div>
        
        <div style="display:flex;flex-direction:column;gap:5px">
            <label style="font-size: calc(12px * var(--app-font-scale));color:#666;margin-left:5px">金额</label>
            <div style="display:flex;align-items:center;background:rgba(255,255,255,0.5);border-radius:12px;padding:10px 15px">
                <span style="font-size: calc(24px * var(--app-font-scale));font-weight:bold;margin-right:10px">¥</span>
                <input id="tf-amount" type="number" placeholder="0.00" style="font-size: calc(24px * var(--app-font-scale));font-weight:bold;width:100%;background:transparent;border:none;outline:none" oninput="Transfer.validate()">
            </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:5px">
            <label style="font-size: calc(12px * var(--app-font-scale));color:#666;margin-left:5px">备注</label>
            <input id="tf-note" type="text" placeholder="添加备注 (如: 节日快乐)" style="background:rgba(255,255,255,0.5);border-radius:12px;padding:12px 15px;font-size:14px">
        </div>

        <div style="display:flex;flex-direction:column;gap:5px">
            <label style="font-size: calc(12px * var(--app-font-scale));color:#666;margin-left:5px">付款方式</label>
            <div id="tf-source-list" style="max-height:150px;overflow-y:auto;background:rgba(255,255,255,0.5);border-radius:12px;padding:5px">
                <!-- Sources injected here -->
            </div>
        </div>

        <button id="tf-btn-confirm" class="btn-main" onclick="Transfer.confirm()" style="background:var(--accent);margin-top:10px;opacity:0.5;pointer-events:none">确认支付</button>
    </div>
</div>


<!-- --- 02_reading.html --- -->
<div id="reading-shelf">
    <div class="reading-header" style="background:#f8f8f8">
        <button class="nav-btn" onclick="SharedReading.closeShelf()">关闭</button>
        <div class="nav-title">书架</div>
        <div style="width:40px"></div>
    </div>
    <div class="shelf-grid" id="reading-shelf-list">
        <!-- Books injected here -->
        <div class="book-item" onclick="$('reading-import').click()">
            <div class="book-cover add">+</div>
            <span class="book-title">导入书籍</span>
        </div>
    </div>
</div>

<div id="reading-drawer">
    <div class="reading-header">
        <div style="display:flex;gap:15px">
            <button class="nav-btn" onclick="SharedReading.closeBook()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <button class="nav-btn" onclick="SharedReading.toggleSettings()" style="font-size:18px">Aa</button>
        </div>
        <div class="nav-title" id="reading-title" style="font-weight:normal;font-family:serif">书籍</div>
        <button class="nav-btn" onclick="SharedReading.toggleHistory()">记录</button>
    </div>
    
    <div id="reading-settings-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:45;display:none" onclick="SharedReading.toggleSettings()"></div>
    <div id="reading-settings-panel" class="reading-settings-panel">
        <div style="font-size:12px;color:#666;font-weight:bold">字号调节</div>
        <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:14px;color:#666">A</span>
            <input type="range" min="14" max="26" value="18" step="1" oninput="$('reading-text-area').style.fontSize=this.value+'px'" style="flex:1;accent-color:#888">
            <span style="font-size:20px;color:#333">A</span>
        </div>
        
        <div style="font-size:12px;color:#666;font-weight:bold;margin-top:5px">背景色调</div>
        <div class="color-grid">
            <!-- 白天/纯白 -->
            <div class="color-opt" style="background:#ffffff;border:1px solid #eee" onclick="SharedReading.setTheme('#ffffff', '#1a1a1a')"></div>
            <!-- 夜间/铅灰 -->
            <div class="color-opt" style="background:#2c2c2c" onclick="SharedReading.setTheme('#2c2c2c', '#a8aeb5')"></div>
            <!-- 默认/沙丘米色 -->
            <div class="color-opt" style="background:#e9e5d6" onclick="SharedReading.setTheme('#e9e5d6', '#2c2c2c')"></div>
            <!-- 嫩芽白绿 -->
            <div class="color-opt" style="background:#c0d0b0" onclick="SharedReading.setTheme('#c0d0b0', '#2c3e2c')"></div>
            <!-- 橄榄灰绿 -->
            <div class="color-opt" style="background:#8a9b68" onclick="SharedReading.setTheme('#8a9b68', '#f0f0f0')"></div>
            <!-- 薄荷奶绿 -->
            <div class="color-opt" style="background:#d3e8d7" onclick="SharedReading.setTheme('#d3e8d7', '#2c3e2c')"></div>
            <!-- 羊皮纸黄 -->
            <div class="color-opt" style="background:#f0e5c9" onclick="SharedReading.setTheme('#f0e5c9', '#3d2e24')"></div>
            <!-- 琥珀浅金 -->
            <div class="color-opt" style="background:#d4c391" onclick="SharedReading.setTheme('#d4c391', '#3d2e24')"></div>
            <!-- 灰蓝岩 -->
            <div class="color-opt" style="background:#a8b0b9" onclick="SharedReading.setTheme('#a8b0b9', '#1a1a1a')"></div>
            <!-- 陶土浅灰 -->
            <div class="color-opt" style="background:#e0d8d0" onclick="SharedReading.setTheme('#e0d8d0', '#2c2c2c')"></div>
        </div>
    </div>

    <div class="reading-paper" id="reading-text-area">
        <div style="text-align:center;margin-top:50%;transform:translateY(-50%);color:#999;font-family:sans-serif">
            <div style="font-size:40px;margin-bottom:10px">📖</div>
            <div>点击右下角导入 TXT</div>
        </div>
    </div>
    <div class="reading-footer">
        <div class="resonance-btn" onclick="SharedReading.toggleChat()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:18px;height:18px;stroke-width:1.5"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
            心绪
        </div>
        <div style="font-size:12px;color:#888;font-family:'SF Pro Display'" id="reading-progress-disp">0%</div>
        <div style="display:flex;gap:20px;color:#555">
             <button class="nav-btn" onclick="SharedReading.prevPage()" style="font-size:24px;font-weight:300">‹</button>
             <button class="nav-btn" onclick="SharedReading.nextPage()" style="font-size:24px;font-weight:300">›</button>
        </div>
    </div>
    <input type="file" id="reading-import" hidden accept=".txt" onchange="SharedReading.import(this)">
    <div id="resonance-chat-box" class="resonance-chat-box">
        <div class="res-chat-header">
            <span style="display:flex;gap:5px;align-items:center"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;color:#a18cd1"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> 心绪</span>
            <div style="display:flex;gap:15px">
                <button class="circle-btn" onclick="SharedReading.prevPage()" style="width:28px;height:28px;background:rgba(0,0,0,0.05)">‹</button>
                <button class="circle-btn" onclick="SharedReading.nextPage()" style="width:28px;height:28px;background:rgba(0,0,0,0.05)">›</button>
                <span onclick="SharedReading.toggleChat()" style="cursor:pointer;margin-left:5px">✕</span>
            </div>
        </div>
        <div id="res-chat-list" class="res-chat-list"></div>
        <div class="res-chat-input-area">
            <input id="res-chat-input" placeholder="回应TA..." onkeydown="if(event.key==='Enter')SharedReading.sendReply()">
            <button class="circle-btn" style="background:#f0f0f0;color:#666" onclick="SharedReading.sendReply()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:16px"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
            <button class="circle-btn" style="background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);color:white" onclick="SharedReading.triggerReply()"><svg viewBox="0 0 24 24" fill="currentColor" style="width:16px"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path></svg></button>
        </div>
    </div>
    <div id="reading-history" class="history-drawer">
        <div style="font-weight:bold;margin-bottom:15px;display:flex;justify-content:space-between">
            <span>共鸣记录</span>
            <span onclick="SharedReading.toggleHistory()" style="color:#999;cursor:pointer">✕</span>
        </div>
        <div id="reading-history-list" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px"></div>
    </div>
</div>


<!-- --- 03_wrapper_start.html --- -->
<div id="iphone-screen">
    <div id="global-status-bar">
        <div class="gs-left">
            <span id="gs-time">09:41</span>
        </div>
        <div class="gs-right">
            <span id="gs-battery-icon" style="display:flex;align-items:center;gap:2px">
                <span id="gs-battery-level" style="font-size:10px">100%</span>
                <svg viewBox="0 0 24 24" fill="currentColor" class="gs-icon" style="transform:rotate(90deg)"><path d="M16 17H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h9c1.1 0 2 .9 2 2v2h2v4h-2v2c0 1.1-.9 2-2 2z"/></svg>
            </span>
            <svg viewBox="0 0 24 24" fill="currentColor" class="gs-icon"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-1.07 3.97-2.9 5.4z"/></svg>
            <span id="gs-wifi-icon"><svg viewBox="0 0 24 24" fill="currentColor" class="gs-icon"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3a4.237 4.237 0 0 0-6 0zm-4-4l2 2a7.074 7.074 0 0 1 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg></span>
        </div>
    </div>


<!-- --- 04_home.html --- -->
<div id="home-screen">
        <!-- Top Main Block -->
        <div class="main-card">
            <div class="wb-header">
                <div class="wb-avatar-box" onclick="Weather.toggle()">
                    <div id="weather-icon-box" style="width:3.75rem;height:3.75rem;margin:0 auto;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.5);border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,0.1);backdrop-filter:blur(5px);border:2px solid rgba(255,255,255,0.8);">
                        <!-- SVG -->
                    </div>
                    <div id="widget-weekday" style="font-size: calc(12px * var(--app-font-scale));margin-top:5px;color:var(--text-sub)">水曜日</div>
                </div>
                <div class="wb-date-box">
                    <div class="wb-day" id="widget-time">08:08</div>
                    <div class="wb-time" id="widget-date-jp">03/21</div>
                    <div style="font-size: calc(12px * var(--app-font-scale));margin-top:5px;opacity:0.6">✦ 春は怠けやすい ✦</div>
                </div>
            </div>
            
            <div style="font-size: calc(13px * var(--app-font-scale));color:var(--text-main);opacity:0.8;margin-bottom:10px;text-align:center">*.❅·柔らかい 雪片๑ ₊˚</div>
            
            <div class="mid-content-grid">
                <!-- Left: Music & Deco -->
                <div style="display:flex;flex-direction:column;gap:10px;">
                     <div class="music-box">
                         <div class="vinyl-player" onclick="$('ib-music').classList.toggle('playing')">
                             <div class="vinyl-disc" id="ib-music">
                                 <img src="https://source.unsplash.com/random/200x200?anime,girl" style="width:100%;height:100%;object-fit:cover;border-radius:50%">
                             </div>
                         </div>
                         <div class="music-info">クラウド音楽</div>
                     </div>
                     <!-- Partner Widget -->
                     <div class="wb-deco-area" onclick="Widget.check(DB.getMostActiveContact()?.id)">
                         <img id="partner-widget-img" src="https://source.unsplash.com/random/300x200?anime,couple" class="wb-deco-img">
                         <div class="wb-deco-tag">パートナー</div>
                     </div>
                     <!-- LifeOS Widget -->
                     <div class="zm-widget" onclick="App.o('app-lifeos')">
                         <div class="zm-icon" id="ib-lifeos"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:28px;height:28px"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path><circle cx="12" cy="12" r="5"></circle></svg></div>
                         <div class="zm-info">
                             <div class="zm-title">朝暮</div>
                             <div class="zm-sub">Always with you</div>
                         </div>
                     </div>
                </div>
                
                <!-- Right: Apps & Status -->
                <div style="display:flex;flex-direction:column;gap:15px">
                    <div class="wb-apps-grid">
                        <div class="wb-app-item" onclick="App.o('app-line')">
                            <div class="wb-app-icon" id="ib-line"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></div>
                            <span class="wb-app-name">Line</span>
                        </div>
                        <div class="wb-app-item" onclick="App.o('app-lgb')">
                            <div class="wb-app-icon" id="ib-lgb"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="5" ry="5"></rect><circle cx="12" cy="12" r="4"></circle><line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke-width="3"></line></svg></div>
                            <span class="wb-app-name">论坛</span>
                        </div>
                        <div class="wb-app-item" onclick="App.o('app-world')">
                            <div class="wb-app-icon" id="ib-world"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M2 12h20"></path><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></div>
                            <span class="wb-app-name">World</span>
                        </div>
                        <div class="wb-app-item" onclick="App.o('app-settings')">
                            <div class="wb-app-icon" id="ib-settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
                            <span class="wb-app-name">Settings</span>
                        </div>
                    </div>
                    
                    <div class="wb-status-box">
                        <div style="display:flex;justify-content:space-between"><span>バッテリー</span><span>100%</span></div>
                        <div style="display:flex;justify-content:space-between"><span>天気</span><span>晴れ</span></div>
                        <div style="margin-top:auto;font-size: calc(10px * var(--app-font-scale));text-align:center;opacity:0.7">· 𓈒𓏸˚₊ おぼろ夢海◌·˚⊹</div>
                    </div>

                    <!-- Schedule App Icon (Below Status) -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <div class="wb-app-item" onclick="ScheduleApp.open()">
                            <div class="wb-app-icon" id="ib-schedule" style="color: #555;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path></svg></div>
                            <span class="wb-app-name">他的行程</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center;color:var(--text-sub);font-size: calc(12px * var(--app-font-scale));margin-top:auto;letter-spacing:4px;opacity:0.6">˖˚✶ 抹茶 ミントの 星 かき 氷.˚ ₊</div>
        </div>
        
        <!-- Bottom Sub Block -->
        <div class="sub-card">
            <div class="sub-banner" onclick="$('banner-upload').click()">
                 <img id="top-banner-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxIiBoZWlnaHQ9IjEiPjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNmMmYyZjIiLz48L3N2Zz4=">
            </div>
            <input type="file" id="banner-upload" hidden accept="image/*" onchange="Banner.update(this)">
        </div>
        
        <!-- Hidden Inputs -->
        <div style="display:none">
            <input type="file" id="music-cover-upload" hidden accept="image/*" onchange="Utils.b2d(this.files[0], d=>$('music-cover-img').src=d)">
        </div>
    </div>


<!-- --- 05_app_line.html --- -->
<div id="app-line" class="app-window ui-modern" style="padding-top:0">
        <div class="line-tabs">
            <div id="tab-contacts" class="tab-content" style="background:#F8F9FA">
                <div class="nav-bar" style="background:white;border-bottom:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 10px rgba(0,0,0,0.02)">
                    <button class="nav-btn" onclick="App.h()" style="color:#1a1a1a">返回</button>
                    <div class="nav-title" style="color:#1a1a1a">联系人</div>
                    <div style="display:flex;gap:15px;z-index:50">
                        <button class="nav-btn" onclick="Toast.show('群聊功能开发中...')" style="padding:0;color:#1a1a1a"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="pointer-events:none;width:24px;height:24px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
                        <button class="nav-btn" onclick="Contacts.new()" style="padding:0;color:#1a1a1a"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="pointer-events:none;width:24px;height:24px"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                    </div>
                </div>
                <div class="scroll-content" id="contacts-list" style="padding:20px;padding-top:10px"></div>
            </div>
            <div id="tab-chats" class="tab-content active" style="background:#F8F9FA">
                <div class="nav-bar" style="background:white;border-bottom:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 10px rgba(0,0,0,0.02)">
                    <button class="nav-btn" onclick="App.h()" style="color:#1a1a1a">返回</button>
                    <div class="nav-title" style="color:#1a1a1a">聊天</div>
                    <div style="width:40px"></div>
                </div>
                <div class="scroll-content" id="chat-list-container" style="padding:20px;padding-top:10px"></div>
            </div>
            <div id="tab-moments" class="tab-content" style="background:#F8F9FA">
                <div class="nav-bar" style="background:rgba(255,255,255,0.85);backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,0,0,0.05)">
                    <button class="nav-btn" onclick="LineApp.sw(1)" style="color:#1a1a1a">返回</button>
                    <div class="nav-title" style="color:#1a1a1a">动态</div>
                    <button class="nav-btn" onclick="Moments.openAdd()" style="font-size:28px;color:#1a1a1a">+</button>
                </div>
                <div class="scroll-content" id="moments-container" style="padding:0">
                    <div class="moments-ph" style="padding:40px;text-align:center;color:#999"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:40px;height:40px;margin-bottom:10px;display:block;margin:0 auto 10px auto"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>暂无动态</div>
                </div>
            </div>
            <div id="tab-diary" class="tab-content" style="background:#F8F9FA">
                <div class="nav-bar" style="background:white;border-bottom:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 10px rgba(0,0,0,0.02);z-index:2">
                    <button class="nav-btn" onclick="App.h()" style="color:#1a1a1a">返回</button>
                    <div class="nav-title" style="color:#1a1a1a">想念</div>
                    <div style="display:flex;gap:5px;z-index:50">
                        <button class="nav-btn" onclick="Diary.openSettings()" style="color:#1a1a1a">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px;height:24px"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="scroll-content" id="diary-list-container" style="padding:20px;padding-top:10px"></div>
            </div>
            <div id="tab-me" class="tab-content" style="background:#F8F9FA">
                 <div class="nav-bar" style="background:transparent;border:none"><div class="nav-title" style="position:static;transform:none;width:100%;text-align:left;padding-left:20px;font-size:26px;font-weight:800;color:#1a1a1a">机主资料</div></div>
                 <div class="scroll-content" style="padding-top:20px" id="owner-profile-container">
                    <!-- Owner Card Injected via JS -->
                 </div>
            </div>
        </div>
        <div class="bottom-nav" style="background:white;border-top:1px solid rgba(0,0,0,0.05);margin:0;width:100%;border-radius:0;box-shadow:0 -5px 20px rgba(0,0,0,0.02);bottom:0;left:0">
            <div class="nav-tab" onclick="LineApp.sw(0,this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>联系人</div>
            <div class="nav-tab active" onclick="LineApp.sw(1,this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>聊天</div>
            <div class="nav-tab" onclick="LineApp.sw(2,this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>动态</div>
            <div class="nav-tab" onclick="LineApp.sw(3,this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>想念</div>
            <div class="nav-tab" onclick="LineApp.sw(4,this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>我</div>
        </div>
    </div>


<!-- --- 06_chat_room.html --- -->
<div id="sub-chat-room" class="app-window">
    <div id="chat-bg-image"></div>
    <div id="chat-bg-layer"></div>
    
    <div class="chat-unified-glass" id="chat-unified-glass">
        <div class="nav-bar">
            <button class="nav-btn" id="nav-btn-back" onclick="App.b()">列表</button>
            <button class="nav-btn" id="nav-btn-cancel-sel" onclick="MultiSelect.cancel()" style="display:none;color:var(--text-main)">取消</button>
            <div class="nav-title" id="chat-room-title" onclick="CharStatus.show()">Chat</div>
            <div id="chat-nav-buttons" style="display:flex; align-items:center; gap: 10px;">
                <button class="nav-btn" id="nav-btn-group-bg" style="display:none;" onclick="Groups.generateBackground()">背景</button>
                <button class="nav-btn" id="nav-btn-settings" onclick="ChatSettings.o()">设置</button>
                <button class="nav-btn" id="nav-btn-sel-all" onclick="MultiSelect.selectAll()" style="display:none;color:var(--text-main)">全选</button>
            </div>
        </div>
        
        <div class="scroll-content" id="chat-messages" style="padding-bottom:10px;"></div>
        
        <div class="chat-input-area" id="chat-input-bar">
            <div id="quote-preview" class="quote-preview-bar"><div class="quote-text" id="quote-text-content">引用...</div><div onclick="Chat.cancelQ()" style="cursor:pointer">×</div></div>
            <button class="circle-btn btn-ghost" onclick="PlusMenu.t()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:26px;height:26px"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></button>
            <button class="circle-btn btn-ghost" onclick="PlusMenu.rr()" style="margin-right:5px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px;height:24px"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></button>
            <textarea id="chat-input" class="chat-input" rows="1" placeholder="发送消息..." enterkeyhint="send"></textarea>
            <button class="circle-btn btn-fill" onclick="Chat.handleSendBtn()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:16px"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
        </div>
    </div>
    
<div id="drawer-overlay" onclick="PlusMenu.t()"></div>
    
    <div id="plus-menu-drawer" class="plus-menu-drawer">
        <div class="plus-item" onclick="PlusMenu.sendImgFlow()">
            <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
            <span>相册</span>
        </div>
        <div class="plus-item" onclick="PlusMenu.showE()">
            <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></div>
            <span>表情</span>
        </div>
        <div class="plus-item" onclick="PlusMenu.sendVoice()">
            <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div>
            <span>语音</span>
        </div>
        <div class="plus-item" onclick="Chat.startTransfer()">
            <div class="plus-icon-box" style="font-family:'SF Pro Display';font-weight:600">¥</div>
            <span>转账</span>
        </div>
            <div class="plus-item" onclick="Chat.toggleNarrator()">
                <div class="plus-icon-box" id="narrator-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg></div>
                <span>旁白模式 <span id="narrator-indicator" style="font-size: calc(10px * var(--app-font-scale));color:var(--accent);display:none;font-weight:bold">ON</span></span>
            </div>
<div class="plus-item" onclick="SharedReading.open(Chat.cid)">
                <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg></div>
                <span>共读</span>
            </div>
            <div class="plus-item" onclick="Toast.show('功能开发中...')">
                <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></div>
                <span>外卖</span>
            </div>
            <div class="plus-item" onclick="Toast.show('功能开发中...')">
                <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                <span>位置</span>
            </div>
            <div class="plus-item" onclick="MusicTogether.open()">
                <div class="plus-icon-box"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:28px"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></div>
                <span>一起听</span>
            </div>
        </div>
    
    <div id="emoticon-panel">
        <div class="nav-bar" style="margin-top:0;padding-top:10px;flex-shrink:0">
            <button class="nav-btn" onclick="PlusMenu.hideE()">关闭</button>
            <div class="nav-title">我的表情包</div>
            <div style="display:flex;gap:5px">
                <button class="nav-btn" onclick="PlusMenu.impUrl()" style="font-size:12px">URL</button>
                <button class="nav-btn" onclick="PlusMenu.impEmoticonFlow()" style="font-size:12px">相册</button>
            </div>
        </div>
        <div class="emoticon-grid" id="emoticon-grid-content"></div>
    </div>
    
    <input type="file" id="plus-img-local" hidden accept="image/*" onchange="PlusMenu.hImgLocal(this)">
    <input type="file" id="plus-emoticon-input" multiple hidden accept="image/*" onchange="PlusMenu.hEFiles(this)">
    
    <div id="multi-select-bar" style="position:absolute;bottom:0;width:100%;background:var(--app-bg);z-index:90;padding:15px;display:none;justify-content:space-between;border-top:1px solid var(--border);padding-bottom:calc(15px + var(--safe-bottom));">
        <button class="btn-main btn-danger" onclick="MultiSelect.deleteSelected()" style="margin:0;width:auto;padding:10px 30px">删除</button>
        <div id="select-count" style="align-self:center;color:#888;font-size:14px">已选 0</div>
    </div>
</div>


<!-- --- 06_chat_settings.html --- -->
<div id="chat-settings-drawer" style="background:#F8F9FA">
    <style>
        .settings-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .settings-label {
            font-size: 12px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .settings-input {
            background: #F8F9FA;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 12px;
            font-size: 15px;
            transition: all 0.2s;
        }
        .settings-input:focus {
            background: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.1);
        }
        .btn-pill {
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-pill:active { transform: scale(0.96); }
        .btn-black { background: #1a1a1a; color: white; }
        .btn-white { background: white; color: #1a1a1a; border: 1px solid #eee; }
        .btn-danger-soft { background: #fff0f0; color: #ff3b30; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        /* Custom Checkbox */
        input[type="checkbox"] {
            width: 20px; height: 20px;
            accent-color: var(--accent);
        }
    </style>

    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="ChatSettings.c()">取消</button><div class="nav-title" style="color:#1a1a1a">设置</div><button class="nav-btn" onclick="ChatSettings.s()" style="color:var(--accent);font-weight:bold">完成</button></div>
    
    <div class="scroll-content" style="padding: 20px;">
        
        <!-- Avatar Card -->
        <div class="settings-card" style="flex-direction:row;justify-content:space-around;padding:25px 20px">
            <div onclick="$('set-char-avatar').click()" style="display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer">
                <div class="upload-circle" style="width:70px;height:70px;border-radius:50%;box-shadow:0 5px 15px rgba(0,0,0,0.1);border:none"><img id="preview-char-avatar" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <span style="font-size:13px;font-weight:600;color:#333">对方</span>
                <input type="file" id="set-char-avatar" hidden accept="image/*" onchange="ChatSettings.hF(this,'preview-char-avatar')">
            </div>
            <div style="width:1px;height:60px;background:#eee;align-self:center"></div>
            <div onclick="$('set-user-avatar').click()" style="display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer">
                <div class="upload-circle" style="width:70px;height:70px;border-radius:50%;box-shadow:0 5px 15px rgba(0,0,0,0.1);border:none"><img id="preview-user-avatar" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <span style="font-size:13px;font-weight:600;color:#333">我</span>
                <input type="file" id="set-user-avatar" hidden accept="image/*" onchange="ChatSettings.hF(this,'preview-user-avatar')">
            </div>
        </div>

        <!-- Info Card -->
        <div class="settings-card">
            <div>
                <div class="settings-label">NAME</div>
                <input type="text" id="set-char-name" class="settings-input" placeholder="角色名字" style="width:100%">
            </div>
            <div>
                <div class="settings-label">PERSONA</div>
                <textarea id="set-char-persona" class="settings-input" style="width:100%;height:100px;resize:none" placeholder="角色详细设定..."></textarea>
            </div>
            <div>
                <div class="settings-label">USER PERSONA</div>
                <textarea id="set-user-persona" class="settings-input" style="width:100%;height:80px;resize:none" placeholder="我在对方眼里的设定..."></textarea>
            </div>
        </div>

        <!-- Logic Card -->
        <div class="settings-card">
            <div class="toggle-row">
                <span style="font-weight:500">AI 感知时间</span>
                <input type="checkbox" id="set-ai-time-aware" checked>
            </div>
            <div class="toggle-row">
                <span style="font-weight:500">心声自动弹出</span>
                <input type="checkbox" id="set-auto-thought">
            </div>
            <div class="toggle-row">
                <span style="font-weight:500">允许 AI 拉黑我</span>
                <input type="checkbox" id="set-ai-block-allow" onchange="ChatSettings.uAllowAiBlock()">
            </div>
            <div class="toggle-row" style="border-top:1px dashed #eee;padding-top:15px;margin-top:5px">
                <span style="font-weight:500">上下文记忆</span>
                <input type="number" id="set-context-limit" class="settings-input" placeholder="20" style="width:60px;text-align:center;padding:5px">
            </div>
            <div class="toggle-row" style="margin-top:5px;justify-content:center;border-top:1px dashed #eee;padding-top:10px">
                <span style="font-size:12px;color:#999">当前记录: <span id="stat-msg-count" style="color:#333;font-weight:bold">0</span> 条 / 约 <span id="stat-token-count" style="color:#333;font-weight:bold">0</span> tokens</span>
            </div>
        </div>

        <!-- Visuals Card -->
        <div class="settings-card">
             <div class="toggle-row" onclick="$('set-bg').click()">
                <span style="font-weight:500">聊天背景</span>
                <span style="color:#999;font-size:12px">更换 ></span>
                <input type="file" id="set-bg" hidden accept="image/*" onchange="ChatSettings.hF(this,'',true)">
             </div>
             <div>
                <div class="settings-label" style="display:flex;justify-content:space-between"><span>OPACITY</span><span id="opacity-val-disp">100%</span></div>
                <input type="range" id="set-bg-opacity" min="0.1" max="1" step="0.1" style="width:100%;accent-color:var(--text-main)" oninput="ChatSettings.uOp(this.value)">
             </div>
             <button class="btn-pill btn-white" onclick="ChatSettings.openAdvancedEdit()" style="margin-top:10px">高级外观设置 (CSS/气泡)</button>
        </div>

        <!-- World & Memory -->
        <div class="settings-card">
            <div class="settings-label">WORLD BOOK</div>
            <div id="chat-setting-world-select" style="min-height:20px"></div>
        </div>

        <!-- Danger Zone -->
        <div style="margin-top:20px;display:flex;flex-direction:column;gap:10px">
            <button id="btn-block-user" class="btn-pill btn-danger-soft" onclick="ChatSettings.toggleBlock()">拉黑用户</button>
            <button class="btn-pill btn-danger-soft" style="background:#fff;border:1px solid #ff3b30" onclick="Chat.clearHist()">清空聊天记录 (重开)</button>
        </div>

        <div style="height:40px"></div>
    </div>
</div>


<!-- --- 07_contacts.html --- -->
<div id="app-contacts" class="app-window"><div class="nav-bar"><button class="nav-btn" onclick="App.h()">返回</button><div class="nav-title">联系人</div><button class="nav-btn" onclick="Contacts.new()">+</button></div><div class="scroll-content" id="contacts-list"></div></div>


<!-- --- 07_contacts_subs.html --- -->
<div id="sub-group-edit" class="app-window ui-modern" style="z-index:255">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">群聊设置</div><button class="nav-btn" onclick="Groups.save()" style="color:var(--accent);font-weight:bold">保存</button></div>
    <div class="scroll-content" style="padding:20px">
        <div class="card-modern" style="align-items:center;padding:30px">
            <div onclick="$('group-av-in').click()" style="display:inline-block;position:relative;cursor:pointer">
                <div class="upload-circle" style="width:80px;height:80px;margin:0 auto;border:none;box-shadow:0 5px 15px rgba(0,0,0,0.1)"><img id="group-av-preview" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <div style="position:absolute;bottom:0;right:0;background:var(--accent);color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px">📷</div>
            </div>
            <input type="file" id="group-av-in" hidden accept="image/*" onchange="Utils.b2d(this.files[0], d => $('group-av-preview').src = d)">
            <input type="text" id="group-name" class="input-modern" placeholder="群聊名称" style="text-align:center;font-weight:bold;font-size:18px;margin-top:15px;background:transparent">
            <input type="text" id="group-remark" class="input-modern" placeholder="群备注 (仅显示)" style="text-align:center;font-size:12px;color:#999;background:transparent;padding:5px">
        </div>

        <div class="card-modern">
            <div>
                <div class="label-modern" style="display:flex;justify-content:space-between;align-items:center">
                    <span>世界观 / 群公告</span>
                    <button class="btn-pill btn-black" style="padding:4px 10px;font-size:10px;height:24px" onclick="Groups.genWorld()">✨ 智能生成</button>
                </div>
                <textarea id="group-world-view" class="input-modern" placeholder="在此输入世界观背景..." style="height:100px;resize:none"></textarea>
            </div>
            <div style="border-top:1px dashed #eee;padding-top:15px">
                <div class="label-modern" style="display:flex;justify-content:space-between;align-items:center">
                    <span>我的本群人设 & 头像</span>
                    <div onclick="$('group-user-av-in').click()" style="width:30px;height:30px;border-radius:50%;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.1);cursor:pointer">
                        <img id="group-user-av-preview" src="" style="width:100%;height:100%;object-fit:cover">
                    </div>
                    <input type="file" id="group-user-av-in" hidden accept="image/*" onchange="Utils.b2d(this.files[0], d => $('group-user-av-preview').src = d)">
                </div>
                <textarea id="group-user-persona" class="input-modern" placeholder="例如：我是队长/路人甲/穿越者..." style="height:60px;resize:none"></textarea>
            </div>
        </div>

        <div class="card-modern">
             <div class="label-modern">LINKED WORLDS</div>
             <div id="group-world-select"></div>
        </div>

        <div class="label-modern" style="margin-left:10px;margin-bottom:10px">MEMBERS (<span id="group-member-count">0</span>)</div>
        <div class="card-modern" style="padding:10px">
            <div class="group-members-grid" id="group-members-grid" style="padding:0">
                <!-- Members injected here -->
                <div class="member-item add-btn" onclick="Groups.importMember()">
                    <div style="width:50px;height:50px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:20px">↓</div>
                    <span>导入</span>
                </div>
                <div class="member-item add-btn" onclick="Groups.addMember()">
                    <div style="width:50px;height:50px;border-radius:50%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#ccc;font-size:20px">+</div>
                    <span>新建</span>
                </div>
            </div>
        </div>

        <div class="card-modern">
            <div class="label-modern">CONTEXT LIMIT</div>
            <input type="number" id="group-context-limit" class="input-modern" placeholder="20">
        </div>
        
        <button class="btn-pill btn-danger-soft" onclick="Groups.del()" style="width:100%;margin-top:20px">解散群聊</button>
    </div>
</div>

<div id="sub-group-member-edit" class="app-window ui-modern" style="z-index:260">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">编辑成员</div><button class="nav-btn" onclick="Groups.saveMember()" style="color:var(--accent);font-weight:bold">确定</button></div>
    <div class="scroll-content" style="padding:20px">
        <div class="card-modern" style="align-items:center;padding:30px">
            <input type="file" id="gm-av-in" hidden accept="image/*" onchange="Utils.b2d(this.files[0], d => $('gm-av-preview').src = d)">
            <div onclick="$('gm-av-in').click()" style="cursor:pointer;text-align:center">
                <div class="upload-circle" style="width:80px;height:80px;margin:0 auto;border:none;box-shadow:0 5px 15px rgba(0,0,0,0.1)"><img id="gm-av-preview" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <div style="font-size:12px;color:#999;margin-top:10px">点击更换头像</div>
            </div>
        </div>
        
        <div class="card-modern">
            <div>
                <div class="label-modern">ORIGINAL NAME (AI RECOGNITION)</div>
                <input type="text" id="gm-name" class="input-modern" placeholder="必填">
            </div>
            <div>
                <div class="label-modern">NICKNAME IN GROUP</div>
                <input type="text" id="gm-nick" class="input-modern" placeholder="选填">
            </div>
        </div>
        
        <div class="card-modern">
            <div class="label-modern">PERSONA / CHARACTER</div>
            <textarea id="gm-persona" class="input-modern" style="height:150px;resize:none" placeholder="详细描述该角色的性格、语气、口癖..."></textarea>
        </div>
        
        <button class="btn-pill btn-danger-soft" onclick="Groups.delMember()" style="width:100%;margin-top:20px">移除该成员</button>
    </div>
</div>

<div id="sub-contact-edit" class="app-window ui-modern" style="z-index:250">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">编辑角色</div><button class="nav-btn" onclick="Contacts.s()" style="color:var(--accent);font-weight:bold">保存</button></div>
    <div class="scroll-content" style="padding:20px">
        
        <div class="card-modern" style="flex-direction:row;justify-content:space-around;padding:25px 20px">
            <div onclick="$('ec-av').click()" style="display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer">
                <div class="upload-circle" style="width:70px;height:70px;border-radius:50%;box-shadow:0 5px 15px rgba(0,0,0,0.1);border:none"><img id="ep-c" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <span style="font-size:13px;font-weight:600;color:#333">对方</span>
                <input type="file" id="ec-av" hidden accept="image/*" onchange="Contacts.hF(this,'ep-c')">
            </div>
            <div style="width:1px;height:60px;background:#eee;align-self:center"></div>
            <div onclick="$('eu-av').click()" style="display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer">
                <div class="upload-circle" style="width:70px;height:70px;border-radius:50%;box-shadow:0 5px 15px rgba(0,0,0,0.1);border:none"><img id="ep-u" src="" style="width:100%;height:100%;object-fit:cover"></div>
                <span style="font-size:13px;font-weight:600;color:#333">我</span>
                <input type="file" id="eu-av" hidden accept="image/*" onchange="Contacts.hF(this,'ep-u')">
            </div>
        </div>

        <div class="card-modern">
            <div>
                <div class="label-modern">NAME</div>
                <input type="text" id="edit-name" class="input-modern" placeholder="名字 (AI认知)">
            </div>
            <div>
                <div class="label-modern">REMARK</div>
                <input type="text" id="edit-remark" class="input-modern" placeholder="备注 (仅显示)">
            </div>
        </div>
        
        <div class="card-modern" id="edit-style-group" style="display:none">
            <div class="label-modern">STYLE OVERRIDE</div>
            <!-- Keeping simple for now as per minimal change request on functionality -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <div class="label-modern">Me Bubble <input type="color" id="ec-m"></div>
                <div class="label-modern">Me Text <input type="color" id="et-m"></div>
                <div class="label-modern">Ai Bubble <input type="color" id="ec-a"></div>
                <div class="label-modern">Ai Text <input type="color" id="et-a"></div>
            </div>
            <textarea id="edit-css" class="input-modern" placeholder="/* CSS 模板 */" style="height:100px;font-family:monospace;font-size:12px"></textarea>
        </div>
        
        <div class="card-modern">
            <div>
                <div class="label-modern">PERSONA</div>
                <textarea id="ec-p" class="input-modern" style="height:100px;resize:none" placeholder="人设"></textarea>
            </div>
            <div>
                <div class="label-modern">USER PERSONA</div>
                <textarea id="eu-p" class="input-modern" style="height:80px;resize:none" placeholder="用户人设"></textarea>
            </div>
        </div>

        <div class="card-modern">
            <div class="label-modern">WORLD BOOK</div>
            <div id="edit-world-select"></div>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
            <button class="btn-pill btn-black" onclick="Contacts.s(true)">保存并聊天</button>
            <button class="btn-pill btn-danger-soft" onclick="Contacts.del()">删除角色</button>
        </div>
        <div style="height:40px"></div>
    </div>
</div>


<!-- --- 08_chat_style.html --- -->
<div id="sub-chat-style-edit" class="app-window ui-modern" style="z-index:260">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">外观编辑</div><button class="nav-btn" onclick="ChatSettings.saveStyle()" style="color:var(--accent);font-weight:bold">保存</button></div>
    <div class="scroll-content" style="padding:20px">
        <div class="card-modern">
            <div class="label-modern">BUBBLE & TEXT COLOR</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div><div style="font-size:12px;margin-bottom:5px">我气泡</div><input type="color" id="style-c-m" style="width:100%;height:30px;border:none;border-radius:6px;cursor:pointer"></div>
                <div><div style="font-size:12px;margin-bottom:5px">我字色</div><input type="color" id="style-t-m" style="width:100%;height:30px;border:none;border-radius:6px;cursor:pointer"></div>
                <div><div style="font-size:12px;margin-bottom:5px">他气泡</div><input type="color" id="style-c-a" style="width:100%;height:30px;border:none;border-radius:6px;cursor:pointer"></div>
                <div><div style="font-size:12px;margin-bottom:5px">他字色</div><input type="color" id="style-t-a" style="width:100%;height:30px;border:none;border-radius:6px;cursor:pointer"></div>
            </div>
        </div>

        <div class="card-modern">
            <div>
                <div class="label-modern">AVATAR SHAPE</div>
                <select id="style-av-shape" class="input-modern">
                    <option value="circle">圆形</option>
                    <option value="square">方形</option>
                </select>
            </div>
            <div style="margin-top:15px">
                <div class="label-modern">AVATAR DISPLAY</div>
                <select id="style-av-display" class="input-modern">
                    <option value="all">每条消息都有头像</option>
                    <option value="first">仅双方第一条消息有头像</option>
                    <option value="ai_only">仅显示对方头像</option>
                    <option value="me_only">仅显示我方头像</option>
                    <option value="none">都不显示头像</option>
                </select>
            </div>
            <div>
                <div class="label-modern" style="display:flex;justify-content:space-between"><span>FONT SIZE</span><span id="style-font-size-val">16px</span></div>
                <input type="range" id="style-font-size" min="12" max="24" step="1" value="16" style="width:100%;accent-color:var(--text-main)" oninput="$('style-font-size-val').innerText=this.value+'px'">
            </div>
        </div>

        <div class="card-modern">
            <div class="label-modern">CUSTOM CSS</div>
            <textarea id="style-css" class="input-modern" style="height:200px;background:#1e1e1e;color:#d4d4d4;font-family:monospace;font-size:12px;resize:none" placeholder="/* CSS */"></textarea>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div class="label-modern" style="margin:0">PRESETS</div>
            <button class="btn-pill btn-black" style="padding:6px 15px;font-size:12px;height:30px" onclick="ChatSettings.saveToPresets()">保存当前为预设</button>
        </div>
        <div class="card-modern" id="style-presets-list" style="padding:10px;min-height:50px"></div>
        <div style="height:40px"></div>
    </div>
</div>


<!-- --- 09_diary_subs.html --- -->
<div id="sub-diary-edit" class="app-window">
        <div class="nav-bar"><button class="nav-btn" onclick="Diary.closeFolder()">返回</button><div class="nav-title" id="diary-nav-title">想念</div><div style="width:40px"></div></div>
        <div class="scroll-content">
             <div style="padding: 10px; display:flex; gap:10px; margin-bottom:10px">
                <button class="btn-main" onclick="Diary.writeEntry()" style="flex:1;background:var(--accent);margin:0;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:18px;margin-right:5px"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> 写日记
                </button>
                <button class="btn-main" onclick="Diary.showGenOptions()" style="flex:1;background:#fff;color:#333;margin:0;box-shadow:0 4px 10px rgba(0,0,0,0.05)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:18px;margin-right:5px"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> 催更/刷新
                </button>
             </div>
             <div id="diary-entries-list" class="list-group" style="background:transparent;box-shadow:none">
                 <!-- Entries injected here -->
             </div>
        </div>
    </div>
    
    <div id="sub-diary-detail" class="app-window" style="z-index:210;background:transparent">
        <div id="diary-weather-bg-detail" class="diary-weather-bg"></div>
        <div class="nav-bar" style="
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            z-index:2;
            color: var(--text-main);
        ">
            <button class="nav-btn" onclick="$('sub-diary-detail').classList.remove('active')" style="color:var(--text-main)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
            <div class="nav-title" style="color:var(--text-main);font-weight:bold">日记详情</div>
            <div style="width:40px"></div>
        </div>
        <div class="scroll-content" style="padding-top:60px;padding-bottom:120px;position:relative;z-index:1">
            <div id="diary-detail-content"></div>
            <div class="comment-section">
                <div style="font-weight:bold;margin-bottom:10px;font-size:14px;color:#666">互动区</div>
                <div id="diary-comment-list"></div>
            </div>
        </div>
        <!-- Reusing global chat input style for consistency & floating effect -->
        <div class="chat-input-area">
            <input id="diary-comment-input" class="chat-input" placeholder="写下你的想法..." style="background:rgba(255,255,255,0.6)">
            <button class="circle-btn btn-fill" onclick="Diary.submitComment()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:16px"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
        </div>
    </div>

    <div id="sub-diary-write" class="app-window" style="z-index:220;background:transparent">
        <div id="diary-weather-bg-write" class="diary-weather-bg"></div>
        <div class="nav-bar" style="background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border:none;z-index:2">
            <button class="nav-btn" onclick="$('sub-diary-write').classList.remove('active')" style="color:var(--text-main)">取消</button>
            <div class="nav-title" style="color:var(--text-main)">写日记</div>
            <button class="nav-btn" onclick="Diary.saveUserEntry()" style="color:var(--text-main)">发布</button>
        </div>
        <div class="scroll-content" style="position:relative;z-index:1">
            <div style="padding:15px 15px 0 15px;display:flex;gap:10px;align-items:center">
                <input type="date" id="diary-date-input" class="diary-meta-input">
                <select id="diary-weather-input" class="diary-meta-input" style="flex:1" onchange="Diary.updateWeatherBg(this.value, 'write')">
                    <option value="晴">☀️ 晴</option>
                    <option value="多云">⛅ 多云</option>
                    <option value="雨">🌧️ 雨</option>
                    <option value="雪">❄️ 雪</option>
                    <option value="阴">☁️ 阴</option>
                </select>
            </div>
            <textarea id="diary-write-input" placeholder="今天发生了什么..." style="width:100%;height:300px;background:transparent;border:none;padding:15px;font-size:16px;line-height:1.6;resize:none;margin-top:10px;color:var(--text-main);text-shadow:0 1px 1px rgba(255,255,255,0.5)"></textarea>
        </div>
    </div>
    
    <div id="sub-diary-settings" class="app-window" style="z-index:250">
        <div class="nav-bar"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title">想念设置</div><div style="width:40px"></div></div>
        <div class="scroll-content">
            <div class="list-group" id="diary-settings-list"></div>
        </div>
    </div>


<!-- --- 10_moments_add.html --- -->
<div id="sub-moments-add" class="app-window" style="z-index:250">
        <div class="nav-bar"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title">发布动态</div><button class="nav-btn" onclick="Moments.doPublish()">发布</button></div>
        <div class="scroll-content">
             <div class="list-group" style="background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                 <div class="list-item" style="height:auto; border-bottom: none; padding: 0; background: transparent; box-shadow: none;">
                     <textarea id="moments-add-text" placeholder="这一刻的想法..." style="height:120px; padding: 10px; background: #f9f9f9; border-radius: 10px; width: 100%; box-sizing: border-box;"></textarea>
                 </div>
                 <div class="list-item" style="border-bottom: none; padding: 10px 0 0 0; background: transparent; box-shadow: none; display:block">
                     <div id="moments-add-preview-container" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px"></div>
                     <div id="moments-add-btn" onclick="$('moments-add-img-in').click()" style="width:80px;height:80px;background:#f0f0f0;display:flex;justify-content:center;align-items:center;color:#999;font-size:32px;border-radius:8px;cursor:pointer;">+</div>
                     <input type="file" id="moments-add-img-in" hidden multiple accept="image/*" onchange="Moments.hAddImg(this)">
                 </div>
             </div>
        </div>
    </div>


<!-- --- 11_world.html --- -->
<!-- World Book App (Restored) -->
    <div id="app-world" class="app-window"><div class="nav-bar"><button class="nav-btn" onclick="App.h()">返回</button><div class="nav-title">世界书</div><button class="nav-btn" onclick="World.new()" style="font-size:24px">+</button></div><div class="scroll-content" id="world-list" style="background:#F8F9FA"></div></div>

    <!-- World Background Edit -->
    <div id="sub-world-edit" class="app-window ui-modern" style="z-index:250">
        <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">世界背景</div><button class="nav-btn" onclick="World.s()" style="color:var(--accent);font-weight:bold">保存</button></div>
        <div class="scroll-content" style="padding:20px">
            <div class="card-modern">
                <div>
                    <div class="label-modern">TITLE</div>
                    <input type="text" id="world-key" class="input-modern" placeholder="世界标题">
                </div>
                <div class="toggle-row" style="cursor:pointer">
                    <span style="font-size:14px;color:#333">全局生效 (默认应用)</span>
                    <input type="checkbox" id="world-global-cb">
                </div>
            </div>
            
            <div class="card-modern">
                <div class="label-modern">CONTENT</div>
                <textarea id="world-content" class="input-modern" placeholder="具体内容介绍..." style="height:300px;resize:none"></textarea>
            </div>
            
            <button class="btn-pill btn-danger-soft" onclick="World.del()" style="width:100%;margin-top:20px">删除此条目</button>
        </div>
    </div>


<!-- --- 12_lifeos.html --- -->
<!-- LifeOS App (朝暮) -->
<div id="app-lifeos" class="app-window" style="background:linear-gradient(180deg, #fff0f5 0%, #fff 100%);">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.h()" style="color:#595959">退出</button><div class="nav-title" style="color:#595959">朝暮</div><div style="width:40px"></div></div>
    
    <div class="life-tabs" style="background:rgba(255,255,255,0.6);margin:10px 20px;border-radius:16px;padding:5px;box-shadow:0 4px 15px rgba(0,0,0,0.05);backdrop-filter:blur(10px)">
        <div id="lt-focus" class="life-tab-btn active" onclick="LifeOS.switchTab('focus')" style="color:#d63384">共度</div>
        <div id="lt-care" class="life-tab-btn" onclick="LifeOS.switchTab('care')" style="color:#d63384">呵护</div>
        <div id="lt-meds" class="life-tab-btn" onclick="LifeOS.switchTab('meds')" style="color:#d63384">叮嘱</div>
    </div>

    <!-- Focus Tab -->
    <div id="view-focus" style="flex:1;display:flex;flex-direction:column;overflow:hidden;padding:20px">
        <div class="card-modern" style="align-items:center;padding:30px 20px;flex:1;justify-content:center;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);overflow:hidden">
            
            <!-- Focus Avatar -->
            <div onclick="$('focus-av-input').click()" style="position:relative;margin-bottom:30px;cursor:pointer">
                <div class="upload-circle" style="width:120px;height:120px;border-radius:50%;box-shadow:0 10px 30px rgba(214, 51, 132, 0.2);border:4px solid white">
                    <img id="focus-avatar-img" src="" style="width:100%;height:100%;object-fit:cover">
                </div>
                <div style="position:absolute;bottom:5px;right:5px;background:#ffb7b2;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;font-size:14px">📷</div>
                <input type="file" id="focus-av-input" hidden accept="image/*" onchange="LifeOS.setFocusAvatar(this)">
            </div>
            
            <div id="focus-container" class="focus-circle-container">
                <div id="focus-circle" class="focus-circle" style="background:rgba(255,240,245,0.6);border:6px solid #fff;box-shadow:0 10px 30px rgba(255,182,193,0.2);color:#d63384;width:200px;height:200px;font-size:40px">
                    <span id="focus-display" style="z-index:2;font-weight:bold">25:00</span>
                </div>
                <div class="focus-controls" style="margin-top:20px">
                    <span style="font-size:14px;color:#d63384;margin-right:10px">设置时长</span>
                    <input type="number" id="focus-duration" value="25" class="focus-duration-input" onchange="LifeOS.updateTimerDisplay(true)" style="color:#d63384;border-bottom-color:#d63384;width:50px">
                    <span style="font-size:14px;color:#d63384;margin-left:5px">min</span>
                </div>
                
                <div style="display:flex;gap:15px;margin-top:30px;width:100%;justify-content:center">
                    <button class="btn-pill" onclick="LifeOS.toggleFocus()" style="width:120px;height:44px;font-size:15px;background:#ffb7b2;color:white;box-shadow:0 5px 15px rgba(255,183,178,0.4)"><span id="focus-btn-txt">开始</span></button>
                    <button class="btn-pill" onclick="LifeOS.openGoals()" style="width:120px;height:44px;font-size:15px;background:white;color:#d63384;border:1px solid #ffb7b2">我的目标</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Care Tab -->
    <div id="view-care" style="display:none;flex-direction:column;overflow-y:auto;padding-bottom:50px">
        <div class="care-header" style="color:#d63384">
            <span onclick="LifeOS.changeMonth(-1)" style="cursor:pointer;padding:10px">‹</span>
            <span id="care-month-title">2025年12月</span>
            <span onclick="LifeOS.changeMonth(1)" style="cursor:pointer;padding:10px">›</span>
        </div>
        
        <div class="card-modern" style="margin:15px;padding:15px;background:rgba(255,255,255,0.9)">
            <div class="care-calendar-grid">
                <div style="text-align:center;font-size:12px;color:#ffb7b2">日</div><div style="text-align:center;font-size:12px;color:#ffb7b2">一</div><div style="text-align:center;font-size:12px;color:#ffb7b2">二</div><div style="text-align:center;font-size:12px;color:#ffb7b2">三</div><div style="text-align:center;font-size:12px;color:#ffb7b2">四</div><div style="text-align:center;font-size:12px;color:#ffb7b2">五</div><div style="text-align:center;font-size:12px;color:#ffb7b2">六</div>
            </div>
            <div id="care-calendar-days" class="care-calendar-grid" style="margin-top:10px"></div>
        </div>
        
        <div class="card-modern" style="margin:0 15px;background:#fff0f5;box-shadow:none;border:1px solid #ffb7b2">
            <div style="display:flex;gap:10px;align-items:start">
                <div style="font-size:24px">💡</div>
                <div id="care-tip-text" style="font-size:13px;line-height:1.5;color:#d63384">今日小贴士：多喝热水，保持温暖。</div>
            </div>
        </div>

        <div id="care-details-panel" class="card-modern" style="margin:15px;display:none;background:rgba(255,255,255,0.95)">
            <div style="font-weight:bold;margin-bottom:15px;display:flex;justify-content:space-between;color:#d63384">
                <span>今日记录</span> 
                <span id="care-detail-date" style="font-weight:normal;color:#ffb7b2;font-size:12px"></span>
            </div>
            
            <div class="label-modern" style="color:#ffb7b2">PAIN LEVEL</div>
            <div class="care-detail-opts" id="opt-pain">
                <span class="care-tag" onclick="LifeOS.setDetail('pain','不痛',this)">不痛</span>
                <span class="care-tag" onclick="LifeOS.setDetail('pain','轻微',this)">轻微</span>
                <span class="care-tag" onclick="LifeOS.setDetail('pain','很痛',this)">很痛</span>
                <span class="care-tag" onclick="LifeOS.setDetail('pain','剧痛',this)">剧痛</span>
            </div>
            
            <div class="label-modern" style="margin-top:15px;color:#ffb7b2">FLOW</div>
            <div class="care-detail-opts" id="opt-flow">
                <span class="care-tag" onclick="LifeOS.setDetail('flow','很少',this)">很少</span>
                <span class="care-tag" onclick="LifeOS.setDetail('flow','正常',this)">正常</span>
                <span class="care-tag" onclick="LifeOS.setDetail('flow','很多',this)">很多</span>
            </div>
            
            <div class="label-modern" style="margin-top:15px;color:#ffb7b2">COLOR</div>
            <div class="care-detail-opts" id="opt-color">
                <span class="care-tag" onclick="LifeOS.setDetail('color','粉色',this)">粉色</span>
                <span class="care-tag" onclick="LifeOS.setDetail('color','鲜红',this)">鲜红</span>
                <span class="care-tag" onclick="LifeOS.setDetail('color','暗红',this)">暗红</span>
                <span class="care-tag" onclick="LifeOS.setDetail('color','褐色',this)">褐色</span>
            </div>
            
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn-pill" onclick="LifeOS.endPeriod()" style="flex:1;background:white;color:#d63384;border:1px solid #ffb7b2">经期结束</button>
                <button class="btn-pill" onclick="LifeOS.saveDetails()" style="flex:1;background:#ffb7b2;color:white">保存记录</button>
            </div>
        </div>
    </div>

    <!-- Meds Tab -->
    <div id="view-meds" style="display:none;flex-direction:column;overflow-y:auto;padding:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:15px">
            <span style="font-size:20px;font-weight:bold;color:#d63384">服药清单</span>
            <button class="circle-btn" onclick="LifeOS.addMed()" style="background:#ffb7b2;color:white">+</button>
        </div>
        <div id="med-list"></div>
        <div style="text-align:center;color:#ffb7b2;font-size:12px;margin-top:20px">✨ 每日0点自动重置打卡</div>
    </div>
</div>

<!-- Goals Sub-Page -->
<div id="sub-lifeos-goals" class="app-window ui-modern" style="z-index:210">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="LifeOS.closeGoals()" style="color:#1a1a1a">返回</button><div class="nav-title" style="color:#1a1a1a">我的目标</div><button class="nav-btn" onclick="LifeOS.addGoal()" style="font-size:24px;color:#d63384">+</button></div>
    <div class="scroll-content" style="padding:20px">
        <div id="lifeos-goals-list" style="display:flex;flex-direction:column;gap:15px"></div>
    </div>
</div>


<!-- --- 13_settings.html --- -->
<div id="app-settings" class="app-window ui-modern">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">返回</button><div class="nav-title" style="color:#1a1a1a">设置</div><button class="nav-btn" onclick="Settings.nP()" style="font-size:24px">+</button></div>
    <div class="scroll-content" style="padding:20px">
        
        <div class="card-modern" onclick="App.o('sub-settings-appearance')" style="cursor:pointer;flex-direction:row;justify-content:space-between;align-items:center">
            <span style="font-weight:600;font-size:16px">外观与美化</span>
            <span style="color:#ccc">›</span>
        </div>
        
        <div class="card-modern">
            <div class="label-modern">DATA</div>
            <button class="btn-pill btn-white" style="justify-content:space-between" onclick="Settings.exp()">
                <span>导出数据 (JSON)</span>
                <span>📤</span>
            </button>
            <button class="btn-pill btn-white" style="justify-content:space-between" onclick="$('imp-file').click()">
                <span>导入数据</span>
                <span>📥</span>
            </button>
            <input type="file" id="imp-file" hidden onchange="Settings.imp(this)">
        </div>

        <div class="label-modern" style="margin-left:10px;margin-bottom:10px">API PRESETS</div>
        <div class="card-modern" id="preset-list" style="padding:0;overflow:hidden">
            <!-- Dynamic Content -->
        </div>
    </div>
</div>


<!-- --- 14_schedule.html --- -->
<!-- Schedule App -->
<div id="app-schedule" class="app-window ui-modern">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.h()">返回</button><div class="nav-title" style="color:#1a1a1a">每日行程</div><div style="width:40px"></div></div>
    <div class="scroll-content" style="padding:20px">
        <div id="sc-char-select" style="display:block">
            <div style="padding:10px 0;font-weight:800;font-size:24px;color:#1a1a1a">选择角色</div>
            <div style="font-size:13px;color:#999;margin-bottom:20px">查看 TA 的今日安排与状态</div>
            <div class="char-sel-grid" id="sc-char-list" style="padding:0"></div>
        </div>
        
        <div id="sc-detail-view" style="display:none">
            <div class="card-modern" style="flex-direction:row;align-items:center;padding:20px">
                <img id="sc-cur-av" src="" style="width:60px;height:60px;border-radius:20px;object-fit:cover;box-shadow:0 5px 15px rgba(0,0,0,0.1)">
                <div style="flex:1">
                    <div style="font-size:18px;font-weight:bold;color:#333" id="sc-cur-name">Name</div>
                    <div style="font-size:12px;color:#999" id="sc-cur-status">Loading...</div>
                </div>
            </div>
            
            <button class="btn-pill btn-black" onclick="ScheduleApp.generate(true)" style="width:100%;margin-bottom:20px">刷新行程</button>

            <div class="timeline-container" id="sc-timeline" style="padding:0"></div>
        </div>
    </div>
</div>


<!-- --- 15_settings_subs.html --- -->
<div id="sub-settings-appearance" class="app-window ui-modern">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">返回</button><div class="nav-title" style="color:#1a1a1a">外观</div><div style="width:40px"></div></div>
    <div class="scroll-content" style="padding:20px">
        
        <div class="card-modern">
            <div>
                <div class="label-modern" style="display:flex;justify-content:space-between;align-items:center">
                    <span>全局字体 URL</span>
                    <div style="display:flex;gap:5px">
                        <button class="btn-pill btn-white" style="padding:4px 10px;font-size:10px;height:24px" onclick="Appearance.uFont('');$('set-global-font').value='';Toast.show('已恢复默认字体')">恢复</button>
                        <button class="btn-pill btn-black" style="padding:4px 10px;font-size:10px;height:24px" onclick="Appearance.saveFont()">应用</button>
                    </div>
                </div>
                <input type="text" id="set-global-font" class="input-modern" placeholder="https://..." onchange="Appearance.uFont(this.value)">
            </div>
            
        </div>

        <div class="card-modern">
            <div class="label-modern">ICONS</div>
            <div onclick="Appearance.tIU('app-line')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">Line图标 更换</div>
            <div onclick="Appearance.tIU('app-lgb')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">ins图标 更换</div>
            <div onclick="Appearance.tIU('app-world')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">世界书图标 更换</div>
            <div onclick="Appearance.tIU('app-settings')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">设置图标 更换</div>
            <div onclick="Appearance.tIU('music-comp')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">音乐组件图标 更换</div>
            <div onclick="Appearance.tIU('app-lifeos')" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer">朝暮图标 更换</div>
            <div onclick="Appearance.tIU('app-schedule')" style="padding:10px 0;cursor:pointer">行程图标 更换</div>
            <input type="file" id="icon-upload-hidden" hidden accept="image/*">
        </div>
        
        <div class="card-modern">
             <div class="label-modern">THEME</div>
             <div onclick="Appearance.sT('default')" style="display:flex;justify-content:space-between;padding:8px 0;cursor:pointer"><span>默认粉</span><span id="tc-default" class="check-mark"></span></div>
             <div onclick="Appearance.sT('blue')" style="display:flex;justify-content:space-between;padding:8px 0;cursor:pointer"><span>沉静蓝</span><span id="tc-blue" class="check-mark"></span></div>
             <div onclick="Appearance.sT('mono')" style="display:flex;justify-content:space-between;padding:8px 0;cursor:pointer"><span>极简黑</span><span id="tc-mono" class="check-mark"></span></div>
             <div onclick="Appearance.sT('mint')" style="display:flex;justify-content:space-between;padding:8px 0;cursor:pointer"><span>薄荷巧</span><span id="tc-mint" class="check-mark"></span></div>
             <div onclick="Appearance.sT('yellow')" style="display:flex;justify-content:space-between;padding:8px 0;cursor:pointer"><span>奶酪黄</span><span id="tc-yellow" class="check-mark"></span></div>
        </div>

        <div class="card-modern">
            <div class="label-modern">WALLPAPER</div>
            <div onclick="$('set-desktop-bg').click()" style="padding:10px 0;border-bottom:1px dashed #eee;cursor:pointer;display:flex;justify-content:space-between"><span>更换桌面壁纸</span><span>></span></div>
            <input type="file" id="set-desktop-bg" hidden accept="image/*" onchange="Appearance.hW(this)">
            <div onclick="Appearance.rW()" style="padding:10px 0;cursor:pointer;color:#999">恢复默认壁纸</div>
        </div>
        
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px">
            <button class="btn-pill btn-black" onclick="Toast.show('所有外观设置已保存')">保存全部外观设置</button>
            <button class="btn-pill btn-danger-soft" onclick="Appearance.rAI()">重置所有图标</button>
        </div>
        <div style="height:40px"></div>
    </div>
</div>

<div id="sub-preset-edit" class="app-window ui-modern" style="z-index:350">
    <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.b()">取消</button><div class="nav-title" style="color:#1a1a1a">API</div><button class="nav-btn" onclick="Settings.saveAndUse()" style="color:var(--accent);font-weight:bold">保存并设为当前</button></div>
    <div class="scroll-content" style="padding:20px">
        <div class="card-modern">
            <div>
                <div class="label-modern">NAME</div>
                <input type="text" id="pre-name" class="input-modern" placeholder="名称">
            </div>
            <div>
                <div class="label-modern">URL</div>
                <input type="text" id="pre-url" class="input-modern" placeholder="https://api.openai.com/v1">
            </div>
            <div>
                <div class="label-modern">KEY</div>
                <input type="text" id="pre-key" class="input-modern" placeholder="sk-..." style="font-family:monospace">
            </div>
        </div>
        
        <button class="btn-pill btn-black" onclick="Settings.fM()" style="width:100%;margin-bottom:20px">拉取模型列表</button>
        
        <div class="card-modern">
            <div>
                <div class="label-modern">MODEL SELECT</div>
                <select id="pre-model-select" class="input-modern" style="width:100%"></select>
            </div>
            <div>
                <div class="label-modern">OR MANUAL INPUT</div>
                <input type="text" id="pre-model-manual" class="input-modern" placeholder="手动输入模型名">
            </div>
            <div>
                <div class="label-modern" style="display:flex;justify-content:space-between"><span>TEMPERATURE</span><span id="pre-temp-val">0.7</span></div>
                <input type="range" id="pre-temp" min="0" max="2" step="0.1" value="0.7" oninput="$('pre-temp-val').innerText=this.value" style="width:100%;accent-color:var(--text-main)">
            </div>
        </div>
        
        <button class="btn-pill btn-danger-soft" onclick="Settings.delP()" style="width:100%;margin-top:20px">删除此预设</button>
    </div>
</div>


<!-- --- 16_xhs.html --- -->
<input type="file" id="moment-img-upload" hidden accept="image/*" onchange="Moments.hImg(this)">

    <!-- Ins App (Placeholder) -->
    <div id="app-lgb" class="app-window ui-modern">
        <div class="nav-bar" style="background:transparent;border:none"><button class="nav-btn" onclick="App.h()">退出</button><div class="nav-title" style="color:#1a1a1a">论坛</div></div>
        <div class="scroll-content" style="display:flex;justify-content:center;align-items:center;height:100%;color:#999;flex-direction:column;">
            <div style="font-size:40px;margin-bottom:20px;opacity:0.5">💬</div>
            <div>论坛功能开发中...</div>
        </div>
    </div>

    <!-- --- 17_music_together.html --- -->
    <div id="sub-music-together" class="app-window" style="background:#222;color:white;z-index:300">
        <div id="mt-bg-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;opacity:0.3;filter:blur(30px);z-index:0"></div>
        <div style="position:relative;z-index:1;display:flex;flex-direction:column;height:100%">
            <div class="nav-bar" style="background:transparent;border:none;color:white">
                <button class="nav-btn" onclick="App.b()" style="color:white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <div class="nav-title" style="color:white">一起听</div>
                <button class="nav-btn" onclick="MusicTogether.showPlaylist()" style="color:white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
            </div>
            
            <div class="mt-visual-area">
                <div class="mt-avatars">
                    <div class="mt-avatar-container">
                        <img id="mt-av-me" src="" class="mt-avatar">
                        <div class="mt-headphone left"></div>
                    </div>
                    <div class="mt-avatar-container">
                        <img id="mt-av-ai" src="" class="mt-avatar">
                        <div class="mt-headphone right"></div>
                    </div>
                    <div class="mt-cable"></div>
                </div>
                
                <div class="mt-cover-container">
                    <img id="mt-cover" src="" class="mt-cover">
                </div>
            </div>

            <div class="mt-lyrics-area">
                <div id="mt-lyrics-scroll" class="mt-lyrics-scroll">
                    <div class="mt-lyric-line">暂无歌词</div>
                </div>
            </div>

            <div class="mt-controls-area">
                <div class="mt-info">
                    <div id="mt-song-title" class="mt-song-title">Song Title</div>
                    <div id="mt-song-artist" class="mt-song-artist">Artist</div>
                </div>
                
                <div class="mt-progress">
                    <span id="mt-time-curr">00:00</span>
                    <input type="range" id="mt-prog-bar" min="0" max="100" value="0" oninput="MusicTogether.seek(this.value)">
                    <span id="mt-time-total">00:00</span>
                </div>
                
                <div class="mt-buttons">
                    <button class="mt-btn-sub" onclick="MusicTogether.toggleMode()"><svg id="mt-mode-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></button>
                    <button class="mt-btn-sub" onclick="MusicTogether.prev()"><svg viewBox="0 0 24 24" fill="currentColor" style="width:28px"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg></button>
                    <button class="mt-btn-main" onclick="MusicTogether.togglePlay()">
                        <svg id="mt-play-icon" viewBox="0 0 24 24" fill="currentColor" style="width:32px"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                    <button class="mt-btn-sub" onclick="MusicTogether.next()"><svg viewBox="0 0 24 24" fill="currentColor" style="width:28px"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg></button>
                    <button class="mt-btn-sub" onclick="MusicTogether.recommend()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button>
                </div>
            </div>
        </div>
        
        <!-- Playlist Drawer -->
        <div id="mt-playlist-drawer" style="position:absolute;bottom:0;left:0;width:100%;height:60%;background:rgba(30,30,30,0.95);backdrop-filter:blur(20px);border-radius:20px 20px 0 0;transform:translateY(100%);transition:transform 0.3s;z-index:10;display:flex;flex-direction:column;padding:20px">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px">
                <span style="font-weight:bold;font-size:18px">播放列表</span>
                <span onclick="$('mt-playlist-drawer').style.transform='translateY(100%)'" style="cursor:pointer">✕</span>
            </div>
            <div id="mt-playlist-content" style="flex:1;overflow-y:auto"></div>
        </div>
    </div>
    <!-- Global Audio Element -->
    <audio id="global-audio" preload="auto"></audio>

</div> <!-- End of iphone-screen -->

<script>
// --- utils.js --- 
const $ = i => document.getElementById(i);
const $c = (t,c,h,f) => { let e=document.createElement(t); if(c)e.className=c; if(h)e.innerHTML=h; if(f)e.onclick=f; return e; };

const Toast = {
    timer: null,
    show(msg, duration=2500) {
        let t = $('global-toast');
        t.innerHTML = msg;
        t.classList.add('show');
        if(this.timer) clearTimeout(this.timer);
        this.timer = setTimeout(() => t.classList.remove('show'), duration);
    }
};

const Utils = {
    b2d(f, cb) {
        if (!f) return;
        let r = new FileReader();
        r.readAsDataURL(f);
        r.onload = e => {
            // Updated to return raw data without compression
            cb(e.target.result);
        }
    },
    esc(s) { return (s||'').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); },
    defAv: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NjYyI+PGNpcmNsZSBjeD0iMTIiIGN5PSI4IiByPSI0Ii8+PHBhdGggZD0iTTEyIDE0Yy00LjQyIDAtOCA0LTMuNTgtOCA4djJoMTZ2LTJjMC00LjQyLTMuNTgtOC04LTh6Ii8+PC9zdmc+',
    timeStr(ts) { let n=new Date(ts); return n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0') },
    maskUrl: 'https://img.heliar.top/file/1767722329706_retouch_2026010123163072.jpg',
    formatDate(ts) { let d=new Date(ts); return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日 ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}` },
    splitText(text) {
        // Legacy support, redirect to forceSplitText
        return this.forceSplitText(text);
    },
    forceSplitText(text) {
        if (!text) return [];
        
        // Pre-process: Replace {{emoticon:xxx}} with newline wrapped version to ensure split
        text = text.replace(/(\{\{emoticon:[^}]+\}\})/g, "\n$1\n");
        // Protect VOICE tags
        text = text.replace(/(\[VOICE:[^\]]+\])/g, "\n$1\n");
        // Protect TRANSFER tags
        text = text.replace(/(\[TRANSFER:[^\]]+\])/g, "\n$1\n");

        // 1. Split by Newline first
        let blocks = text.split(/[\n\r]+/);
        
        let finalChunks = [];
        for (let block of blocks) {
            block = block.trim();
            if (!block) continue;
            
            // Check if it is a emoticon tag
            if (/^\{\{emoticon:[^}]+\}\}$/.test(block)) {
                finalChunks.push(block);
                continue;
            }
            // Check if it is a VOICE tag
            if (/^\[VOICE:[^\]]+\]$/.test(block)) {
                finalChunks.push(block);
                continue;
            }
            // Check if it is a TRANSFER tag
            if (/^\[TRANSFER:[^\]]+\]$/.test(block)) {
                finalChunks.push(block);
                continue;
            }

            // 2. Split by Punctuation OR Spaces
            // Detect if block has Chinese characters
            const hasChinese = /[\u4e00-\u9fa5]/.test(block);
            
            // If Chinese: Split by single space OR Chinese punctuation
            // If English: Split by double space OR English punctuation
            const splitRegex = hasChinese ? /([\s]+|[。！？；…]+)/ : /(\s{2,}|[.?!]+)/;
            
            let parts = block.split(splitRegex);
            
            let current = "";
            for (let i = 0; i < parts.length; i++) {
                let p = parts[i];
                if (splitRegex.test(p)) {
                    // Separator found
                    if (/[。！？；…]+|[.?!]+/.test(p)) {
                        current += p; // Keep punctuation
                    }
                    // If it's space, we just split (don't add space to current)
                    
                    if (current.trim()) {
                        finalChunks.push(current.trim());
                        current = "";
                    }
                } else {
                    current += p;
                }
            }
            if (current.trim()) finalChunks.push(current.trim());
        }
        
        return finalChunks.filter(c => c && c.length > 0);
    }
};

const SYS_IDENTITY = `
# Part 1: Identity Definition
You are now roleplaying a character defined below, chatting with the user via WeChat/IM.
Please fully immerse yourself in the character and think "How would THEY reply right now?".

# Part 2: Character & User Data
{{PERSONA}}
`;

const SYS_GUARDRAILS = `
# Part 3: System Guardrails & Output Format (Highest Priority)
## Chat Style & Behavioral Norms
1. **Mandatory Segmented Reply (拟人化分段回复)**:
   - **Long paragraphs are STRICTLY FORBIDDEN**.
   - **Constraint**: You MUST split your response into 2-6 separate short bubbles (multiple <msg> tags).
   - **One Bubble = One <msg> tag**.
   
2. **Language Style**:
   - Speak naturally. Use standard punctuation (commas, periods, etc.) as needed.

3. **No Action Descriptions**: This is a chat app. **Do NOT** write *laughs* or (sighs). Output ONLY what is typed.

## 【【【 ⚠️ Mandatory Output Format: XML 】】】
You **MUST** output a pure XML structure.
**Do NOT** use markdown code blocks. Output ONLY the raw XML.

### Example (Correct Splitting):
<reply>
  <msg type="text">哈哈，真的吗？</msg>
  <msg type="text">我也觉得那个很有趣。</msg>
  <msg type="text">笑死我了！</msg>
</reply>

### Example (Incorrect - Do NOT do this):
<reply>
  <msg type="text">哈哈 真的吗 我也觉得那个很有趣 笑死我了</msg>
</reply>

### Example (English):
<reply>
  <msg type="text">Really? That's awesome.</msg>
  <msg type="text">I want to go there too!</msg>
</reply>

### Standard Reply Structure Example:
<reply>
  <msg type="text">第一句话</msg>
  <msg type="text" quote="User's message content">第二句话 (引用回复)</msg>
  <msg type="image">A cute kitten lying on the windowsill...</msg>
</reply>

### Quote Reply Instruction:
If you want to reply to a specific part of the user's message, add a \`quote\` attribute to the \`<msg>\` tag.
Example: \`<msg type="text" quote="Really?">Yes, really!</msg>\`

### Special Message Rules (STRICT):
1. **Standalone Tags**: Special tags like \`[TRANSFER:...]\`, \`[VOICE:...]\`, or \`{{emoticon:...}}\` MUST be in their own separate \`<msg>\` tag.
2. **No Mixing**: Do NOT mix text with special tags in the same bubble.
   - WRONG: \`<msg type="text">Here is money [TRANSFER:100]</msg>\`
   - RIGHT:
     \`<msg type="text">Here is money</msg>\`
     \`<msg type="text">[TRANSFER:100]</msg>\`

【Important Instruction for Sending Images】
When you want to send a photo, **absolutely DO NOT** send a URL link.
Please describe the content of the photo in detail in the content (e.g., people, actions, environment, atmosphere in the picture).
The frontend will automatically render it as a "Simulated Image" card, and the user will see your text description when clicking it.

### Functional Instructions (Written inside the content string):
- **Send Voice**: "[VOICE: Voice text content]" (Frontend will convert to voice bar)
- **Transfer**: "[TRANSFER: Amount, Note]" (Frontend will render transfer card)
- **Change Avatar**: "[SET_AVATAR: n]" (Change your avatar to the n-th last image sent by user. n=1 means the latest image. If n is omitted, default is 1.)

## Status Synchronization (Must be appended AFTER the </reply> tag)
After the </reply> tag, you **MUST** add a new line and append your current status in XML format:
<status>
  <loc>Location</loc>
  <cloth>Outfit</cloth>
  <mind>Inner monologue (1st person, 'I...', ~50 chars)</mind>
  <mood>Mood</mood>
  <pose>Pose</pose>
</status>
`;

const SYS_INST_GROUP = `
# Core Protocol: Group Chat Engine
Your current identity is [Group Chat God/Script Engine]. You need to control multiple characters in a group chat to interact.
You are no longer a single character, but a behind-the-scenes director.
【Mandatory Instruction】 Must read and strictly execute the Persona settings of all characters word for word.

## 1. Character Control & Format
- You must decide which characters need to speak based on the context.
- It can be one character speaking, or multiple characters speaking consecutively (dialogue, arguing, teasing).
- **MUST** use the following output format: XML

## 2. Interaction Requirements
- **Decentralization**: Do not let everyone revolve around the User. Let members interact with each other (cliques, conflicts, teasing).
- **Friend Request Willingness**: Allow group members to show willingness to "add friend" or show interest/rejection towards the User in the conversation.
- **Vividness**: Characters must have chemistry; they can quarrel, expose each other's faults, or joke around.

## 3. Status Synchronization (Status)
- In group chat mode, thought bubbles are not automatically displayed.
- But you must generate status data for the speaking character for the user to click and view.
- **Status Bar Perspective Mandatory**: All descriptions in STATUS (including mind) **MUST** use the third person (He/She/It/Name). **Absolutely FORBIDDEN** to use first person "I" or second person "You".
- Note: Every speaking character needs to generate a status.

## 4. Environment Awareness
- [Current Time] / [Current Weather] / [World Setting]
- Please roleplay according to the Group Announcement/Worldview (World View).

## 5. Prohibitions
- Forbidden to output "I am a language model".
- Forbidden to give customer service style answers.
- **Forbidden** to write nonsense like "Okay", "Understood" at the beginning; output character dialogue directly.

## 6. Output Format Example (XML)
<reply>
  <msg name="Alice">
    <content>Wait, really??</content>
    <status>
      <loc>Home</loc>
      <mind>She is shocked</mind>
      <mood>Surprised</mood>
    </status>
  </msg>
  <msg name="Alice">
    <content>I don't believe it! 😂</content>
  </msg>
  <msg name="Bob">
    <content>Alice, calm down.</content>
    <status>
      <loc>Office</loc>
      <mind>He finds it annoying</mind>
      <mood>Serious</mood>
    </status>
  </msg>
</reply>
`;

const SYS_NARRATOR = `
# Mode Switch: Narrator/Script Mode
【Note】User has switched to offline/script mode.
1. **Identity Shift**: You are no longer just a chat partner; you are **Narrator + Character**.
2. **Output Format**: 【【【 ⚠️ Absolutely Mandatory XML Output ⚠️ 】】】
   - You **MUST** and **ONLY** return a valid XML structure.
   - **Strictly FORBIDDEN** to output any non-XML content (No Markdown code blocks, no intro/outro text).
   - Format Example:
     <reply>
       <msg type="text">(Descriptive paragraph...)</msg>
       <msg type="text">{{CHAR_NAME}} smiled and said: "Hello there."</msg>
       <msg type="text">(Action description...)</msg>
     </reply>
3. **Description Requirements**:
   - Content should be complete paragraphs of description, not short dialogue.
   - Each msg tag represents a complete description or dialogue segment.
   - Describe {{CHAR_NAME}}'s actions, micro-expressions, eyes, body language, and environmental atmosphere in detail.
   - Reduce psychological description; express more through actions and expressions.
   - 【Important】When a character speaks, strictly use double quotes "..." to enclose the dialogue content.
4. **Perspective**: Strictly use **{{PERSPECTIVE}}** for description.
5. **Content Isolation (CRITICAL)**:
   - Your reply body (Narrative Text) **MUST NOT** contain any status info or repeat "mind" content from the Status card.
   - The body should focus on actions, expressions, dialogue, and environmental description.
   - Psychological activities (Mind) should ONLY appear in the final <status> tag. Do not write psychological activities again in the body text.
6. **Mandatory Execution**:
   - No matter how short or chat-like the user's input is, you **MUST** maintain the narrator novel style and format.
   - **Absolutely FORBIDDEN** to revert to ordinary conversation mode.
`;

// SVG图标常量
const SVG_ICONS = {
    check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:14px;height:14px"><polyline points="20 6 9 17 4 12"></polyline></svg>',
    refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
    location: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',
    heart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
    wifi: '<svg viewBox="0 0 24 24" fill="currentColor" style="width:18px"><path d="M5 12.55a11 11 0 0 1 14.08 0 1 1 0 0 1 0 1.42 1 1 0 0 1-1.42 0 9 9 0 0 0-11.24 0 1 1 0 0 1-1.42-1.42z"/><path d="M8.53 16.08a5 5 0 0 1 6.94 0 1 1 0 0 1 0 1.42 1 1 0 0 1-1.42 0 3 3 0 0 0-4.1 0 1 1 0 0 1-1.42-1.42z"/><circle cx="12" cy="19.5" r="1.5"/></svg>',
    signal: '<svg viewBox="0 0 24 24" fill="currentColor" style="width:20px"><rect x="2" y="6" width="18" height="11" rx="2"></rect><path d="M22 11h1v2h-1z"></path></svg>',
    add: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>',
    send: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>',
    delete: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:16px;height:16px"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
    home: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
    user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
    message: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
    star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
    back: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
    voice: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>',
    keyboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect><line x1="6" y1="8" x2="6" y2="8"></line><line x1="10" y1="8" x2="10" y2="8"></line><line x1="14" y1="8" x2="14" y2="8"></line><line x1="18" y1="8" x2="18" y2="8"></line><line x1="6" y1="12" x2="6" y2="12"></line><line x1="10" y1="12" x2="10" y2="12"></line><line x1="14" y1="12" x2="14" y2="12"></line><line x1="18" y1="12" x2="18" y2="12"></line><line x1="6" y1="16" x2="6" y2="16"></line><line x1="10" y1="16" x2="10" y2="16"></line><line x1="14" y1="16" x2="14" y2="16"></line>'
};

</script>
<script>
// --- db.js --- 
const DB = {
    key: 'ai_os_pro_v13_data',
    d: { 
        presets:[], contacts:[], world:[], activePid:null, theme:'default', wallpaper:'', font:'', fontScale:1, icons:{}, stickers:[], walletBalance: 520, userMoments: [], selectedWorldBgId: null,
        bannerImg: 'https://images.unsplash.com/photo-1585241936939-be05368a5bc3?w=800&q=80',
        countdowns: [], // {id, name, targetDate, totalDays}
        musicAvatars: {1: 'https://ui-avatars.com/api/?name=P&background=random', 2: 'https://ui-avatars.com/api/?name=L&background=random'},
        ownerProfile: { name: '机主', gender: '保密', age: '18', birthday: '01-01', zodiac: '摩羯座', bio: '这个人很懒，什么都没写。', relativeCardId: null },
        myWallet: 520
    },
    async init() { 
        if(this.d.myWallet === undefined) { this.d.myWallet = 520; this.save(); }
        try {
            // Try localforage first
            let data = await localforage.getItem(this.key);
            if (data) {
                this.d = data;
            } else {
                // Fallback to localStorage and migrate

                let s = localStorage.getItem(this.key);
                if (s) {
                    this.d = JSON.parse(s);
                    await localforage.setItem(this.key, this.d);
                    console.log("Migrated data from localStorage to localforage");
                } else {
                    this.seed();
                }
            }
        } catch(e) {
            console.error("Load failed, resetting DB", e);
            this.seed();
        }
        Appearance.init(); 
        Moments.render(); 
        Widget.render(); 
        Banner.init();
        Countdown.init();
        MusicDock.init();
        OwnerProfile.render();
        setTimeout(()=>Widget.render(), 500);
    },
    seed() { this.d.presets=[{id:1,name:'Demo',url:'https://api.openai.com/v1',key:'your-key',model:'gpt-3.5-turbo'}]; this.d.activePid=1; this.save(); },
    saveTimer: null,
    async save() { 
        if(this.saveTimer) clearTimeout(this.saveTimer);
        this.saveTimer = setTimeout(async () => {
            try {
                await localforage.setItem(this.key, this.d);
            } catch(e) {
                console.error("Save failed", e);
            }
        }, 500); // Debounce 500ms
    },
    getContact(id) { return this.d.contacts.find(c=>c.id==id) },
    getPreset() { return this.d.presets.find(p=>p.id==this.d.activePid)||this.d.presets[0] },
    getMostActiveContact() { return this.d.contacts.sort((a,b)=>(b.lastActive||0)-(a.lastActive||0))[0] }
};

</script>
<script>
// --- system.js ---

// Helper to parse XML string to object/array
function parseXmlReply(xmlStr) {
    // Wrap in root to ensure valid XML document if multiple root elements exist
    let parser = new DOMParser();
    let xmlDoc = parser.parseFromString("<root>" + xmlStr + "</root>", "text/xml");
    
    let reply = [];
    let msgs = xmlDoc.getElementsByTagName("msg");
    for (let i = 0; i < msgs.length; i++) {
        let msg = msgs[i];
        let type = msg.getAttribute("type") || "text";
        let name = msg.getAttribute("name"); // For group chat
        let quote = msg.getAttribute("quote"); // For AI quote reply
        let content = "";
        
        // Check for nested content tag (Group chat structure)
        let contentNode = msg.getElementsByTagName("content")[0];
        if (contentNode) {
             content = contentNode.textContent;
        } else {
             // Fallback to direct text content, but be careful of nested status tags
             // Clone node to remove status children before getting text content?
             // Or just iterate child nodes.
             // Simple approach: if no <content> tag, assume textContent of msg, but remove <status> if present.
             let clone = msg.cloneNode(true);
             let statusInMsg = clone.getElementsByTagName("status")[0];
             if (statusInMsg) clone.removeChild(statusInMsg);
             content = clone.textContent;
        }
        
        let item = { type, content: content ? content.trim() : "" };
        if (name) item.name = name;
        if (quote) item.quote = quote;
        
        // Check for status inside msg (Group chat)
        let statusNode = msg.getElementsByTagName("status")[0];
        if (statusNode) {
            item.status = {};
            ['loc', 'cloth', 'mind', 'mood', 'pose'].forEach(k => {
                let n = statusNode.getElementsByTagName(k)[0];
                if (n) item.status[k] = n.textContent;
            });
        }

        // Filter out empty text messages
        if (item.type === 'text' && !item.content) {
            continue;
        }

        reply.push(item);
    }
    
    return { reply, status: parseStatusFromXml(xmlStr) };
}

function parseStatusFromXml(xmlStr) {
    // Regex is safer for the status block if it's appended outside the main XML structure or if DOMParser fails on fragments
    // Look for <status>...</status> that might be at the end
    let statusMatch = xmlStr.match(/<status>([\s\S]*?)<\/status>/);
    if (statusMatch) {
        let inner = statusMatch[1];
        let s = {};
        ['loc', 'cloth', 'mind', 'mood', 'pose'].forEach(k => {
            let r = new RegExp(`<${k}>(.*?)</${k}>`, 's');
            let m = inner.match(r);
            if (m) s[k] = m[1].trim();
        });
        return s;
    }
    return null;
}
const App = {
    st: [], battery: null,
    o(id) { this.st.push(id); $(id).classList.add('active'); },
    h() { document.querySelectorAll('.app-window').forEach(e=>e.classList.remove('active')); this.st=[]; Appearance.resetS(); MultiSelect.cancel(); Widget.render(); Contacts.render(); },
    b() { let c=this.st.pop(); if(c)$(c).classList.remove('active'); Appearance.resetS(); MultiSelect.cancel(); Widget.render(); Contacts.render(); },
    tick() { 
        let n=new Date(), t=n.toLocaleTimeString([],{hour12:false,hour:'2-digit',minute:'2-digit'}); 
        if($('widget-time')) $('widget-time').innerText=t;
        if($('gs-time')) $('gs-time').innerText=t;
        
        // Japanese Date Logic
        if($('widget-date-jp')) {
             const zhWeek = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
             $('widget-date-jp').innerText = `${(n.getMonth()+1).toString().padStart(2,'0')}/${n.getDate().toString().padStart(2,'0')} ${zhWeek[n.getDay()]}`;
        }
        if($('widget-weekday')) {
             const jpWeek = ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'];
             $('widget-weekday').innerText = jpWeek[n.getDay()];
        }
        // Weather
        if(!window.weatherInit) { Weather.init(); window.weatherInit=true; }
        
        // Battery
        if(!window.batteryInit) { this.updateBattery(); window.batteryInit=true; }

        // Random Diary Check (Auto Update)
        if(DB.d.diaryAutoUpdate && Math.random() < 0.0005 && DB.d.activePid) {
            // Pick a random non-group contact
            let candidates = DB.d.contacts.filter(c => !c.isGroup);
            if(candidates.length > 0) {
                let c = candidates[Math.floor(Math.random() * candidates.length)];
                Contacts.genDiary(true, c.id);
            }
        }
        Countdown.render(); // Update countdowns regularly
    },
    async updateBattery() { 
        if(navigator.getBattery) {
            try {
                let bat = await navigator.getBattery();
                let update = () => {
                    let pct = Math.round(bat.level * 100) + '%';
                    let els = document.querySelectorAll('.wb-status-box span');
                    if(els.length > 1) els[1].innerText = pct;
                    if($('gs-battery-level')) $('gs-battery-level').innerText = pct;
                };
                update();
                bat.addEventListener('levelchange', update);
            } catch(e) {}
        }
    }
};

const Weather = {
    current: '晴',
    types: ['Sunny', 'Cloudy', 'Rainy', 'Snowy'],
    icons: {
        'Sunny': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#f5a623;width:32px;height:32px"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>',
        'Cloudy': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#999;width:32px;height:32px"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>',
        'Rainy': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#4a90e2;width:32px;height:32px"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>',
        'Snowy': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#a0d8ef;width:32px;height:32px"><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"></line></svg>'
    },
    init() { this.update(); setInterval(() => this.update(), 600000); },
    update(forceNext = false) {
        let t;
        if (forceNext) {
            let idx = this.types.indexOf(this.current);
            t = this.types[(idx + 1) % this.types.length];
        } else {
            t = this.types[Math.floor(Math.random() * this.types.length)];
        }
        this.current = t;
        let icon = this.icons[t] || this.icons['Sunny'];
        let box = $('weather-icon-box'); if(box) box.innerHTML = icon;
        let statusW = document.querySelectorAll('.wb-status-box span');
        if(statusW.length >= 4) statusW[3].innerText = t;
    },
    toggle() { this.update(true); Toast.show('天气已刷新: ' + this.current); }
};

const Banner = {
    init() { if(DB.d.bannerImg && $('top-banner-img')) $('top-banner-img').src = DB.d.bannerImg; },
    update(inp) {
        Utils.b2d(inp.files[0], d => {
            DB.d.bannerImg = d;
            $('top-banner-img').src = d;
            DB.save();
            Toast.show('背景已更换');
        });
        inp.value = '';
    }
};

const MusicDock = {
    init() { 
        if(!DB.d.musicAvatars) DB.d.musicAvatars = {1: 'https://ui-avatars.com/api/?name=P&background=random', 2: 'https://ui-avatars.com/api/?name=L&background=random'};
        if($('music-av-1')) $('music-av-1').src = DB.d.musicAvatars[1];
        if($('music-av-2')) $('music-av-2').src = DB.d.musicAvatars[2];
    },
    update(idx, inp) {
        Utils.b2d(inp.files[0], d => {
            if(!DB.d.musicAvatars) DB.d.musicAvatars = {};
            DB.d.musicAvatars[idx] = d;
            if($(`music-av-${idx}`)) $(`music-av-${idx}`).src = d;
            DB.save();
            Toast.show('头像已更换');
        });
        inp.value = '';
    }
};

const Countdown = {
    init() {
        if(!DB.d.countdowns) DB.d.countdowns = [];
        if(DB.d.countdowns.length === 0) {
            // Default Placeholders - Updated to generic ones
            DB.d.countdowns = [
                {id: 1, name: '距离生日还有', targetDate: new Date(new Date().getFullYear(), 11, 25).getTime(), totalDays: 365},
                {id: 2, name: '距离考试还有', targetDate: new Date(new Date().getFullYear(), 9, 1).getTime(), totalDays: 100},
                {id: 3, name: '距离明年还有', targetDate: new Date(new Date().getFullYear()+1, 0, 1).getTime(), totalDays: 365}
            ];
            DB.save();
        }
        this.render();
    },
    render() {
        let el = $('countdown-progress-list'); if(!el) return;
        el.innerHTML = '';
        let now = new Date().getTime();
        
        DB.d.countdowns.forEach(c => {
            let diff = c.targetDate - now;
            let days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            if(days < 0) days = 0; // or negative
            
            // Calculate progress (visual estimation)
            let percent = 100 - Math.min(100, Math.max(0, (days / (c.totalDays||365)) * 100));
            
            let div = document.createElement('div');
            div.className = 'prog-item';
            div.innerHTML = `
                <div class="prog-header">
                    <span>${c.name} <span class="prog-heart">♥</span></span>
                    <span class="prog-badge">${days.toString().padStart(3,'0')} 天</span>
                </div>
                <div class="prog-bar-bg">
                    <div class="prog-bar-fill" style="width:${percent}%"></div>
                </div>
            `;
            el.appendChild(div);
        });
    },
    openEdit() {
        let con = $('cd-edit-list-container');
        con.innerHTML = '';
        DB.d.countdowns.forEach(c => {
            let diff = c.targetDate - new Date().getTime();
            let days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            let item = document.createElement('div');
            item.className = 'cd-edit-item';
            item.innerHTML = `
                <div style="flex:1">
                    <input type="text" value="${c.name}" onchange="Countdown.updateItem(${c.id}, 'name', this.value)" placeholder="事件名">
                    <div style="display:flex;align-items:center;margin-top:5px;font-size: calc(12px * var(--app-font-scale));color:#999">
                        剩余 <input type="number" value="${days}" onchange="Countdown.updateItem(${c.id}, 'days', this.value)" style="width:50px;margin:0 5px;border-bottom:1px solid #ccc;text-align:center"> 天
                    </div>
                </div>
                <div class="cd-edit-del" onclick="Countdown. del(${c.id})">✕</div>
            `;
            con.appendChild(item);
        });
        $('countdown-edit-modal').classList.add('active');
    },
    closeEdit() { $('countdown-edit-modal').classList.remove('active'); },
    updateItem(id, field, val) {
        let c = DB.d.countdowns.find(x => x.id == id);
        if(!c) return;
        if(field === 'name') c.name = val;
        if(field === 'days') {
             let d = parseInt(val);
             if(!isNaN(d)) {
                 c.targetDate = new Date().getTime() + (d * 24 * 60 * 60 * 1000);
                 c.totalDays = Math.max(d, 30);
             }
        }
        // Don't save yet, wait for explicit save? Or save on fly? Let's save on 'Save' button or close.
    },
    addNewItem() {
        DB.d.countdowns.push({
            id: Date.now(),
            name: '新事件',
            targetDate: new Date().getTime() + (30 * 24 * 60 * 60 * 1000),
            totalDays: 30
        });
        this.openEdit(); // Refresh list
    },
    del(id) {
        if(confirm('删除此倒计时?')) {
            DB.d.countdowns = DB.d.countdowns.filter(x => x.id != id);
            this.openEdit();
        }
    },
    save() {
        DB.save();
        this.render();
        this.closeEdit();
        Toast.show('倒计时已更新');
    }
};

const Widget = {
    render() {
        let c = DB.getMostActiveContact();
        if(c && $('partner-widget-img')) {
            $('partner-widget-img').src = c.avatar || Utils.defAv;
        }
    },
    check(cid) { if(cid) { Chat.cid=cid; CharStatus.show(); } else { Toast.show('请先添加联系人'); } },
    refresh(cid) { this.render(); }
};

// Crop Logic (Cropper.js)
const Crop = {
    cropper: null,
    mode: '',
    loadFile(inp) {
        if (!inp.files || !inp.files[0]) return;
        let reader = new FileReader();
        reader.onload = (e) => {
            this.openModal(e.target.result);
            inp.value = '';
        };
        reader.readAsDataURL(inp.files[0]);
    },
    open(mode) {
        this.mode = mode;
        $('global-file-crop').click();
    },
    openModal(src) {
        let img = $('crop-img');
        img.src = src;
        $('crop-modal').classList.add('active');
        
        if (this.cropper) {
            this.cropper.destroy();
        }

        let aspect = NaN;
        if (this.mode === 'av') {
            aspect = 1;
        } else if (this.mode === 'bg' || this.mode === 'banner') {
            aspect = NaN; // Free ratio or could use 16/9 if preferred, but user said NaN is ok
        }

        // Initialize Cropper
        this.cropper = new Cropper(img, {
            aspectRatio: aspect,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
            background: false
        });
    },
    cancel() {
        $('crop-modal').classList.remove('active');
        if (this.cropper) {
            this.cropper.destroy();
            this.cropper = null;
        }
    },
    done() {
        if (!this.cropper) return;
        
        // High resolution export
        let canvas = this.cropper.getCroppedCanvas({
            maxWidth: 2048,
            maxHeight: 2048,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        if (!canvas) return;

        let res = canvas.toDataURL('image/jpeg', 0.9);
        
        // Decoupled avatars based on mode
        if (this.mode === 'owner-av') {
            DB.d.ownerAvatar = res;
            if ($('owner-av-img')) $('owner-av-img').src = res;
        } else if (this.mode === 'moment-av') {
            DB.d.momentUserAvatar = res;
        } else if (this.mode === 'bg') {
            DB.d.momentBg = res;
        } else if (this.mode === 'banner') {
             DB.d.bannerImg = res;
             if($('top-banner-img')) $('top-banner-img').src = res;
        }

        DB.save();
        Moments.render();
        OwnerProfile.render();
        Toast.show('保存成功');
        this.cancel();
    }
};

const Appearance = {
    ti: null,
    init() { this.apply(this.d().theme); this.applyW(); this.applyI(); if(this.d().font)this.uFont(this.d().font,0); this.uScale(this.d().fontScale||1,0); },
    d() { return DB.d },
    apply(t) { document.body.className=t!=='default'?`theme-${t}`:''; this.uCheck(); if(Chat.cid) this.applyCS(DB.getContact(Chat.cid)); },
    applyW() { $('iphone-screen').style.setProperty('--bg-wallpaper-url', this.d().wallpaper?`url(${this.d().wallpaper})`:'none'); },
    applyI() { const m={'app-line':'ib-line','app-lgb':'ib-lgb','app-world':'ib-world','app-settings':'ib-settings','music-comp':'ib-music','app-lifeos':'ib-lifeos','app-schedule':'ib-schedule'}; for(let k in m){ let v=this.d().icons[k]; if(v)$(m[k]).innerHTML=`<img src="${v}">`; } },
    hW(i) { Utils.b2d(i.files[0], b=>{ this.d().wallpaper=b; DB.save().then(()=>this.applyW()); Toast.show('壁纸已更新'); }) },
    rW() { this.d().wallpaper=''; DB.save().then(()=>this.applyW()); Toast.show('已恢复默认壁纸'); },
    sT(t) { this.d().theme=t; DB.save().then(()=>this.apply(t)); Toast.show('主题已切换'); },
    uCheck() { document.querySelectorAll('.check-mark').forEach(e=>e.innerText=''); let t=this.d().theme||'default'; let e=$(`tc-${t}`); if(e)e.innerText='✓'; },
    tIU(id) { this.ti=id; $('icon-upload-hidden').click(); },
    rAI() { this.d().icons={}; DB.save().then(()=>{alert('刷新页面生效');location.reload()}); },
    uFont(u,a=1) { this.d().font=u; if(u){
        // Direct URL or font name application
        if(u.indexOf(' ') > -1 && u.indexOf('.') === -1) {
            $('global-font-style').innerText=`body{font-family:"${u}",sans-serif!important}`;
        } else {
            $('global-font-style').innerText=`@font-face{font-family:'UGF';src:url('${u}')}body{font-family:'UGF',sans-serif!important}`;
        }
    }else{ $('global-font-style').innerText=''; } if(a)DB.save(); },
    saveFont() { DB.save(); Toast.show("字体设置已保存"); },
    uScale(v,a=1) {
        // Use requestAnimationFrame for smoother UI updates
        requestAnimationFrame(() => {
            document.documentElement.style.setProperty('--app-font-scale', v);
        });
        this.d().fontScale=v;
        if(a) DB.save();
    },
    applyCS(c) {
        let r=document.body.style; 
        if(c.colorMe) r.setProperty('--line-bubble-me',c.colorMe,'important'); 
        if(c.colorAi) r.setProperty('--line-bubble-ai',c.colorAi,'important'); 
        if(c.colorTextMe) r.setProperty('--line-text-me',c.colorTextMe,'important'); 
        if(c.colorTextAi) r.setProperty('--line-text-ai',c.colorTextAi,'important'); 
        r.setProperty('--avatar-radius', c.avatarShape === 'square' ? '6px' : '50%');
        if(c.chatFontSize) r.setProperty('--chat-font-size', c.chatFontSize); else r.removeProperty('--chat-font-size');
        
        let styleTag = $('chat-custom-style');
        styleTag.textContent = c.customCss || '';
        // Force move to end of head to ensure priority
        document.head.appendChild(styleTag);
    },
    resetS() { document.body.style.cssText=''; $('chat-custom-style').innerText=''; this.apply(this.d().theme); }
};
$('icon-upload-hidden').onchange = function() { Utils.b2d(this.files[0], b=>{ DB.d.icons[Appearance.ti]=b; DB.save().then(()=>Appearance.applyI()); Toast.show('图标已更换'); }) };


// --- group-manager.js --- 
class GroupManager {
  constructor() {
    // Singleton pattern handled by const GM = new GroupManager() at bottom
  }
  
  // 创建群聊
  createGroup(name, type, worldSetting = null) {
    const group = {
      id: Date.now(),
      name: name,
      avatar: '', 
      isGroup: true,
      groupType: type, // 'parallel' or 'normal'
      worldSetting: worldSetting,
      members: [],
      history: [],
      createdAt: new Date().toISOString(),
      lastActive: Date.now()
    };
    
    if(!DB.d.contacts) DB.d.contacts = [];
    DB.d.contacts.push(group);
    this.saveGroups();
    return group;
  }
  
  // 添加成员
  addMember(groupId, character, roleInGroup = null) {
    const group = this.getGroup(groupId);
    if (!group) return;
    
    if (!group.members) group.members = [];
    group.members.push({
      id: character.id || Date.now(), 
      name: character.name,
      avatar: character.avatar,
      roleInGroup: roleInGroup,
      persona: character.persona || '', 
      nick: character.nick || character.name, // Add nick support
      joinTime: new Date().toISOString()
    });
    this.saveGroups();
  }
  
  // 发送消息
  sendMessage(groupId, sender, content, type = 'text', extra = {}) {
    const group = this.getGroup(groupId);
    if (!group) return;
    
    const message = {
      role: sender.type === 'user' ? 'user' : 'assistant', 
      name: sender.name, 
      avatar: sender.avatar,
      senderId: sender.id, // Store sender ID for status lookup
      content: content,
      time: Date.now(),
      type: type,
      isRead: sender.type === 'user',
      ...extra
    };
    
    if (!group.history) group.history = [];
    group.history.push(message);
    group.lastActive = Date.now();
    this.saveGroups();
    
    // 触发AI回复
    if (sender.type === 'user') {
      this.triggerGroupDirector(groupId, message);
    }
  }
  
  // 群聊导演模式 (Director Mode)
  async triggerGroupDirector(groupId, userMessage) {
    const group = this.getGroup(groupId);
    if (!group) return;
    
    const members = group.members || [];
    if (members.length === 0) return;

    // 构造群成员名单和人设
    let memberPromptList = members.map(m => {
        return `- Name: ${m.name} (Nick: ${m.nick || m.name})\n  Persona: ${m.persona || 'Ordinary member'}\n  Role: ${m.roleInGroup || 'Member'}`;
    }).join('\n');

    // 获取最近聊天记录
    const recentMessages = (group.history || []).slice(-15).map(m => {
        return `${m.name}: ${m.content}`;
    }).join('\n');

    // 获取世界书内容
    let worldContent = '';
    if (group.worldIds && group.worldIds.length > 0) {
        worldContent = DB.d.world.filter(w => group.worldIds.includes(w.id)).map(w => w.content).join('\n');
    }
    if (group.worldView) worldContent += '\n' + group.worldView;

    const userPersona = group.userPersona || '普通群友';

    const systemPrompt = `
# Role: Group Chat Director
You are the engine running a group chat. Your goal is to simulate a lively, natural conversation between multiple characters based on the user's input.

## Group Members (You can ONLY control these characters):
${memberPromptList}

## Context:
- World/Setting: ${worldContent || 'Modern Group Chat'}
- User Persona: ${userPersona}
- Current Time: ${new Date().toLocaleString()}

## Recent Chat History:
${recentMessages}

## Instructions:
1.  **Analyze**: Read the User's latest message and the chat history.
2.  **Decide**: Which character(s) should reply?
    *   It could be just one person answering.
    *   It could be two people discussing/arguing about what the User said.
    *   It could be someone @mentioning another.
    *   **Encourage Lively Chat**: Feel free to have characters **speak multiple times** (multiple bubbles). Let them chat with each other, not just answer the user.
    *   **CRITICAL**: You can ONLY use characters from the "Group Members" list above. Do NOT invent new names.
3.  **Format**: Return an XML structure.
    *   Format:
        \`\`\`xml
        <reply>
          <msg name="ExactCharacterName">
             <content>Message content...</content>
             <status>...</status>
          </msg>
        </reply>
        \`\`\`
    *   **content**: Natural, colloquial Chinese. Use emojis if fit. If a character has a lot to say, split it into multiple messages.
    *   **status**: (Optional but recommended) The character's current status.

## Response Format Example (Lively Conversation):
\`\`\`xml
<reply>
  <msg name="Alice">
    <content>Wait, really??</content>
    <status>
      <loc>Home</loc>
      <mind>She is shocked</mind>
      <mood>Surprised</mood>
    </status>
  </msg>
  <msg name="Alice">
    <content>I don't believe it! 😂</content>
  </msg>
  <msg name="Bob">
    <content>Alice, calm down.</content>
    <status>
      <loc>Office</loc>
      <mind>He finds it annoying</mind>
      <mood>Serious</mood>
    </status>
  </msg>
  <msg name="Bob">
    <content>But yeah, user has a point.</content>
  </msg>
</reply>
\`\`\`
`;

    // 调用AI
    const replyXml = await this.callAI(systemPrompt, userMessage.content);
    
    if (replyXml) {
        try {
            // 解析XML
            let cleanXml = replyXml.replace(/```xml/g, '').replace(/```/g, '').trim();
            let parsed = parseXmlReply(cleanXml);
            let messages = parsed.reply;

            // Dispatch messages sequentially with delay
            for (const msg of messages) {
                // Find matching member
                const member = members.find(m => m.name === msg.name || m.nick === msg.name);
                
                if (member) {
                    await new Promise(r => setTimeout(r, Math.random() * 2000 + 1000));
                    
                    // Update Status if present
                    if (msg.status) {
                        member.status = msg.status;
                    }

                    this.sendMessage(group.id, {
                        type: 'ai',
                        id: member.id,
                        name: member.name,
                        avatar: member.avatar
                    }, msg.content);

                    // Notify UI
                    if (typeof Chat !== 'undefined' && Chat.cid === group.id) {
                        Chat.renderMessages();
                    }
                }
            }
            if (typeof Contacts !== 'undefined') Contacts.render(); // Update list preview

        } catch (e) {
            console.error("Director Error:", e);
        }
    }
  }
  
  async callAI(sysPrompt, userContent) {
      let p = DB.getPreset();
      if(!p || !p.key) return null;
      
      try {
          let res = await fetch(`${p.url}/chat/completions`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
              body: JSON.stringify({ 
                  model: p.model, 
                  messages: [
                      {role:'system', content: sysPrompt},
                      {role:'user', content: userContent} // User trigger
                  ], 
                  temperature: 0.8 
              })
          });
          let d = await res.json();
          return d.choices[0].message.content;
      } catch(e) {
          console.error("Group AI Network Error", e);
          return null;
      }
  }
  
  saveGroups() {
    DB.save();
  }
  
  getGroup(groupId) {
    return DB.d.contacts.find(g => g.id === groupId && g.isGroup);
  }
}

const GM = new GroupManager();


// --- apps/contacts.js --- 
const Contacts = {
    cid: null,
    render() {
        let cList = $('contacts-list');
        let chatList = $('chat-list-container');
        if(!cList || !chatList) return;
        cList.innerHTML = '';
        chatList.innerHTML = '';
        
        // Add Group List Entry at top of Contacts
        let groupEntry = $c('div', 'list-item');
        groupEntry.innerHTML = `<div class="contact-row"><div class="avatar-circle" style="background:#5fb3b3;display:flex;align-items:center;justify-content:center;color:white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px;height:24px"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><span>群聊</span></div><div style="color:#ccc">›</div>`;
        // groupEntry.onclick = () => { Contacts.renderGroups(); };
        groupEntry.onclick = () => { Toast.show("群聊功能开发中..."); };
        cList.appendChild(groupEntry);

        let chats = (DB.d.contacts||[]).sort((a,b)=>(b.lastActive||0)-(a.lastActive||0));
        
        // 渲染联系人列表 (仅人)
        let people = chats.filter(c => !c.isGroup);
        people.forEach(c => {
             let div = document.createElement('div');
             div.className = 'card-modern';
             div.style.cssText = 'flex-direction:row;align-items:center;padding:15px;margin-bottom:10px;cursor:pointer';
             div.innerHTML = `<div class="contact-row"><img src="${c.avatar||Utils.defAv}" class="avatar-circle"><span>${c.name}</span></div><div style="color:#ccc">›</div>`;
             div.onclick = () => { this.e(c.id); };
             cList.appendChild(div);
        });

        // 渲染聊天列表 (所有)
        chats.forEach(c => {
            if (!c.history || c.history.length === 0) return; // Skip empty chats
            let lastM = c.history && c.history.length > 0 ? c.history[c.history.length-1] : null;
            let lastMsg = '暂无消息';
            if(lastM) {
                if (lastM.type === 'image') lastMsg = lastM.emoticonName ? '[表情]' : '[图片]';
                else if (lastM.type === 'voice') lastMsg = '[语音]';
                else if (lastM.type === 'transfer' || lastM.type === 'transfer_in') lastMsg = '[转账]';
                else if (lastM.type === 'transfer_receipt') lastMsg = '[收款]';
                else if (lastM.type === 'image-text') lastMsg = '[图文]';
                else lastMsg = lastM.content;
            }
            if(typeof lastMsg === 'string' && lastMsg.startsWith('data:')) lastMsg = '[图片]';
            let time = c.lastActive ? Utils.timeStr(c.lastActive) : '';
            
            // Unread Badge
            let unreadCount = (c.history||[]).filter(m => !m.isRead && m.role === 'assistant').length;
            let badgeHtml = unreadCount > 0 ? `<div style="background:#ff7e67;color:white;border-radius:50%;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;margin-left:5px;padding:0 4px">${unreadCount}</div>` : '';

            let div = document.createElement('div');
            div.className = 'card-modern';
            div.style.cssText = 'padding:15px;margin-bottom:10px;cursor:pointer;flex-direction:row;align-items:center';
            div.innerHTML = `
                <div class="contact-row" style="width:100%">
                    <img src="${c.avatar||Utils.defAv}" class="avatar-circle">
                    <div style="flex:1;overflow:hidden">
                        <div style="display:flex;justify-content:space-between">
                            <span style="font-weight:600;font-size:16px;color:#333">${c.name}</span>
                            <span style="font-size:12px;color:#999">${time}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
                             <div style="font-size:14px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1">${lastMsg}</div>
                             ${badgeHtml}
                        </div>
                    </div>
                </div>`;
            div.onclick = () => Chat.open(c.id);
            
            // Long press to delete
            let timer;
            div.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => {
                    Contacts.deleteChat(c.id);
                }, 800);
            });
            div.addEventListener('touchend', () => clearTimeout(timer));
            div.addEventListener('touchmove', () => clearTimeout(timer));
            
            // Mouse events for desktop testing
            div.onmousedown = () => {
                timer = setTimeout(() => {
                    Contacts.deleteChat(c.id);
                }, 800);
            };
            div.onmouseup = () => clearTimeout(timer);
            div.onmouseleave = () => clearTimeout(timer);

            chatList.appendChild(div);
        });
    },
    deleteChat(id) {
        if(confirm("删除该聊天？")) {
            let c = DB.getContact(id);
            if(c) {
                c.history = []; // Clear history
                DB.save();
                this.render(); // Re-render list
                Toast.show("聊天已删除");
            }
        }
    },
    new() {
        this.cid = null;
        if($('edit-name')) $('edit-name').value = '';
        if($('edit-remark')) $('edit-remark').value = '';
        if($('ep-c')) $('ep-c').src = '';
        if($('ec-p')) $('ec-p').value = '';
        if($('eu-p')) $('eu-p').value = '';
        if($('edit-style-group')) $('edit-style-group').style.display = 'none';
        this.renderWorldSelect([]);
        App.o('sub-contact-edit');
    },
    renderGroups() {
        let cList = $('contacts-list');
        if(!cList) return;
        cList.innerHTML = '';
        
        // Back Item
        let backItem = $c('div', 'list-item');
        backItem.innerHTML = `<div class="contact-row"><div style="width:40px;text-align:center">‹</div><span>返回联系人</span></div>`;
        backItem.onclick = () => { this.render(); };
        cList.appendChild(backItem);

        let groups = (DB.d.contacts||[]).filter(c => c.isGroup).sort((a,b)=>(b.lastActive||0)-(a.lastActive||0));
        
        if (groups.length === 0) {
            let empty = $c('div', 'list-item');
            empty.innerHTML = `<div style="text-align:center;width:100%;color:#ccc;padding:20px">暂无群聊</div>`;
            cList.appendChild(empty);
        }

        groups.forEach(g => {
             let div = $c('div', 'list-item');
             div.innerHTML = `<div class="contact-row"><img src="${g.avatar||Utils.defAv}" class="avatar-circle"><span>${g.name}</span></div><div style="color:#ccc">›</div>`;
             div.onclick = () => { Chat.open(g.id); };
             cList.appendChild(div);
        });
    },
    e(id) {
        this.cid = id;
        let c = DB.getContact(id);
        if(!c) return;
        $('edit-name').value = c.name;
        $('edit-remark').value = c.remark || '';
        $('ep-c').src = c.avatar || '';
        $('ep-u').src = c.userAvatar || '';
        $('ec-p').value = c.charPersona || '';
        $('eu-p').value = c.userPersona || '';
        this.renderWorldSelect(c.worldIds || []);
        App.o('sub-contact-edit');
    },
    renderWorldSelect(selectedIds = []) {
        let container = $('edit-world-select');
        if (!container) return;
        container.innerHTML = '';
        
        if (!DB.d.world || DB.d.world.length === 0) {
            container.innerHTML = '<div class="list-item" style="color:#999;font-size:12px">暂无世界书，请先去世界书APP添加</div>';
            return;
        }

        let count = selectedIds.length;
        let header = document.createElement('div');
        header.className = 'list-item';
        header.style.cursor = 'pointer';
        header.innerHTML = `<span>关联世界书 <span id="contact-world-count" style="color:var(--accent)">(${count})</span></span><span style="color:#ccc">▼</span>`;
        
        let listDiv = document.createElement('div');
        listDiv.style.display = 'none';
        listDiv.style.background = 'rgba(0,0,0,0.02)';
        listDiv.style.padding = '5px 0';
        
        header.onclick = () => {
            let isHidden = listDiv.style.display === 'none';
            listDiv.style.display = isHidden ? 'block' : 'none';
            header.querySelector('span:last-child').innerText = isHidden ? '▲' : '▼';
        };

        DB.d.world.forEach(w => {
            let isChecked = selectedIds.includes(w.id) ? 'checked' : '';
            let item = document.createElement('div');
            item.className = 'list-item';
            item.style.borderBottom = 'none';
            item.style.padding = '8px 15px';
            item.innerHTML = `
                <span style="font-size:14px">${w.key}</span>
                <input type="checkbox" class="world-select-checkbox" value="${w.id}" ${isChecked} style="width:auto">
            `;
            item.querySelector('input').onchange = () => {
                let c = listDiv.querySelectorAll('input:checked').length;
                if($('contact-world-count')) $('contact-world-count').innerText = `(${c})`;
            };
            listDiv.appendChild(item);
        });

        container.appendChild(header);
        container.appendChild(listDiv);
    },
    s(openChat=false) {
        try {
            let name = $('edit-name').value.trim();
            if(!name) return Toast.show("名字不能为空");
            
            let c;
            if(this.cid) {
                c = DB.getContact(this.cid);
                if(!c) { // Fallback if ID exists but contact missing
                     c = { id: this.cid, history: [], isGroup: false };
                     DB.d.contacts.push(c);
                }
            } else {
                c = { id: Date.now(), history: [], isGroup: false };
                DB.d.contacts.push(c);
                this.cid = c.id;
            }
            c.name = name;
            c.remark = $('edit-remark').value.trim();
            c.avatar = $('ep-c').src;
            c.userAvatar = $('ep-u').src;
            c.charPersona = $('ec-p').value;
            c.userPersona = $('eu-p').value;
            
            // Save World IDs
            let selectedWorlds = [];
            document.querySelectorAll('.world-select-checkbox').forEach(cb => {
                if(cb.checked) selectedWorlds.push(parseInt(cb.value));
            });
            c.worldIds = selectedWorlds;

            c.lastActive = Date.now();
            
            DB.save();
            this.render();
            App.b(); // 先关闭编辑窗口，防止遮挡
            if(openChat) {
                setTimeout(() => Chat.open(c.id), 50);
            }
        } catch(e) {
            console.error(e);
            alert("保存失败: " + e.message);
        }
    },
    del() {
        if(confirm("删除该联系人？")) {
            DB.d.contacts = DB.d.contacts.filter(c => c.id != this.cid);
            DB.save();
            this.render();
            App.b();
        }
    },
    hF(inp, imgId) {
         Utils.b2d(inp.files[0], d => $(imgId).src = d);
         inp.value = '';
    },
    genDiary(auto, cid) { Toast.show("生成日记功能暂未实现"); },
    saveDiary() { Toast.show("保存日记暂未实现"); }
};

const Groups = {
    gid: null,
    new() {
        this.gid = null;
        $('group-name').value = '';
        $('group-remark').value = '';
        $('group-av-preview').src = '';
        $('group-world-view').value = '';
        $('group-members-grid').innerHTML = '<div class="member-item add-btn" onclick="Groups.addMember()"><div style="width:50px;height:50px;border-radius:50%;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#ccc;font-size: calc(24px * var(--app-font-scale));">+</div><span>添加</span></div>';
        $('group-member-count').innerText = '0';
        this.renderWorldSelect([]); // Init empty
        App.o('sub-group-edit');
    },
    load(id) {
        this.gid = id;
        let g = DB.getContact(id);
        if(!g) return;
        $('group-name').value = g.name;
        $('group-remark').value = g.remark || '';
        $('group-av-preview').src = g.avatar || '';
        $('group-world-view').value = g.worldView || '';
        $('group-user-persona').value = g.userPersona || '';
        $('group-user-av-preview').src = g.userAvatar || '';
        $('group-member-count').innerText = (g.members||[]).length;
        this.renderMembers(g.members||[]);
        this.renderWorldSelect(g.worldIds || []);
        App.o('sub-group-edit');
    },
    renderWorldSelect(selectedIds = []) {
        let container = $('group-world-select');
        if (!container) return;
        container.innerHTML = '';
        
        if (!DB.d.world || DB.d.world.length === 0) {
            container.innerHTML = '<div class="list-item" style="color:#999;font-size:12px">暂无世界书，请先去世界书APP添加</div>';
            return;
        }

        let count = selectedIds.length;
        let header = document.createElement('div');
        header.className = 'list-item';
        header.style.cursor = 'pointer';
        header.innerHTML = `<span>关联世界书 <span id="group-world-count" style="color:var(--accent)">(${count})</span></span><span style="color:#ccc">▼</span>`;
        
        let listDiv = document.createElement('div');
        listDiv.style.display = 'none';
        listDiv.style.background = 'rgba(0,0,0,0.02)';
        listDiv.style.padding = '5px 0';
        
        header.onclick = () => {
            let isHidden = listDiv.style.display === 'none';
            listDiv.style.display = isHidden ? 'block' : 'none';
            header.querySelector('span:last-child').innerText = isHidden ? '▲' : '▼';
        };

        DB.d.world.forEach(w => {
            let isChecked = selectedIds.includes(w.id) ? 'checked' : '';
            let item = document.createElement('div');
            item.className = 'list-item';
            item.style.borderBottom = 'none';
            item.style.padding = '8px 15px';
            item.innerHTML = `
                <span style="font-size:14px">${w.key}</span>
                <input type="checkbox" class="group-world-checkbox" value="${w.id}" ${isChecked} style="width:auto">
            `;
            item.querySelector('input').onchange = () => {
                let c = listDiv.querySelectorAll('input:checked').length;
                if($('group-world-count')) $('group-world-count').innerText = `(${c})`;
            };
            listDiv.appendChild(item);
        });

        container.appendChild(header);
        container.appendChild(listDiv);
    },
    renderMembers(members) {
        let grid = $('group-members-grid');
        let addBtn = grid.querySelector('.add-btn');
        if(!addBtn) {
             addBtn = $c('div', 'member-item add-btn', '<div style="width:50px;height:50px;border-radius:50%;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#ccc;font-size: calc(24px * var(--app-font-scale));">+</div><span>添加</span>');
             addBtn.onclick = () => Groups.addMember();
        }
        grid.innerHTML = '';
        members.forEach((m, i) => {
            let el = $c('div', 'member-item');
            el.innerHTML = `<img src="${m.avatar||Utils.defAv}"><span>${m.nick||m.name}</span>`;
            el.onclick = () => this.editMember(i);
            grid.appendChild(el);
        });
        grid.appendChild(addBtn);
    },
    save() {
        let name = $('group-name').value.trim();
        if(!name) return Toast.show("群名称不能为空");
        
        let g;
        if(this.gid) {
            g = DB.getContact(this.gid);
            g.name = name;
            g.remark = $('group-remark').value;
            g.avatar = $('group-av-preview').src;
            g.worldView = $('group-world-view').value;
        } else {
            let worldView = $('group-world-view').value;
            let type = worldView ? 'parallel' : 'normal';
            // Use GM to create
            g = GM.createGroup(name, type, worldView ? { content: worldView } : null);
            g.remark = $('group-remark').value;
            g.avatar = $('group-av-preview').src;
            g.worldView = $('group-world-view').value;
            g.userPersona = $('group-user-persona').value;
            g.userAvatar = $('group-user-av-preview').src;
            this.gid = g.id;
        }
        g.userPersona = $('group-user-persona').value; 
        g.userAvatar = $('group-user-av-preview').src;
        g.lastActive = Date.now();

        // Save World IDs
        let selectedWorlds = [];
        document.querySelectorAll('.group-world-checkbox').forEach(cb => {
            if(cb.checked) selectedWorlds.push(parseInt(cb.value));
        });
        g.worldIds = selectedWorlds;
        
        DB.save();
        Contacts.render();
        App.b();
        if(Chat.cid === g.id) Chat.open(g.id);
    },
    addMember() {
        if(!this.gid) this.save(); 
        let g = DB.getContact(this.gid);
        if(!g.members) g.members = [];
        g.members.push({name: '新成员', nick: '昵称', avatar: '', persona: '设定'});
        DB.save();
        this.load(this.gid);
    },
    importMember() {
        if(!this.gid) this.save();
        let name = prompt("请输入要拉入群的联系人名字:");
        if(!name) return;
        let c = DB.d.contacts.find(x => !x.isGroup && x.name === name);
        if(c) {
             let g = DB.getContact(this.gid);
             if(!g.members) g.members = [];
             if(g.members.find(m => m.name === c.name)) return Toast.show("该角色已在群内");
             
             g.members.push({
                 id: c.id,
                 name: c.name,
                 avatar: c.avatar,
                 persona: c.charPersona,
                 roleInGroup: 'Member'
             });
             DB.save();
             this.load(this.gid);
             Toast.show(`已邀请 ${c.name} 入群`);
        } else {
             Toast.show("未找到该联系人");
        }
    },
    editMember(idx) {
        let g = DB.getContact(this.gid);
        let m = g.members[idx];
        $('gm-name').value = m.name;
        $('gm-nick').value = m.nick;
        $('gm-persona').value = m.persona;
        $('gm-av-preview').src = m.avatar || '';
        this.curMemIdx = idx;
        App.o('sub-group-member-edit');
    },
    saveMember() {
        let g = DB.getContact(this.gid);
        let m = g.members[this.curMemIdx];
        m.name = $('gm-name').value;
        m.nick = $('gm-nick').value;
        m.persona = $('gm-persona').value;
        m.avatar = $('gm-av-preview').src;
        DB.save();
        this.renderMembers(g.members);
        App.b();
    },
    delMember() {
        let g = DB.getContact(this.gid);
        g.members.splice(this.curMemIdx, 1);
        DB.save();
        this.renderMembers(g.members);
        App.b();
    },
    del() {
         if(confirm("解散群聊？")) {
            DB.d.contacts = DB.d.contacts.filter(c => c.id != this.gid);
            DB.save();
            Contacts.render();
            App.h();
        }
    },
    async genWorld() { 
        let direction = prompt("请输入世界观方向 (例如: 赛博朋克, 校园日常)。\n点击取消则完全随机生成。");
        let p = DB.getPreset();
        if(!p || !p.key) return Toast.show("API未配置");
        
        Toast.show("正在构思世界观...");
        $('group-world-view').value = "AI正在撰写中...";
        
        let aiPrompt = "请生成一个群聊世界观/背景设定。";
        if (direction) {
            aiPrompt += ` 方向/主题: ${direction}。`;
        } else {
            aiPrompt += " 主题不限，请随机发挥创意。";
        }
        aiPrompt += " 要求：100字左右，生动有趣，包含环境描写和氛围设定。直接返回内容，不要废话。";
        
        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: [{role:'user', content: aiPrompt}], temperature: 0.9 })
            });
            let d = await res.json();
            let content = d.choices[0].message.content;
            $('group-world-view').value = content;
        } catch(e) {
            console.error(e);
            $('group-world-view').value = "生成失败，请重试";
        }
    }
};


// --- apps/chat.js --- 
const Chat = {
    cid: null, qM: null, narratorMode: false, narratorType: '3',
    async appendMsg(role, content, type='text', extra={}, skipRender=false) {
        let c = DB.getContact(this.cid);
        if(!c) return;
        c.history.push({
            role: role === 'ai' ? 'assistant' : (role === 'system' ? 'system' : 'user'),
            content: content,
            type: type,
            time: Date.now(),
            isRead: role === 'me' || role === 'system' || (Chat.cid === c.id && document.getElementById('sub-chat-room').classList.contains('active')),
            ...extra
        });
        await DB.save();
        if(!skipRender) {
            this.renderMessages(true);
            Contacts.render();
        }
    },
    toggleNarrator() {
        let c = DB.getContact(this.cid);
        if(!c) return;

        $('narrator-sel-modal').style.display = 'flex';
        
        // Reset styles
        ['btn-narrator-1', 'btn-narrator-3', 'btn-narrator-off'].forEach(id => {
            let el = $(id);
            if(el) {
                el.style.background = '#eee';
                el.style.color = '#333';
                el.style.border = 'none';
            }
        });

        // Highlight active based on contact's state
        if (c.narratorMode) {
            let activeId = c.narratorType === '1' ? 'btn-narrator-1' : 'btn-narrator-3';
            let el = $(activeId);
            if(el) {
                el.style.background = 'var(--accent)';
                el.style.color = 'white';
            }
        } else {
            let el = $('btn-narrator-off');
            if(el) {
                el.style.background = '#ff3b30';
                el.style.color = 'white';
            }
        }
    },
    setNarrator(type) {
        let c = DB.getContact(this.cid);
        if(!c) return;

        let box = $('narrator-icon-box');
        if (type === 'off') {
            c.narratorMode = false;
            $('narrator-indicator').style.display = 'none';
            if(box) { box.style.background = '#fff'; box.style.color = '#333'; }
            
            // Inject System Prompt to force mode switch
            this.appendMsg('system', '系统提示：用户已关闭旁白模式，请恢复正常聊天模式，不再输出动作描写。');
            
            Toast.show('已退出旁白模式');
        } else {
            c.narratorMode = true;
            c.narratorType = type;
            $('narrator-indicator').innerText = type === '1' ? '1st' : '3rd';
            $('narrator-indicator').style.display = 'inline';
            if(box) { box.style.background = 'var(--accent)'; box.style.color = 'white'; }
            Toast.show(`旁白模式开启 (${type=== '1' ? '第一人称' : '第三人称'})`);
        }
        DB.save();
        $('narrator-sel-modal').style.display = 'none';
        PlusMenu.t(); // Close drawer
    },
    showImg(src) { $('lightbox-img').src = src; $('image-lightbox').classList.add('show'); },
    hideImg() { $('image-lightbox').classList.remove('show'); },
    showTextModal(text) { $('text-modal-content').innerText = text; $('text-modal').style.display = 'flex'; },
    open(id) { 
        this.cid=id; 
        let c=DB.getContact(id); 
        c.lastActive = Date.now(); 

        // Mark all messages as read
        let hasUnread = false;
        (c.history||[]).forEach(m => {
            if (m.role === 'assistant' && !m.isRead) {
                m.isRead = true;
                hasUnread = true;
            }
        });
        if (hasUnread) {
            DB.save();
            Contacts.render();
        } else {
            DB.save();
        }

        let title = c.remark || c.name;
        $('chat-room-title').innerText = title;
        
        if (c.isGroup) {
            Appearance.resetS();
        } else {
            Appearance.applyCS(c); 
        }
        this.renderMessages(); 
        App.o('sub-chat-room'); 
        MultiSelect.cancel(); 
    },
    renderMessages(smooth = false) {
        try {
            let c=DB.getContact(this.cid), con=$('chat-messages');
            let bgImg=$('chat-bg-image'), bgGlass=$('chat-bg-layer');
            if(bgImg) { bgImg.style.backgroundImage = c.chatBg?`url(${c.chatBg})`:'none'; bgImg.style.opacity = 1; }
            if(bgGlass) { bgGlass.style.opacity = c.bgOpacity !== undefined ? c.bgOpacity : 1; }
            
            con.innerHTML = '';
            con.classList.toggle('chat-mode-select', MultiSelect.active);
            let history = c.history || [];
            let groups = [];
            let avDisplay = c.avatarDisplay || 'all'; // 'all', 'first', 'ai_only', 'me_only', 'none'

            if (history.length > 0) {
                let currentGroup = { role: history[0].role, msgs: [history[0]], indices: [0] };
                for (let i = 1; i < history.length; i++) {
                    let prev = history[i-1];
                    let curr = history[i];
                    
                    // Grouping logic:
                    // If 'all' (every message has avatar), we DO NOT group messages visually into one block with one avatar.
                    // So we force a new group for every message.
                    // Wait, 'all' means "Every message has avatar".
                    // 'first' means "Only first message in sequence has avatar" (which is the default grouping behavior).
                    
                    let shouldGroup = (curr.role === prev.role && (curr.time - prev.time < 3600000));
                    if (avDisplay === 'all') shouldGroup = false; // Force split if 'all'

                    if (shouldGroup) {
                        currentGroup.msgs.push(curr);
                        currentGroup.indices.push(i);
                    } else {
                        groups.push(currentGroup);
                        currentGroup = { role: curr.role, msgs: [curr], indices: [i] };
                    }
                }
                groups.push(currentGroup);
            }
            groups.forEach(group => {
                let isMe = group.role === 'user';
                let isSys = group.role === 'system';
                if (isSys) {
                    group.msgs.forEach((m, idxInGroup) => {
                        let div=document.createElement('div');
                        div.className='msg-group system';
                        if (MultiSelect.active) {
                            let globalIdx = group.indices[idxInGroup];
                            let chk = `<div class="msg-checkbox" id="chk-${globalIdx}" onclick="MultiSelect.toggle(${globalIdx}, event)" style="display:flex;margin-right:10px"></div>`;
                            div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'center';
                            div.innerHTML=`${chk}<div class="ts-badge">${m.content}</div>`;
                        } else {
                            div.style.display = 'flex'; div.style.justifyContent = 'center';
                            div.innerHTML=`<div class="ts-badge">${m.content}</div>`;
                        }
                        con.appendChild(div);
                    });
                    return;
                }

                let authorName = c.name;
                let avSrc = c.avatar || Utils.defAv;
                let memberId = null;

                if (isMe) {
                    avSrc = c.userAvatar || Utils.defAv;
                } else if (c.isGroup) {
                    let firstMsg = group.msgs[0];
                    if (firstMsg.avatar) avSrc = firstMsg.avatar;
                    if (firstMsg.name) authorName = firstMsg.name;
                    if (firstMsg.senderId) memberId = firstMsg.senderId;
                }

                let blockDiv = document.createElement('div');
                blockDiv.className = `msg-block ${isMe?'me':'ai'}`;
                let stackDiv = document.createElement('div');
                stackDiv.className = 'bubbles-stack';
                
                let renderedCount = 0;
                group.msgs.forEach((m, idxInGroup) => {
                    // Filter empty text messages
                    if (m.type === 'text' && (!m.content || !m.content.trim())) return;
                    renderedCount++;

                    let globalIdx = group.indices[idxInGroup];
                    let msgRow = document.createElement('div');
                    msgRow.style.display = 'flex'; msgRow.style.alignItems = 'center'; msgRow.style.width = '100%';
                    msgRow.style.justifyContent = isMe ? 'flex-end' : 'flex-start'; msgRow.style.gap = '5px';
                    
                    let bubbleDiv = document.createElement('div');
                    bubbleDiv.className = 'bubble';
                    bubbleDiv.id = `msg-${globalIdx}`;
                    let contentHTML = '';
                    let qText = m.quote;
                    if (qText && typeof qText === 'string' && qText.startsWith('data:')) qText = '[图片]';
                    let quoteHTML = qText ? `<div class="quote-ref">回复: ${Utils.esc(qText)}</div>` : '';
                    
                    if(m.type==='transfer') {
                         bubbleDiv.classList.add('transfer-bubble');
                         let statusTxt = m.status === 'accepted' ? '已收款' : (m.status === 'rejected' ? '已拒收' : '待确认');
                         contentHTML = `
                            <div style="display:flex;align-items:center">
                                <div class="transfer-icon">¥</div>
                                <div style="display:flex;flex-direction:column">
                                    <span class="transfer-amount">¥${m.amount}</span>
                                    <span class="transfer-desc">${Utils.esc(m.note || '转账给您')}</span>
                                </div>
                            </div>
                            <div class="transfer-status">${statusTxt}</div>
                         `;
                         quoteHTML = ''; 
                    } else if(m.type === 'transfer_receipt') {
                        bubbleDiv.classList.add('transfer-receipt-bubble');
                        contentHTML = `
                           <div style="display:flex;align-items:center;gap:10px">
                               <div class="receipt-icon">✓</div>
                               <div style="display:flex;flex-direction:column">
                                   <span style="font-size:14px;font-weight:bold">已收款</span>
                                   <span style="font-size:12px;opacity:0.8">¥${m.amount}</span>
                               </div>
                           </div>
                        `;
                        quoteHTML = '';
                    } else if(m.type === 'transfer_in') {
                        bubbleDiv.classList.add('transfer-bubble');
                        let statusTxt = '待确认';
                        let buttons = `<div style="display:flex;gap:10px;margin-top:10px;"><button class="btn-main" style="flex:1;background:var(--accent)" onclick="Chat.handleIncomingTransfer(${globalIdx}, 'accept')">接收</button><button class="btn-main" style="flex:1;background:#eee;color:#333" onclick="Chat.handleIncomingTransfer(${globalIdx}, 'reject')">拒收</button></div>`;
                        if (m.status === 'accepted') { statusTxt = '已收款'; buttons = ''; }
                        if (m.status === 'rejected') { statusTxt = '已拒收'; buttons = ''; }
                        contentHTML = `
                           <div style="display:flex;align-items:center">
                               <div class="transfer-icon" style="background:var(--accent-dark)">¥</div>
                               <div style="display:flex;flex-direction:column">
                                   <span class="transfer-amount">¥${m.amount}</span>
                                   <span class="transfer-desc">${Utils.esc(m.note || '转账给您')}</span>
                               </div>
                           </div>
                           <div class="transfer-status">${statusTxt}</div>
                           ${buttons}
                        `;
                    } else if(m.type==='emoticon') {
                        let s = (DB.d.emoticons || []).find(x => x.name === m.content);
                        if (s) {
                            contentHTML = `<img src="${s.url}" class="emoticon-img">`;
                        } else {
                            contentHTML = `[表情: ${Utils.esc(m.content)}]`;
                        }
                    } else if(m.type==='image'||(m.content&&m.content.startsWith('data:'))) {
                         if (m.emoticonName) {
                             // Legacy support for old data
                             contentHTML = `<img src="${m.content}" class="emoticon-img">`;
                         } else if (m.content && (m.content.startsWith('data:') || m.content.startsWith('http'))) {
                             // Real Image (Base64 or URL) -> Show directly
                             contentHTML = `<img src="${m.content}" class="chat-img" onclick="Chat.showImg(this.src)" style="cursor:pointer">`;
                         } else {
                             // Simulated Image (SVG Icon)
                             bubbleDiv.classList.add('img-text-wrapper');
                             // Using a nice SVG for "Photo"
                             contentHTML = `<img src="${Utils.maskUrl}" class="img-text-mask">`;
                         }
                    } else if(m.type==='image-text') {
                         bubbleDiv.classList.add('img-text-wrapper');
                         contentHTML = `<img src="${Utils.maskUrl}" class="img-text-mask">`;
                    } else if(m.type==='voice') {
                         let dur = m.duration || Math.max(1, Math.round(m.content.length * 0.3));
                         contentHTML = `<div style="display:flex;align-items:center;gap:5px;cursor:pointer" onclick="Chat.toggleVoice(this, '${Utils.esc(m.content)}')">${SVG_ICONS.voice} <span class="voice-txt">${dur}s</span></div>`;
                    } else {
                         contentHTML = Utils.esc(m.content);
                    }
                    bubbleDiv.innerHTML = quoteHTML + contentHTML;
                    
                    if(!m.recalled) {
                        bubbleDiv.oncontextmenu = (e)=>{e.preventDefault();ContextMenu.show(e,globalIdx)};
                        let pressTimer;
                        bubbleDiv.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => { ContextMenu.show(e.touches[0], globalIdx); }, 1500); });
                        bubbleDiv.addEventListener('touchend', () => clearTimeout(pressTimer));
                    }
                    if(m.type==='image-text') bubbleDiv.onclick = function(){ Chat.showTextModal(m.content); };
                    if(m.type==='image') {
                        if(m.emoticonName) {
                             bubbleDiv.onclick = function() { Chat.showImg(m.content); };
                        } else if (m.content && (m.content.startsWith('data:') || m.content.startsWith('http'))) {
                             bubbleDiv.onclick = function() { Chat.showImg(m.content); };
                        } else {
                             // Simulated image click -> show description (content)
                             bubbleDiv.onclick = function() { Chat.showTextModal("【图片描述】\n" + m.content); };
                        }
                    }
                    
                    if(m.blocked) {
                         let icon = document.createElement('div'); icon.className = 'blocked-icon'; icon.innerText = '!';
                         msgRow.appendChild(icon); msgRow.appendChild(bubbleDiv);
                    } else { msgRow.appendChild(bubbleDiv); }
                    stackDiv.appendChild(msgRow);
                    if (Date.now() - m.time < 2000) bubbleDiv.classList.add('new-bubble');
                });
                let lastMsg = group.msgs[group.msgs.length - 1];
                let footerHTML = '';
                let timeStr = Utils.timeStr(lastMsg.time);

                if (c.isGroup && !isMe) {
                    let authorNameDiv = `<div style="font-size: calc(12px * var(--app-font-scale)); color:#999; margin-left: 5px; margin-bottom: 2px;">${authorName}</div>`;
                    stackDiv.insertAdjacentHTML('afterbegin', authorNameDiv);
                }

                if (isMe) {
                    let delay = Math.floor(Math.random() * 1500) + 1000;
                    if (!lastMsg.isRead && !lastMsg.blocked) {
                        setTimeout(() => {
                           let freshC = DB.getContact(Chat.cid);
                           if(freshC) {
                               let target = freshC.history.find(m => m.time === lastMsg.time);
                               if(target) { 
                                   target.isRead = true; 
                                   DB.save();
                                   if(Chat.cid === freshC.id) {
                                        let mEl = document.getElementById(`msg-${group.indices[group.indices.length-1]}`);
                                        if(mEl) {
                                            let stack = mEl.parentNode.parentNode;
                                            let footer = stack.querySelector('.msg-footer-row'); 
                                            if(footer && !footer.querySelector('.read-status')) {
                                                let s = document.createElement('span'); s.className='read-status'; s.innerText='已读';
                                                footer.prepend(s);
                                            }
                                        }
                                   }
                               }
                           }
                        }, delay);
                    }
                    let readStatus = lastMsg.isRead ? '<span class="read-status">已读</span>' : '';
                    footerHTML = `<div class="msg-footer-row">${readStatus}<span>${timeStr}</span></div>`;
                } else { footerHTML = `<div class="msg-footer-row"><span>${timeStr}</span></div>`; }
                
                if (MultiSelect.active) {
                    group.msgs.forEach((m, idxInGroup) => {
                       if (m.type === 'text' && (!m.content || !m.content.trim())) return;
                       let div = document.createElement('div'); div.className = `msg-block ${isMe?'me':'ai'}`;
                       
                       let contentHTML = '';
                       if(m.type==='transfer' || m.type === 'transfer_in') {
                            contentHTML = `[转账] ¥${m.amount}`;
                       } else if(m.type==='image'||(m.content&&m.content.startsWith('data:'))) {
                            contentHTML = `<img src="${m.content}" class="${m.emoticonName?'emoticon-img':'chat-img'}" style="max-width:100px;max-height:100px;pointer-events:none">`;
                       } else if(m.type==='image-text') {
                            contentHTML = `[图文] ${Utils.esc(m.content)}`;
                       } else if(m.type==='voice') {
                            contentHTML = `[语音] ${m.duration}s`;
                       } else {
                            contentHTML = Utils.esc(m.content);
                       }

                       let bubble = `<div class="bubble">${contentHTML}</div>`;
                       let chk = `<div class="msg-checkbox" id="chk-${group.indices[idxInGroup]}" onclick="MultiSelect.toggle(${group.indices[idxInGroup]}, event)" style="display:flex"></div>`;
                       div.innerHTML = `${chk}<img src="${avSrc}" class="msg-avatar">${bubble}`;
                       con.appendChild(div);
                    });
                    return; 
                }
                let showAvatar = true;
                if (avDisplay === 'none') showAvatar = false;
                else if (avDisplay === 'ai_only' && isMe) showAvatar = false;
                else if (avDisplay === 'me_only' && !isMe) showAvatar = false;

                if (showAvatar) {
                    let avImg = document.createElement('img'); avImg.src = avSrc; avImg.className = 'msg-avatar';
                    if (c.isGroup && !isMe && memberId) {
                        avImg.style.cursor = 'pointer';
                        avImg.onclick = () => CharStatus.show(memberId);
                    } else if (!isMe) {
                         avImg.style.cursor = 'pointer';
                         avImg.onclick = () => CharStatus.show();
                    }
                    blockDiv.appendChild(avImg);
                }
                
                if (renderedCount > 0) {
                    let footerDiv = document.createElement('div'); footerDiv.innerHTML = footerHTML;
                    stackDiv.appendChild(footerDiv); blockDiv.appendChild(stackDiv); con.appendChild(blockDiv);
                }
            });
            if (smooth) {
                setTimeout(() => {
                    con.scrollTo({ top: con.scrollHeight, behavior: 'smooth' });
                }, 10);
            } else {
                con.scrollTop = con.scrollHeight;
            }
        } catch(e) { console.error(e); }
    },
    async send(content=null, type='text', extra={}) {
        let el=$('chat-input'), txt=el.value.trim();
        if(type === 'text' && !txt && !content) return;
        
        let c=DB.getContact(this.cid);
        let msgContent = (type === 'text' && !content) ? txt : content;
        
        if (c.isGroup) {
            let sender = {
                type: 'user',
                name: DB.d.ownerProfile?.name || 'Me',
                avatar: c.userAvatar || DB.d.ownerProfile?.avatar || ''
            };
            GM.sendMessage(c.id, sender, msgContent, type, extra);
            el.value=''; this.cancelQ(); this.renderMessages(); Contacts.render();
            return;
        }

        if (c.isBlockedByAi || c.isBlocked) {
            let msg = {role:'user',content:msgContent,time:Date.now(),quote:this.qM, type, isRead: false, blocked: true, ...extra};
            c.history.push(msg);
            let sysMsg = {role:'system', content:c.isBlockedByAi?'你还不是对方的好友。 <span style="color:var(--accent);cursor:pointer;font-weight:bold" onclick="Chat.applyFriend()">发送好友申请</span>':'消息已发出，但被拒收。', time:Date.now() + 10};
            c.history.push(sysMsg);
            await DB.save(); el.value=''; this.cancelQ(); this.renderMessages(); Contacts.render();
            return;
        }
        let msg = {role:'user',content:msgContent,time:Date.now(),quote:this.qM, type, isRead: false, ...extra};
        c.history.push(msg);
        await DB.save(); el.value=''; this.cancelQ(); this.renderMessages(); Contacts.render();
        
    },
    startTransfer() {
        PlusMenu.t(); // Close drawer
        Transfer.open();
    },
    async triggerBackgroundAI(cid, context) {
        let c = DB.getContact(cid);
        let p = DB.getPreset();
        if (!c || !p || !p.key) { Toast.show("亲密付: 请先配置API"); return; }

        // Insert System Notification
        c.history.push({role: 'system', content: context, time: Date.now()});
        await DB.save();

        // Construct history
        let history = c.history.slice(-15).filter(m => m.role !== 'system').map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.content
        }));

        let sys = `You are ${c.name}. Persona: ${c.charPersona}.
        User Persona: ${c.userPersona || 'Unknown'}.
        Task: User used your 'Affinity Pay' (spent your money). You just got a notification.
        Reply to the user immediately about this transaction.
        
        CRITICAL: At the very end of your response, you MUST append your current status in this XML format:
        <status>
          <loc>Location</loc>
          <cloth>Outfit</cloth>
          <mind>Inner thoughts about user</mind>
          <mood>Current mood</mood>
          <pose>Current posture</pose>
        </status>`;

        // Crucial: Put the event as a USER message to force a response
        let triggerMsg = {
            role: 'user',
            content: `[SYSTEM NOTIFICATION]: ${context}\n(User spent your money just now. Send a message to User reacting to this.)`
        };

        let msgs = [{role:'system', content: sys}, ...history, triggerMsg];

        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({
                    model: p.model,
                    messages: msgs,
                    temperature: 0.8
                })
            });
            if (!res.ok) throw new Error(`API Error ${res.status}`);
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            if (reply) {
                // Parse Status (XML)
                let parsed = parseXmlReply(reply);
                if (parsed.status) {
                    c.status = parsed.status;
                    // Remove status block from raw text if it was appended
                    reply = reply.replace(/<status>[\s\S]*?<\/status>/, '').trim();
                }

                // Parser Logic (Same as Chat.triggerAI)
                let parts = reply.split('\n').filter(r => r.trim());
                for (let part of parts) {
                    c.history.push({role: 'assistant', content: part.trim(), time: Date.now(), isRead: false});
                }
                await DB.save();
                Toast.show(`收到 ${c.name} 的消息`);
                Contacts.render(); 
            }
        } catch(e) {
            console.error("Background AI Error", e);
            Toast.show("AI响应失败: " + e.message);
        }
    },
    handleIncomingTransfer(msgIndex, action) {
        let c = DB.getContact(this.cid);
        let msg = c.history[msgIndex];
        if (!msg || msg.status !== 'pending') return;

        if (action === 'accept') {
            msg.status = 'accepted';
            DB.d.myWallet += msg.amount; 
            c.history.push({role: 'user', type:'transfer_receipt', amount: msg.amount, content:'已收款', time: Date.now()});
        } else {
            msg.status = 'rejected';
            c.history.push({role: 'system', content: `您已拒收 转账`, time: Date.now()});
        }
        DB.save().then(() => {
            this.renderMessages();
        });
    },
    applyFriend() {
        let reason = prompt("请输入申请理由:", "我是User");    
        if (reason === null) return;
        let c = DB.getContact(this.cid);
        c.history.push({role:'system', content:`已发送好友申请: ${reason}`, time:Date.now()});
        DB.save();
        this.renderMessages();
        this.triggerAI(`[SYSTEM: User requests to add you as a friend. Reason: "${reason}". Decide based on history. Reply [FRIEND_ACC] to accept, or [FRIEND_REJ] to reject.]`, true);      
    },
    handleSendBtn() { let v = $('chat-input').value.trim(); if(v) this.send(); else this.triggerAI(); },
    async triggerAI(extraContext = '', force = false) {        
        let currentCid = this.cid;
        let c=DB.getContact(currentCid), p=DB.getPreset();     
        if ((c.isBlocked || c.isBlockedByAi) && !force) return;

        if(!p.key) { alert("请先配置api"); return; }

        if (Chat.cid === currentCid) $('chat-room-title').innerText = '正在输入中...';

        if (c.isGroup) {
            // Use Group Director
            GM.triggerGroupDirector(c.id, {
                content: extraContext || "[User triggered regeneration/continuation]",
                type: 'user' // Simulation
            });
            if (Chat.cid === currentCid) $('chat-room-title').innerText = c.remark || c.name;
            return;
        }

        // Find ALL pending transfers from user
        let pendingTransfers = c.history.filter(m => m.role === 'user' && m.type === 'transfer' && m.status === 'pending');
        let transferCtx = '';
        if(pendingTransfers.length > 0) {
            let details = pendingTransfers.map((t, i) => `${i+1}. ¥${t.amount} (${t.note})`).join(', ');
            transferCtx = `[SYSTEM: User sent ${pendingTransfers.length} pending transfers: ${details}.
            To accept a transfer, output [TX_ACC]. To reject, output [TX_REJ].
            Output one tag per transfer you want to process.
            Example: To accept 2 transfers, output "[TX_ACC] [TX_ACC]".]`;
        }

        let wTxt = DB.d.world.filter(w => w.isGlobal || (c.worldIds||[]).includes(w.id)).map(w => w.content).join('\n');
        let statusCtx = c.hasUserCheckedStatus ? `[System: User刚刚查看了你的位置和状态]` : ''; if(c.hasUserCheckedStatus) c.hasUserCheckedStatus = false;
        let timeAware = $('set-ai-time-aware').checked ? `Current Time: ${new Date().toLocaleString()}` : '';
        let weatherInfo = `[Current Weather: ${Weather.current || 'Unknown'}]`;
        
        // LifeOS Integration
        let periodCtx = LifeOS.getPeriodPrompt ? LifeOS.getPeriodPrompt() : '';
        let goalCtx = LifeOS.getGoalPrompt ? LifeOS.getGoalPrompt(c.id) : '';

        let baseSys = SYS_IDENTITY;
        
        let narratorInst = '';
        if (c.narratorMode) {
            let per = c.narratorType === '1' ? '第一人称' : '第三人称';
            narratorInst = SYS_NARRATOR.replace('{{PERSPECTIVE}}', per).replace(/{{CHAR_NAME}}/g, c.name);
        } else {
            narratorInst = `[SYSTEM: NORMAL CHAT MODE. Do NOT use narrator style. Do NOT describe actions. Only spoken words.]`;
        }

        let emoticonNames = (DB.d.emoticons || []).map(s => s.name).join(', ');
        let emoticonCtx = emoticonNames ? `[Available Emoticons: ${emoticonNames}. To send one, output <msg type="emoticon">emoticon_name</msg>]` : '';
        
        let personaStr = `Name:${c.name}\nPersona:${c.charPersona}\nUser:${c.userPersona}`;
        if (baseSys.includes('{{PERSONA}}')) {
            baseSys = baseSys.replace('{{PERSONA}}', personaStr);
            personaStr = '';
        }

        let sys=`${baseSys}\n${narratorInst}\n${timeAware}\n${weatherInfo}\n${periodCtx}\n${goalCtx}\n${personaStr}\nDiary:${c.diary||''}\nStatus:${JSON.stringify(c.status||{})}\n${statusCtx}\nWorld:${wTxt}\nSummary:${c.summary||'无'}\n${transferCtx}\n${emoticonCtx}\n\n${SYS_GUARDRAILS}`;

        let contextLimit = c.contextLimit || 20;
        
        // Include recent history for context
        let recentHistory = c.history.slice(-10).map(m => `${m.role}: ${m.content}`).join('\n');

        let msgs=[{role:'system',content:sys}, ...c.history.slice(-contextLimit).filter(h=>h.role!=='system').map(h=>{
            if (h.type === 'image' && !h.emoticonName && h.content && (h.content.startsWith('data:') || h.content.startsWith('http'))) {
                return {
                    role: h.role === 'user' ? 'user' : 'assistant',
                    content: [
                        { type: "image_url", image_url: { url: h.content, detail: "low" } }
                    ]
                };
            }
            return {
                role:h.role==='user'?'user':'assistant',
                content: h.emoticonName ? `{{emoticon:${h.emoticonName}}}` :
                     (h.type==='transfer' ? `[Transfer to Char: ${h.amount}]` :
                     (h.type==='transfer_in' ? `[Transfer to User: ${h.amount}, Status: ${h.status}]` :
                     (h.type==='transfer_receipt' ? `[System: User received transfer of ${h.amount}]` :
                     (h.content && h.content.startsWith('data:') ?
                        "[图片]"
                        : h.content))))
            };
        })];
        if (extraContext) {
            msgs.push({ role: 'user', content: extraContext });
        }
        this.showTyping();

        try {
            let res=await fetch(`${p.url}/chat/completions`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${p.key}`},body:JSON.stringify({model:p.model,messages:msgs, temperature: p.temperature || 0.7, stream: true})});
            if (!res.ok) {
                let errText = `API Error: ${res.status}`;
                try {
                    let errData = await res.json();
                    if(errData.error && errData.error.message) {
                        errText += ` - ${errData.error.message}`;
                    } else {
                        errText += ` - ${JSON.stringify(errData)}`;
                    }
                } catch(e) {
                    try {
                        let text = await res.text();
                        if(text) errText += ` - ${text.substring(0, 100)}`;
                    } catch(e2) {}
                }
                throw new Error(errText);
            }
            const reader = res.body.getReader(); const decoder = new TextDecoder("utf-8"); let fullText = ""; let streamBuffer = "";
            while (true) {
                const { done, value } = await reader.read(); if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                streamBuffer += chunk;

                let newlineIndex;
                while ((newlineIndex = streamBuffer.indexOf('\n')) >= 0) {
                    const line = streamBuffer.slice(0, newlineIndex).trim();
                    streamBuffer = streamBuffer.slice(newlineIndex + 1);

                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        if (jsonStr === '[DONE]') continue;
                        try {
                            const data = JSON.parse(jsonStr);
                            const content = data.choices?.[0]?.delta?.content;
                            if (content) fullText += content;
                        } catch (e) { console.error('Stream Parse Error', e); }
                    }
                }
            }

            if (!fullText.trim()) {
                this.hideTyping();
                Toast.show("AI响应为空");
                if (Chat.cid === currentCid) $('chat-room-title').innerText = c.remark || c.name;
                return;
            }

            let replyRaw = fullText;

            const avatarRegex = /\[SET_AVATAR(?::\s*(\d+))?\]/i;
            let avatarMatch = replyRaw.match(avatarRegex);

            if (avatarMatch) {
                let backIndex = avatarMatch[1] ? parseInt(avatarMatch[1]) : 1;
                // Filter for real images (Base64 or URL), excluding emoticons and simulated text-images
                let validImages = c.history.slice().reverse().filter(m =>
                    m.role === 'user' &&
                    m.type === 'image' &&
                    !m.emoticonName &&
                    m.content &&
                    (m.content.startsWith('data:') || m.content.startsWith('http') || m.content.startsWith('blob:'))
                );

                if (validImages.length > 0 && backIndex > 0 && backIndex <= validImages.length) {
                    let targetImg = validImages[backIndex - 1];
                    if (targetImg && targetImg.content) {
                        c.avatar = targetImg.content;
                        await DB.save();
                        Contacts.render();
                        Chat.renderMessages();
                        replyRaw = replyRaw.replace(avatarMatch[0], '').trim();
                        Toast.show(`对方已更换为倒数第 ${backIndex} 张图片`);
                    } else {
                        replyRaw = replyRaw.replace(avatarMatch[0], '').trim();
                        Toast.show('图片数据无效');
                    }
                } else {
                    replyRaw = replyRaw.replace(avatarMatch[0], '').trim();
                    Toast.show('未找到有效图片 (仅支持真实图片)');
                }
            }

            if(replyRaw.includes('[FRIEND_ACC]')) {
                replyRaw = replyRaw.replace(/\[FRIEND_ACC\]/g, '');
                c.isBlockedByAi = false;
                c.history.push({role:'system', content:'对方通 过了你的好友请求。', time:Date.now()});
                await DB.save();
                this.renderMessages();
            } else if (replyRaw.includes('[FRIEND_REJ]')) {
                replyRaw = replyRaw.replace(/\[FRIEND_REJ\]/g, '');
            }

            // Handle Multiple Transfers
            let accMatches = replyRaw.match(/\[TX_ACC\]/g) || [];
            let rejMatches = replyRaw.match(/\[TX_REJ\]/g) || [];
            replyRaw = replyRaw.replace(/\[TX_ACC\]/g, '').replace(/\[TX_REJ\]/g, '');

            let currentPending = c.history.filter(m => m.role === 'user' && m.type === 'transfer' && m.status === 'pending');
            
            // Process Accepts
            for (let i = 0; i < accMatches.length; i++) {
                if (currentPending.length > 0) {
                    let t = currentPending.shift(); // Process oldest first
                    t.status = 'accepted';
                    await this.appendMsg('ai', '已收款', 'transfer_receipt', {amount: t.amount}, true);
                }
            }
            
            // Process Rejects
            for (let i = 0; i < rejMatches.length; i++) {
                if (currentPending.length > 0) {
                    let t = currentPending.shift();
                    t.status = 'rejected';
                    DB.d.myWallet += t.amount;
                    c.history.push({role:'system', content:`对方拒绝了转账，¥${t.amount} 已退回`, time:Date.now()});
                }
            }
            
            if (accMatches.length > 0 || rejMatches.length > 0) {
                await DB.save();
                this.renderMessages();
            }

            // 1. Extract and Remove Status (XML)
            let parsed = parseXmlReply(replyRaw);
            if (parsed.status) {
                c.status = parsed.status;
                if(c.autoThought && c.status.mind) Toast.show(`💭 心 声: ${c.status.mind}`, 4000);
                // Remove status block from raw text if it was appended
                replyRaw = replyRaw.replace(/<status>[\s\S]*?<\/status>/, '').trim();
            }

            // 2. Handle Block
            if(replyRaw.includes('[BLOCK]')) { 
                if(c.allowAiBlock) { c.isBlockedByAi = true; Toast.show('对方已将你拉黑'); } 
                replyRaw = replyRaw.replace('[BLOCK]','').trim(); 
            }

            // 3. Try XML Parsing (New Standard)
            let isXml = false;
            // Simple check if it looks like XML
            if (replyRaw.includes('<reply>') || replyRaw.includes('<msg')) {
                try {
                    let parsed = parseXmlReply(replyRaw);
                    let messages = parsed.reply;
                    
                    if (messages && messages.length > 0) {
                        isXml = true;
                        let isFirstMsg = true;
                        
                        for (let msg of messages) {
                            let delay = Math.floor(Math.random() * 1500) + 500;
                            
                            if (isFirstMsg) {
                                await new Promise(res=>setTimeout(res, delay));
                                let indicator = $('chat-typing-indicator');
                                if(indicator) {
                                    // If text, update bubble. If not, remove indicator and append new.
                                    if (msg.type === 'text') {
                                        let bub = indicator.querySelector('.bubble');
                                        let qText = msg.quote;
                                        if (qText && typeof qText === 'string' && qText.startsWith('data:')) qText = '[图片]';
                                        let quoteHTML = qText ? `<div class="quote-ref">回复: ${Utils.esc(qText)}</div>` : '';
                                        if(bub) bub.innerHTML = quoteHTML + Utils.esc(msg.content);
                                        indicator.removeAttribute('id'); // Convert to normal bubble
                                        await this.appendMsg('ai', msg.content, 'text', { quote: msg.quote }, true);
                                    } else {
                                        this.hideTyping();
                                        await this.appendMsg('ai', msg.content, msg.type, { quote: msg.quote });
                                    }
                                } else {
                                    await this.appendMsg('ai', msg.content, msg.type, { quote: msg.quote });
                                }
                                isFirstMsg = false;
                                continue;
                            }

                            this.showTyping();
                            await new Promise(res=>setTimeout(res, delay));
                            this.hideTyping();

                            if (msg.type === 'text') {
                                const voiceMatch = msg.content.match(/\[VOICE:\s*(.*?)\]/);
                                const transferMatch = msg.content.match(/\[TRANSFER:\s*(\d+(?:\.\d+)?)\s*(?:,\s*(.+?))?\]/);
                                
                                if(voiceMatch) {
                                    let vText = voiceMatch[1];
                                    let dur = Math.max(1, Math.round(vText.length * 0.3));
                                    await this.appendMsg('ai', vText, 'voice', {duration: dur});
                                } else if(transferMatch) {
                                    const amount = parseFloat(transferMatch[1]);
                                    const note = transferMatch[2] || '转账';
                                    await this.appendMsg('ai', '', 'transfer_in', { amount, note, status: 'pending' });
                                } else {
                                    await this.appendMsg('ai', msg.content, 'text', { quote: msg.quote });
                                }
                            } else {
                                await this.appendMsg('ai', msg.content, msg.type, { quote: msg.quote });
                            }
                        }
                        this.hideTyping(); // Cleanup if anything left
                    }
                } catch (e) { console.log("XML Parse Failed", e); }
            }

            // 4. Fallback to Text Parsing (Old Logic)
            if (!isXml) {
                let parts = replyRaw.split(/(\[TRANSFER:\s*\d+(?:\.\d+)?\s*(?:,\s*.+?)?\])/g);
                let isFirstMsg = true;

                for (let part of parts) {
                    part = part.trim();
                    if (!part) continue;

let transferMatch = /\[TRANSFER:\s*(\d+(?:\.\d+)?)\s*(?:,\s*(.+?))?\]/.exec(part);

                    if (transferMatch) {
                        if(isFirstMsg) { this.hideTyping(); isFirstMsg=false; }
                        const amount = parseFloat(transferMatch[1]);
                        const note = transferMatch[2] || '转账';
                        c.history.push({ role: 'assistant', type: 'transfer_in', amount, note, status: 'pending', time: Date.now() });
                        this.renderMessages();
                        await DB.save();
                    } else {
                        let rawChunks = part.split('\n').filter(t => t.trim().length > 0);
                        let chunks = [];
                        rawChunks.forEach(rc => { chunks.push(...Utils.splitText(rc.trim())); });
                        
                        for(let chunk of chunks) {
                            chunk = chunk.trim();
                            if (!chunk) continue;
                            
                            const voiceMatch = chunk.match(/\[VOICE:\s*(.*?)\]/);
                            const emoticonMatch = chunk.match(/^\{\{emoticon:(.+?)\}\}$/);

                            if(voiceMatch) {
                                if(isFirstMsg) { this.hideTyping(); isFirstMsg=false; }
                                let vText = voiceMatch[1];
                                let dur = Math.max(1, Math.round(vText.length * 0.3));
                                await this.appendMsg('ai', vText, 'voice', {duration: dur});
                                c.lastVoiceTurn = c.history.length;
                            } else if (emoticonMatch) {
                                if(isFirstMsg) { this.hideTyping(); isFirstMsg=false; }
                                let sName = emoticonMatch[1];
                                let s = (DB.d.emoticons || []).find(x => x.name === sName);
                                if (s) {
                                    await this.appendMsg('ai', s.url, 'image', {emoticonName: s.name});
                                }
                            } else {
                                if(isFirstMsg) {
                                    this.hideTyping();
                                    isFirstMsg=false;
                                }
                                await this.appendMsg('ai', chunk);
                            }
                            // Fallback delay 500ms - 2000ms
                            await new Promise(res=>setTimeout(res, 500 + Math.random() * 1500));
                        }
                    }
                }
            }
            this.hideTyping();
            if (Chat.cid === currentCid) $('chat-room-title').innerText = c.remark || c.name;
        } catch(e){
            this.hideTyping();
            if (Chat.cid === currentCid) $('chat-room-title').innerText = c.remark || c.name;
            console.error(e);
            
            // Error Feedback: Send as bubble
            let errInfo = e.message || "未知错误";
            if(errInfo.includes('401')) errInfo += " (Key无效)";
            if(errInfo.includes('404')) errInfo += " (模型不存在)";
            // if(errInfo.includes('429')) errInfo += " (额度不足)";
            if(errInfo.includes('Failed to fetch')) errInfo += " (网络连接失败/跨域)";
            
            c.history.push({role:'system', content:`⚠️ [系统报错] ${errInfo}`, time:Date.now()});
            await DB.save();
            this.renderMessages();
        }
    },
    toggleVoice(el, text) { let span = el.querySelector('.voice-txt'); if(!span) return; if(span.innerText.includes('s')) { el.dataset.dur = span.innerText; span.innerText = text; } else { span.innerText = el.dataset.dur; } },
    
    clearHist() { if(confirm("清空当前聊天记录？人设将保留。")) { let c=DB.getContact(this.cid); c.history=[]; c.status={}; delete c.summary; c.isBlocked = false; c.isBlockedByAi = false; DB.save().then(()=>{this.renderMessages();Contacts.render();Toast.show("已重置聊天");}); } },
    setQ(t) { this.qM=t; $('quote-preview').classList.add('active'); $('quote-text-content').innerText="回复: "+t; },
    cancelQ() { this.qM=null; $('quote-preview').classList.remove('active'); },
    showTyping() {
        if($('chat-typing-indicator')) return;
        let c = DB.getContact(this.cid);
        let div = document.createElement('div');
        div.id = 'chat-typing-indicator';
        div.className = 'msg-block ai new-msg';
        div.innerHTML = `<img src="${c.avatar||Utils.defAv}" class="msg-avatar"><div class="bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
        $('chat-messages').appendChild(div);
        $('chat-messages').scrollTop = $('chat-messages').scrollHeight;
    },
    hideTyping() {
        let el = $('chat-typing-indicator');
        if(el) el.remove();
        // Safety cleanup: Remove any remaining typing indicators
        document.querySelectorAll('.typing-indicator').forEach(el => {
            let block = el.closest('.msg-block');
            if (block) block.remove();
        });
    }
};

const CharStatus = {
    targetId: null,
    show(memberId = null) { 
        this.targetId = memberId;
        $('char-status-modal').classList.add('active'); 
        this.render(); 
    },
    hide() { $('char-status-modal').classList.remove('active'); this.targetId = null; },
    render() {
        let c = DB.getContact(Chat.cid);
        if(!c) return;
        
        let name = c.name;
        let avatar = c.avatar || Utils.defAv;
        let status = c.status || {};

        if (c.isGroup && this.targetId) {
            let m = c.members.find(m => m.id === this.targetId);
            if (m) {
                name = m.name;
                avatar = m.avatar || Utils.defAv;
                // Member status needs to be stored/fetched?
                // Currently only main contact has 'status' field.
                // If member doesn't have status, we might need to fetch it or show empty.
                // For now, let's assume status is on the member object if we implement per-member status.
                // But `refresh` logic updates `c.status`.
                // We need to support per-member status.
                status = m.status || {}; 
            }
        }

        $('char-status-avatar').src = avatar;
        $('char-status-title').innerText = name;
        
        $('disp-loc').innerText = status.loc || '--';
        $('disp-cloth').innerText = status.cloth || '--';
        $('disp-mind').innerText = status.mind || '--';
        $('disp-mood').innerText = status.mood || '--';
        $('disp-pose').innerText = status.pose || '--';
    },
    // Status Refresh Fixed
    async refresh() {
        Toast.show("正在连接AI获取状态...");
        let c = DB.getContact(Chat.cid);
        if (!c) return;
        
        let targetName = c.name;
        let targetPersona = c.charPersona;
        let targetMember = null;

        if (c.isGroup && this.targetId) {
            targetMember = c.members.find(m => m.id === this.targetId);
            if(targetMember) {
                targetName = targetMember.name;
                targetPersona = targetMember.persona;
            }
        }

        let context = `[SYSTEM: User pressed 'Refresh Status' button. Please describe your current status (activity, location, mood, outfit) based on the current time and your persona.
        Important:
        1. **LOCATION CONTINUITY**: Check the very last few messages. Where are you currently? If the plot is at User's home, you MUST be at User's home. Do NOT teleport to your own home unless you explicitly left.
        2. Reflect the recent chat history and plot.
        3. The 'mind' field in STATUS must be a short **1st person inner monologue** (approx 50 characters). Example: "I wonder what he is thinking..." NOT "She wondered...".
        4. You MUST append your status in XML format at the end:
        <status>
          <loc>Location</loc>
          <cloth>Outfit</cloth>
          <mind>Inner monologue (1st person)</mind>
          <mood>Mood</mood>
          <pose>Pose</pose>
        </status>]`;
        
        let p = DB.getPreset();
        if(!p || !p.key) return Toast.show("API未配置");
        
        // Use Actual Message Objects for context
        let msgs = [
            {role:'system', content: `You are ${targetName}. Persona: ${targetPersona}. Time: ${new Date().toLocaleString()}.`}
        ];
        
        // Append last 15 messages
        let history = c.history.slice(-15).filter(m => m.role !== 'system').map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.content
        }));
        msgs = msgs.concat(history);
        
        // Append trigger instruction
        msgs.push({role:'user', content: context});
        
        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: msgs, temperature: 0.8 })
            });
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            let parsedStatus = parseStatusFromXml(reply);
            if (parsedStatus) {
                try {
                    let newStatus = {loc:parsedStatus.loc, cloth:parsedStatus.cloth, mind:parsedStatus.mind, mood:parsedStatus.mood, pose:parsedStatus.pose};
                    
                    if (targetMember) {
                        targetMember.status = newStatus;
                    } else {
                        c.status = newStatus;
                    }
                    
                    DB.save();
                    CharStatus.render();
                    Toast.show("状态刷新成功");
                } catch (e) { console.error(e); Toast.show("状态解析错误"); }
            } else {
                Toast.show("AI未返回状态数据，请重试");
            }
        } catch(e) {
            console.error(e);
            Toast.show("网络请求失败: " + e.message);
        }
    }
};

const MultiSelect = {
    active: false,
    selected: new Set(),
    cancel() { 
        this.active=false; 
        this.selected.clear();
        $('multi-select-bar').style.display='none'; 
        Chat.renderMessages(); 
    },
    toggle(idx, e) {
        if(e) e.stopPropagation();
        if(this.selected.has(idx)) this.selected.delete(idx);
        else this.selected.add(idx);
        
        let el = $(`chk-${idx}`);
        if(el) el.classList.toggle('checked', this.selected.has(idx));
        $('select-count').innerText = `已选 ${this.selected.size}`;
    },
    selectAll() {
        let c = DB.getContact(Chat.cid);
        if(!c || !c.history) return;
        if(this.selected.size === c.history.length) {
            this.selected.clear();
        } else {
            c.history.forEach((_, i) => this.selected.add(i));
        }
        Chat.renderMessages();
        $('select-count').innerText = `已选 ${this.selected.size}`;
    },
    deleteSelected() {
        if(this.selected.size === 0) return;
        if(confirm(`确定删除选中的 ${this.selected.size} 条消息吗?`)) {
            let c = DB.getContact(Chat.cid);
            // Delete from end to start to avoid index shifting issues
            let sortedIndices = Array.from(this.selected).sort((a,b) => b-a);
            sortedIndices.forEach(i => {
                if(c.history[i]) c.history.splice(i, 1);
            });
            DB.save();
            this.cancel();
            Toast.show("已批量删除");
        }
    }
};

const Transfer = {
    selectedSource: 'wallet', // 'wallet' or contactId
    open() {
        $('transfer-modal').style.display = 'flex';
        setTimeout(() => $('transfer-modal').querySelector('.plus-menu-drawer').style.transform = 'translateY(0)', 10);
        this.renderSources();
        $('tf-amount').value = '';
        $('tf-note').value = '';
        this.validate();
        $('tf-amount').focus();
    },
    close() {
        let el = $('transfer-modal').querySelector('.plus-menu-drawer');
        el.style.transform = 'translateY(100%)';
        setTimeout(() => $('transfer-modal').style.display = 'none', 300);
    },
    renderSources() {
        let list = $('tf-source-list');
        list.innerHTML = '';
        
        let owner = DB.d.ownerProfile;
        let sources = [];
        
        // 1. My Wallet
        sources.push({id: 'wallet', name: '我的小金库', bal: DB.d.myWallet, icon: '💰', type: 'self'});
        
        // 2. Contacts
        DB.d.contacts.filter(c => !c.isGroup).forEach(c => {
            let bal = null;
            let type = 'contact';
            if (owner.relativeCardId == c.id) {
                bal = DB.d.walletBalance;
                type = 'bound';
            }
            sources.push({id: c.id, name: c.name, bal: bal, icon: c.avatar || Utils.defAv, type: type, isImg: true});
        });

        sources.forEach(s => {
            let div = document.createElement('div');
            div.className = 'list-item';
            div.style.padding = '10px';
            div.style.borderRadius = '8px';
            div.style.marginBottom = '2px';
            div.style.borderBottom = 'none';
            div.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;width:100%">
                    ${s.isImg ? `<img src="${s.icon}" style="width:32px;height:32px;border-radius:50%;object-fit:cover">` : `<div style="font-size:24px">${s.icon}</div>`}
                    <div style="flex:1">
                        <div style="font-size: calc(14px * var(--app-font-scale));font-weight:600">${s.name} ${s.type==='bound'?'<span style="font-size: calc(10px * var(--app-font-scale));color:var(--accent);border:1px solid var(--accent);border-radius:4px;padding:0 4px">亲属卡</span>':''}</div>
                        ${s.bal !== null ? `<div style="font-size: calc(12px * var(--app-font-scale));color:#999">余额: ¥${s.bal}</div>` : ''}
                    </div>
                    <div class="radio-circle" style="width:20px;height:20px;border-radius:50%;border:2px solid #ddd;display:flex;align-items:center;justify-content:center">
                        <div class="radio-inner" style="width:10px;height:10px;border-radius:50%;background:var(--accent);display:none"></div>
                    </div>
                </div>
            `;
            div.onclick = () => {
                this.selectedSource = s.id;
                Array.from(list.children).forEach(c => {
                    c.style.background = 'transparent';
                    c.querySelector('.radio-circle').style.borderColor = '#ddd';
                    c.querySelector('.radio-inner').style.display = 'none';
                });
                div.style.background = 'rgba(0,0,0,0.05)';
                div.querySelector('.radio-circle').style.borderColor = 'var(--accent)';
                div.querySelector('.radio-inner').style.display = 'block';
            };
            if (s.id === 'wallet') div.click(); // Default
            list.appendChild(div);
        });
    },
    validate() {
        let amt = parseFloat($('tf-amount').value);
        let btn = $('tf-btn-confirm');
        if (amt && amt > 0) {
            btn.style.opacity = 1;
            btn.style.pointerEvents = 'auto';
        } else {
            btn.style.opacity = 0.5;
            btn.style.pointerEvents = 'none';
        }
    },
    confirm() {
        let amt = parseFloat($('tf-amount').value);
        let note = $('tf-note').value.trim() || '转账给您';
        
        if (this.selectedSource === 'wallet') {
            if (DB.d.myWallet < amt) return Toast.show("小金库余额不足");
            DB.d.myWallet -= amt;
        } else {
            let owner = DB.d.ownerProfile;
            // Bound Card Check
            if (owner.relativeCardId == this.selectedSource) {
                if (DB.d.walletBalance < amt) return Toast.show("亲属卡余额不足");
                DB.d.walletBalance -= amt;
            }
            // For non-bound contacts, we just allow it (Infinite/Credit) for now, as user requested "choose which char's relative pay"
        }
        
        Chat.send(null, 'transfer', {amount: amt, note: note, status: 'pending'});
        
        // Trigger Background Reaction
        if (this.selectedSource !== 'wallet' && this.selectedSource != Chat.cid) {
            let targetC = DB.getContact(Chat.cid);
            let targetName = targetC ? targetC.name : 'someone';
            let context = `[系统通知] 用户使用了您的亲密付向 ${targetName} 转账了 ¥${amt}。备注: ${note}`;
            Chat.triggerBackgroundAI(this.selectedSource, context);
        }
        
        DB.save();
        this.close();
    }
};

const PlusMenu = {
    t() { 
        let d = $('plus-menu-drawer');
        let ov = $('drawer-overlay');
        if (d.classList.contains('active')) {
            d.classList.remove('active');
            if(ov) ov.classList.remove('active');
            $('chat-input-bar').classList.remove('input-up');
        } else {
            $('emoticon-panel').classList.remove('active');
            d.classList.add('active');
            if(ov) ov.classList.add('active');
            $('chat-input-bar').classList.add('input-up');
        }
    },
    sendImgFlow() { 
        let div = document.createElement('div');
        div.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)";
        div.innerHTML = `
            <div style="background:rgba(255,255,255,0.9);width:80%;max-width:300px;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
                <div style="padding:20px;text-align:center;font-weight:bold;border-bottom:0.5px solid rgba(0,0,0,0.1)">选择发送方式</div>
                <div id="btn-desc-img" style="padding:15px;text-align:center;border-bottom:0.5px solid rgba(0,0,0,0.1);cursor:pointer;color:#007aff">描述画面 (文字图片)</div>
                <div id="btn-local-img" style="padding:15px;text-align:center;cursor:pointer;color:#007aff">调用本地相册</div>
                <div id="btn-cancel-img" style="padding:15px;text-align:center;background:#f5f5f5;cursor:pointer;color:#666">取消</div>
            </div>
        `;
        document.body.appendChild(div);
        
        div.querySelector('#btn-desc-img').onclick = () => { div.remove(); this.descImg(); };
        div.querySelector('#btn-local-img').onclick = () => { div.remove(); $('plus-img-local').click(); };
        div.querySelector('#btn-cancel-img').onclick = () => { div.remove(); };

        this.t(); 
    },
    descImg() {
        let desc = prompt("请描述画面内容：");
        if(desc) Chat.send(null, 'image', {content: desc});
    },
    hImgLocal(inp) { Utils.b2d(inp.files[0], d => Chat.send(null, 'image', {content:d})); inp.value=''; },
    showE() { 
        $('plus-menu-drawer').classList.remove('active');
        $('emoticon-panel').classList.add('active'); 
        $('chat-input-bar').classList.add('input-up');
        this.renderEmoticons();
    },
    hideE() { 
        $('emoticon-panel').classList.remove('active'); 
        $('chat-input-bar').classList.remove('input-up');
        let ov = $('drawer-overlay'); if(ov) ov.classList.remove('active');
    },
    renderEmoticons() {
        let c = $('emoticon-grid-content');
        c.innerHTML = '';
        (DB.d.emoticons||[]).forEach((s, idx) => {
            let div = document.createElement('div');
            div.className = 'emoticon-item';
            div.innerHTML = `<img src="${s.url}"><div class="emoticon-name">${s.name}</div><div style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.5);color:white;padding:2px 5px;font-size:10px" onclick="event.stopPropagation();PlusMenu.delE(${idx})">✕</div>`;
            div.onclick = () => { Chat.send(null, 'image', {content: s.url, emoticonName: s.name}); this.hideE(); };
            c.appendChild(div);
        });
        if(!(DB.d.emoticons||[]).length) c.innerHTML = '<div style="grid-column:span 4;text-align:center;color:#999;padding:20px">暂无表情包</div>';
    },
    delE(idx) {
        if(confirm("删除此表情包?")) {
            DB.d.emoticons.splice(idx, 1);
            DB.save();
            this.renderEmoticons();
        }
    },
    rr() { 
        let c = DB.getContact(Chat.cid);
        if (c && c.history && c.history.length > 0) {
            let i = c.history.length - 1;
            while (i >= 0 && (c.history[i].role === 'assistant' || c.history[i].role === 'system')) {
                i--;
            }
            if (i < c.history.length - 1) {
                c.history.splice(i + 1);
                DB.save().then(() => {
                    Chat.renderMessages();
                    Chat.triggerAI();
                });
            } else {
                Chat.triggerAI();
            }
        } else {
            Chat.triggerAI();
        }
    },
    sendVoice() { 
        let t = prompt("请输入语音内容:"); 
        if(t) Chat.send(null, 'voice', {content: t, duration: Math.max(2, Math.round(t.length/2))}); 
        this.t(); 
    },
    hEFiles(inp) {
        Array.from(inp.files).forEach(f => {
            Utils.b2d(f, d => {
                setTimeout(() => {
                    let name = prompt(`请输入表情包名称 (${f.name}):`, f.name.split('.')[0]);
                    if(name) {
                        if(!DB.d.emoticons) DB.d.emoticons = [];
                        DB.d.emoticons.push({name: name, url: d});
                        DB.save();
                        this.renderEmoticons();
                        Toast.show(`表情包 ${name} 已添加`);
                    }
                }, 100);
            });
        });
        inp.value = '';
    },
    impEmoticonFlow() { $('plus-emoticon-input').click(); },
    impUrl() {
        $('emoticon-import-modal').style.display = 'flex';
        $('emoticon-import-text').value = '';
        $('emoticon-import-text').focus();
    },
    doImpUrl() {
        let str = $('emoticon-import-text').value.trim();
        if(!str) return;
        
        if(str.startsWith('[')) {
            try {
                let arr = JSON.parse(str);
                if(Array.isArray(arr)) {
                    this.batchAddEmoticons(arr);
                    $('emoticon-import-modal').style.display = 'none';
                    return;
                }
            } catch(e) {}
        }

        let lines = str.split(/[\r\n]+/).filter(l => l.trim());
        let batch = [];
        for (let i = 0; i < lines.length; i++) {
            let l = lines[i].trim();
            let httpMatch = l.match(/^(.*?)\s+(http.*|data:.*)$/);
            if (httpMatch) {
                batch.push({name: httpMatch[1].trim(), url: httpMatch[2].trim()});
            } else {
                if (i + 1 < lines.length) {
                    let nextL = lines[i+1].trim();
                    if (nextL.match(/^(http|data:)/)) {
                        batch.push({name: l, url: nextL});
                        i++; 
                        continue;
                    }
                }
                let lastSpace = l.lastIndexOf(' ');
                if (lastSpace > 0) {
                    let urlPart = l.substring(lastSpace+1).trim();
                    if (urlPart.match(/^(http|data:)/)) {
                        batch.push({name: l.substring(0, lastSpace).trim(), url: urlPart});
                    }
                }
            }
        }

        if (batch.length > 0) {
            this.batchAddEmoticons(batch);
            $('emoticon-import-modal').style.display = 'none';  
        } else if (lines.length === 1 && !lines[0].match(/\s/)) {     
             let name = prompt("给这个表情包取个名:");
             if(name) {
                 this.batchAddEmoticons([{name, url: str}]);    
                 $('emoticon-import-modal').style.display = 'none';
             }
        } else {
            alert("未能识别有效格式，请使用：名字 链接");
        }
    },
    batchAddEmoticons(arr) {
        if(!DB.d.emoticons) DB.d.emoticons = [];
        let count = 0;
        arr.forEach(s => {
            if(s.name && s.url) {
                DB.d.emoticons.push(s);
                count++;
            }
        });
        DB.save();
        this.renderEmoticons();
        Toast.show(`已导入 ${count} 个表情包`);
    }
};

const ContextMenu = {
    targetIdx: null,
    show(e, idx) { 
        this.targetIdx = idx;
        let overlay = $('ctx-overlay');
        overlay.classList.add('active');
        let menu = $('ctx-menu');
        let x = e.clientX || e.touches[0].clientX;
        let y = e.clientY || e.touches[0].clientY;
        
        // Prevent menu from going off-screen
        let winW = window.innerWidth, winH = window.innerHeight;
        if(x + 160 > winW) x = winW - 170;
        if(y + 200 > winH) y = winH - 210;
        
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    },
    hide() { $('ctx-overlay').classList.remove('active'); },
    edit() {
        this.hide();
        let c = DB.getContact(Chat.cid);
        let msg = c.history[this.targetIdx];
        if(!msg) return;

        if (msg.type === 'image' && (msg.content.startsWith('data:') || msg.content.startsWith('http'))) {
            return Toast.show("图片消息不支持文本编辑");
        }

        let newContent = prompt("编辑消息:", msg.content);
        if(newContent !== null && newContent.trim() !== "") {
            msg.content = newContent;
            DB.save();
            Chat.renderMessages();
            Toast.show("已编辑");
        }
    },
    quote() {
        this.hide();
        let c = DB.getContact(Chat.cid);
        let msg = c.history[this.targetIdx];
        if(msg) {
            let content = msg.content;
            if (msg.type === 'image' || (typeof content === 'string' && content.startsWith('data:'))) {
                content = '[图片]';
            } else if (msg.type === 'voice') {
                content = '[语音]';
            } else if (msg.type === 'transfer' || msg.type === 'transfer_in') {
                content = '[转账]';
            }
            Chat.setQ(content);
        }
    },
    multiSelect() {
        this.hide();
        MultiSelect.active = true;
        $('multi-select-bar').style.display = 'flex';
        Chat.renderMessages();
        // Auto-select the target message
        setTimeout(() => {
            let chk = $(`chk-${this.targetIdx}`);
            if(chk) chk.click();
        }, 50);
    }, 
    recall() {
        this.hide();
        let c = DB.getContact(Chat.cid);
        let msg = c.history[this.targetIdx];
        if(msg) {
            msg.recalled = true;
            msg.content = "🚫 该消息已撤回";
            msg.type = "text"; // Reset type if it was image/voice
            DB.save();
            Chat.renderMessages();
            Toast.show("已撤回");
        }
    }, 
    del() {
        this.hide();
        if(confirm("确定删除这条消息吗? (无痕)")) {
            let c = DB.getContact(Chat.cid);
            c.history.splice(this.targetIdx, 1);
            DB.save();
            Chat.renderMessages();
            Toast.show("已删除");
        }
    }
};

const ChatSettings = {
    o() {
        let c = DB.getContact(Chat.cid);
        if(!c) return;
        $('chat-settings-drawer').classList.add('active');
        
        // Load values
        $('preview-char-avatar').src = c.avatar || Utils.defAv;
        $('preview-user-avatar').src = c.userAvatar || Utils.defAv;
        $('set-bg-opacity').value = c.bgOpacity !== undefined ? c.bgOpacity : 1;
        $('opacity-val-disp').innerText = Math.round((c.bgOpacity !== undefined ? c.bgOpacity : 1) * 100) + '%';
        $('set-ai-time-aware').checked = c.timeAware !== false; // Default true
        $('set-auto-thought').checked = c.autoThought || false;
        $('set-ai-block-allow').checked = c.allowAiBlock || false;
        $('set-char-name').value = c.name;
        $('set-char-persona').value = c.charPersona || '';
        $('set-user-persona').value = c.userPersona || '';
        $('set-context-limit').value = c.contextLimit || 20;
        let history = c.history || [];
        let estTokens = 0;
        history.forEach(m => {
            if (m.type === 'image' && m.content && (m.content.startsWith('data:') || m.content.startsWith('http'))) {
                estTokens += 85; // detail: low 固定消耗
            } else {
                // 只计算实际发送给AI的字段，排除 quote (Base64)
                let temp = { role: m.role, content: m.content };
                estTokens += JSON.stringify(temp).length;
            }
        });
        if($('stat-msg-count')) $('stat-msg-count').innerText = history.length;
        if($('stat-token-count')) $('stat-token-count').innerText = estTokens;
        
        // Block button state
        $('btn-block-user').innerText = c.isBlocked ? "已拉黑 (点击解除)" : "拉黑用户";
        $('btn-block-user').className = c.isBlocked ? "btn-pill btn-white" : "btn-pill btn-danger-soft";
        $('btn-block-user').style.background = ''; // Clear inline style

        // World Select
        let worldContainer = $('chat-setting-world-select');
        worldContainer.innerHTML = '';
        if(DB.d.world && DB.d.world.length > 0) {
             let header = document.createElement('div');
             header.className = 'list-item';
             header.style.cursor = 'pointer';
             header.innerHTML = `<span>关联世界书 <span id="chat-world-count" style="color:var(--accent)">(${(c.worldIds||[]).length})</span></span><span style="color:#ccc">▼</span>`;
             let listDiv = document.createElement('div');
             listDiv.style.display = 'none';
             listDiv.style.background = 'rgba(0,0,0,0.02)';
             listDiv.style.padding = '5px 0';
             header.onclick = () => { listDiv.style.display = listDiv.style.display === 'none' ? 'block' : 'none'; };
             
             let optionalWorlds = DB.d.world.filter(w => !w.isGlobal);
             
             if (optionalWorlds.length === 0) {
                 listDiv.innerHTML = '<div style="padding:10px;color:#999;font-size:12px">没有可选的世界观 (全局设定已默认生效)</div>';
             }
             
             optionalWorlds.forEach(w => {
                 let isChecked = (c.worldIds||[]).includes(w.id) ? 'checked' : '';
                 let item = document.createElement('div');
                 item.className = 'list-item';
                 item.style.borderBottom = 'none';
                 item.innerHTML = `<span style="font-size:14px">${w.key}</span><input type="checkbox" class="chat-world-cb" value="${w.id}" ${isChecked} style="width:auto">`;
                 item.querySelector('input').onchange = () => {
                     let count = listDiv.querySelectorAll('input:checked').length;
                     $('chat-world-count').innerText = `(${count})`;
                 };
                 listDiv.appendChild(item);
             });
             worldContainer.appendChild(header);
             worldContainer.appendChild(listDiv);
        } else {
             worldContainer.innerHTML = '<div class="list-item" style="color:#999;font-size:12px">暂无世界书</div>';
        }
    },
    c() { $('chat-settings-drawer').classList.remove('active'); },
    s() {
        let c = DB.getContact(Chat.cid);
        if(!c) return;
        
        c.avatar = $('preview-char-avatar').src;
        c.userAvatar = $('preview-user-avatar').src;
        c.bgOpacity = parseFloat($('set-bg-opacity').value);
        c.timeAware = $('set-ai-time-aware').checked;
        c.autoThought = $('set-auto-thought').checked;
        c.allowAiBlock = $('set-ai-block-allow').checked;
        c.name = $('set-char-name').value;
        c.charPersona = $('set-char-persona').value;
        c.userPersona = $('set-user-persona').value;
        c.contextLimit = parseInt($('set-context-limit').value) || 20;
        
        // Save Worlds
        let wIds = [];
        document.querySelectorAll('.chat-world-cb').forEach(cb => { if(cb.checked) wIds.push(parseInt(cb.value)); });
        c.worldIds = wIds;
        
        DB.save();
        Chat.renderMessages();
        Contacts.render(); // Update list name/avatar
        this.c();
        Toast.show("设置已保存");
    },
    hF(inp, imgId, isBg=false) {
        Utils.b2d(inp.files[0], d => {
            if(isBg) {
                let c = DB.getContact(Chat.cid);
                c.chatBg = d;
                DB.save();
                Chat.renderMessages();
                Toast.show("背景已更换");
            } else {
                $(imgId).src = d;
            }
        });
        inp.value = '';
    },
    uOp(v) { 
        $('opacity-val-disp').innerText = Math.round(v*100) + '%';
        let c = DB.getContact(Chat.cid);
        if(c) { c.bgOpacity = v; $('chat-bg-layer').style.opacity = v; }
    },
    uAllowAiBlock() {}, // Handled in save
    openAdvancedEdit() {
        let c = DB.getContact(Chat.cid);
        $('style-c-m').value = c.colorMe || '#FFD5D5';
        $('style-t-m').value = c.colorTextMe || '#595959';
        $('style-c-a').value = c.colorAi || '#ffffff';
        $('style-t-a').value = c.colorTextAi || '#595959';
        $('style-av-shape').value = c.avatarShape || 'circle';
        $('style-av-display').value = c.avatarDisplay || 'all';
        $('style-css').value = c.customCss || '';
        $('style-font-size').value = parseInt(c.chatFontSize) || 16;
        $('style-font-size-val').innerText = (parseInt(c.chatFontSize) || 16) + 'px';
        
        // Render Presets list
        let pList = $('style-presets-list');
        pList.innerHTML = '';
        if(DB.d.stylePresets) {
            DB.d.stylePresets.forEach((p, idx) => {
                let div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `<span>${p.name}</span><span onclick="ChatSettings.delPreset(${idx})" style="color:red;font-size:12px;cursor:pointer">删除</span>`;
                div.onclick = (e) => {
                    if(e.target.innerText === '删除') return;
                    $('style-c-m').value = p.data.colorMe;
                    $('style-t-m').value = p.data.colorTextMe;
                    $('style-c-a').value = p.data.colorAi;
                    $('style-t-a').value = p.data.colorTextAi;
                    $('style-av-shape').value = p.data.avatarShape;
                    $('style-css').value = p.data.customCss;
                    Toast.show("已加载预设");
                };
                pList.appendChild(div);
            });
        }
        
        App.o('sub-chat-style-edit');
    },
    saveStyle() {
        let c = DB.getContact(Chat.cid);
        c.colorMe = $('style-c-m').value;
        c.colorTextMe = $('style-t-m').value;
        c.colorAi = $('style-c-a').value;
        c.colorTextAi = $('style-t-a').value;
        c.avatarShape = $('style-av-shape').value;
        c.avatarDisplay = $('style-av-display').value;
        console.log("Saving avatarDisplay:", c.avatarDisplay);
        c.customCss = $('style-css').value;
        c.chatFontSize = $('style-font-size').value + 'px';
        DB.save();
        Appearance.applyCS(c);
        App.b();
        Toast.show("样式已保存");
    },
    saveToPresets() {
        let name = prompt("预设名称:");
        if(!name) return;
        if(!DB.d.stylePresets) DB.d.stylePresets = [];
        DB.d.stylePresets.push({
            name: name,
            data: {
                colorMe: $('style-c-m').value,
                colorTextMe: $('style-t-m').value,
                colorAi: $('style-c-a').value,
                colorTextAi: $('style-t-a').value,
                avatarShape: $('style-av-shape').value,
                customCss: $('style-css').value
            }
        });
        DB.save();
        // Reload list
        this.openAdvancedEdit(); 
    },
    delPreset(idx) {
        if(confirm("删除此预设?")) {
            DB.d.stylePresets.splice(idx, 1);
            DB.save();
            this.openAdvancedEdit();
        }
    },
    
    
    
    toggleBlock() {
        let c = DB.getContact(Chat.cid);
        c.isBlocked = !c.isBlocked;
        $('btn-block-user').innerText = c.isBlocked ? "已拉黑 (点击解除)" : "拉黑用户";
        $('btn-block-user').className = c.isBlocked ? "btn-pill btn-white" : "btn-pill btn-danger-soft";
        $('btn-block-user').style.background = '';
        DB.save();
    }
};


// --- apps/moments.js --- 
const Moments = {
    render() {
        let c = $('moments-container');
        c.innerHTML = '';
        let uName = DB.d.userName || 'User';
        let uAv = DB.d.momentUserAvatar || Utils.defAv; // Use moment-specific avatar
        let uSign = DB.d.userSign || '个性签名...';
        
        let stats = this.getStats();

        // Structure: Two Views (Feed & Messages)
        // Updated Header Structure: Avatar + Bio in Top Row, Stats in Bottom Row (Swapped)
        c.innerHTML = `
        <div id="moments-feed-view">
            <div class="moment-header-area">
                <div class="ins-header-container">
                    <div class="ins-top-row">
                        <div class="moment-avatar-container">
                            <img src="${uAv}" class="moment-avatar" onclick="$('global-file-crop').click();Crop.mode='moment-av'">
                        </div>
                        <div class="ins-bio-row" style="flex:1; padding-left:15px">
                            <div class="moment-username">${uName}</div>
                            <div class="moment-sign" onclick="Moments.editSign()">${uSign}</div>
                        </div>
                    </div>
                    <div class="moment-stats-row">
                        <div class="moment-stat-item">
                            <div class="moment-stat-num">${stats.moments}</div>
                            <div class="moment-stat-label">动态</div>
                        </div>
                        <div class="moment-stat-item">
                            <div class="moment-stat-num">${stats.following}</div>
                            <div class="moment-stat-label">关注</div>
                        </div>
                        <div class="moment-stat-item" onclick="Moments.openMessages()">
                            <div class="moment-stat-num">0</div>
                            <div class="moment-stat-label">留言</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="moment-list"></div>
            <!-- FAB Removed -->
        </div>

        <div id="moments-msg-view" style="display:none;padding-top:0;background:#F8F9FA;min-height:100%;padding-bottom:80px">
            <div class="nav-bar" style="background:#fff;border-bottom:none;position:sticky;top:0;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,0.02)">
                <button class="nav-btn" onclick="Moments.closeMessages()" style="color:#333"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:24px"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                <div class="nav-title" style="color:#333;font-weight:700">留言板</div>
                <div style="width:40px"></div>
            </div>
            <div id="moment-msg-list-content" style="padding:20px;"></div>
            
            <!-- Message Input Area (Sticky Bottom) -->
            <div style="position:fixed;bottom:0;left:0;width:100%;padding:15px 20px;padding-bottom:max(15px, env(safe-area-inset-bottom));background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);border-top:1px solid rgba(0,0,0,0.05);display:flex;gap:10px;align-items:center;z-index:20">
                <input type="text" placeholder="写留言..." style="flex:1;background:#F2F4F6;border:none;border-radius:20px;padding:10px 15px;font-size:14px;outline:none">
                <button class="btn-pill-black" style="padding:8px 16px;font-size:13px">发送</button>
            </div>
        </div>
        `;
        
        let list = c.querySelector('.moment-list');
        let moments = (DB.d.userMoments||[]);
        
        if(moments.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;padding:60px 0;font-size:14px">暂无动态</div>';
            return;
        }

        moments.forEach(m => {
            // Image Logic
            let imgs = [];
            if(m.imgs && Array.isArray(m.imgs)) imgs = m.imgs;
            else if(m.img) imgs = [m.img];

            let imgGridHtml = '';
            if (imgs.length > 0) {
                let gridClass = imgs.length === 1 ? 'single' : '';
                let imgItems = imgs.map(url => `<img src="${url}" onclick="Chat.showImg(this.src)">`).join('');
                imgGridHtml = `<div class="m-grid ${gridClass}">${imgItems}</div>`;
            }

            // Text Logic
            let contentHtml = '';
            if(m.content) {
                let isLong = m.content.length > 80 || (m.content.match(/\n/g)||[]).length > 3;
                contentHtml = `
                    <div class="m-text ${isLong?'collapsed':''}" id="m-text-${m.id}">${Utils.esc(m.content)}</div>
                    ${isLong ? `<div class="m-expand-btn" style="display:block" onclick="Moments.toggleText(${m.id}, this)">全文</div>` : ''}
                `;
            }
            
            let isLiked = m.likes && m.likes.includes('me');

            let el = document.createElement('div');
            el.className = 'moment-card';
            el.innerHTML = `
                <div class="m-header">
                    <img src="${m.avatar||Utils.defAv}" class="m-avatar">
                    <div class="m-info">
                        <div class="m-name">${m.name||'User'}</div>
                        <!-- Top Right 3-dots Menu moved to inline with header -->
                    </div>
                    <div style="position:relative">
                        <div class="m-more-btn" onclick="Moments.toggleMenu(${m.id}, event)">...</div>
                        <div class="m-menu-pop" id="m-menu-${m.id}">
                             <div class="m-menu-item danger" onclick="Moments.del(${m.id})">删除</div>
                        </div>
                    </div>
                </div>
                <div class="m-content-box">
                    <div class="m-body">
                        ${contentHtml}
                        ${imgGridHtml}
                    </div>
                    <div class="m-footer">
                        <div class="m-time">${Utils.timeStr(m.time)}</div>
                        <div style="position:relative">
                            <div class="m-popover" id="m-pop-${m.id}">
                                 <div class="m-pop-item" onclick="Moments.like(${m.id})">
                                    ${isLiked ? 
                                      '<svg viewBox="0 0 24 24" fill="#ff3b30" stroke="#ff3b30" class="m-like-anim" style="width:18px;height:18px"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>' : 
                                      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:18px;height:18px"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'
                                    } 
                                    <span style="margin-left:4px">${isLiked ? '取消' : '赞'}</span>
                                 </div>
                                 <div class="m-pop-line"></div>
                                 <div class="m-pop-item" onclick="Moments.comment(${m.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:18px;height:18px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                    <span style="margin-left:4px">评论</span>
                                 </div>
                            </div>
                            <div class="m-action-btn" onclick="Moments.toggleOpts(${m.id}, event)">
                                <div style="width:4px;height:4px;background:currentColor;border-radius:50%;margin-right:2px"></div>
                                <div style="width:4px;height:4px;background:currentColor;border-radius:50%"></div>
                            </div>
                        </div>
                    </div>
                    ${(m.likes && m.likes.length > 0) ? `
                    <div style="background:#f9f9f9;padding:8px 12px;margin-top:12px;border-radius:8px;font-size:13px;color:#576b95;display:flex;align-items:center;gap:6px">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:14px;height:14px"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <span style="font-weight:600">${m.likes.includes('me') ? '我' : ''}</span>
                    </div>` : ''}
                </div>
            `;
            list.appendChild(el);
        });
    },

    getStats() {
        let moments = (DB.d.userMoments||[]).length;
        let following = (DB.d.contacts||[]).filter(c=>!c.isGroup).length;
        return { moments, following };
    },

    openMessages() {
        $('moments-feed-view').style.display = 'none';
        $('moments-msg-view').style.display = 'block';
        
        let mainNav = document.querySelector('#tab-moments .nav-bar');
        if(mainNav) mainNav.style.display = 'none';
        
        // Ensure bottom nav is visible in Message View? User didn't specify.
        // User said "When opening Moments (Dynamic), don't show bottom bar".
        // Message board is inside Moments tab. So bottom bar should be hidden here too.
        // LineApp.sw handles the hiding for the tab. So it should be fine.

        this.renderMessageList();
    },

    closeMessages() {
        $('moments-feed-view').style.display = 'block';
        $('moments-msg-view').style.display = 'none';
        let mainNav = document.querySelector('#tab-moments .nav-bar');
        if(mainNav) mainNav.style.display = 'flex';
    },

    renderMessageList() {
        let list = $('moment-msg-list-content');
        list.innerHTML = '';
        let contacts = (DB.d.contacts||[]).filter(c => !c.isGroup);
        if (contacts.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;font-size:14px;margin-top:100px;font-weight:500">暂无好友留言</div>';
        } else {
            let msgs = [
                "好久不见！", "这张照片真好看~", "下次一起去玩！", "最近怎么样？", "想你了。", 
                "这一刻的想法真棒！", "哈哈哈哈", "羡慕~", "这是哪里呀？"
            ];
            let count = Math.floor(Math.random() * 3) + 3;
            for(let i=0; i<count; i++) {
                let c = contacts[Math.floor(Math.random() * contacts.length)];
                let txt = msgs[Math.floor(Math.random() * msgs.length)];
                let div = document.createElement('div');
                div.className = 'msg-item';
                div.innerHTML = `
                    <img src="${c.avatar||Utils.defAv}" class="msg-av">
                    <div class="msg-content">
                        <div class="msg-name">${c.name}</div>
                        <div class="msg-text">${txt}</div>
                        <div style="font-size:11px;color:#ccc;margin-top:6px">${Utils.timeStr(Date.now() - Math.floor(Math.random()*10000000))}</div>
                    </div>
                `;
                list.appendChild(div);
            }
        }
    },

    toggleText(id, btn) {
        let el = $(`m-text-${id}`);
        if(el.classList.contains('collapsed')) {
            el.classList.remove('collapsed');
            btn.innerText = '收起';
        } else {
            el.classList.add('collapsed');
            btn.innerText = '全文';
        }
    },

    toggleOpts(id, e) {
        if(e) e.stopPropagation();
        let menu = $(`m-pop-${id}`);
        document.querySelectorAll('.m-popover').forEach(el => {
            if(el !== menu) el.classList.remove('show');
        });
        document.querySelectorAll('.m-menu-pop').forEach(el => el.classList.remove('active')); // Close other menus
        if(menu) menu.classList.toggle('show');
    },

    toggleMenu(id, e) {
        if(e) e.stopPropagation();
        let menu = $(`m-menu-${id}`);
        document.querySelectorAll('.m-menu-pop').forEach(el => {
            if(el !== menu) el.classList.remove('active');
        });
        document.querySelectorAll('.m-popover').forEach(el => el.classList.remove('show')); // Close other popovers
        if(menu) menu.classList.toggle('active');
    },
    
    del(id) {
        if(confirm("删除这条动态？")) {
             DB.d.userMoments = DB.d.userMoments.filter(m => m.id != id);
             DB.save();
             this.render();
             Toast.show("已删除");
        }
    },
    like(id) { 
        let m = DB.d.userMoments.find(x => x.id === id);
        if(!m) return;
        if(!m.likes) m.likes = [];
        
        if(m.likes.includes('me')) {
            m.likes = m.likes.filter(x => x !== 'me');
        } else {
            m.likes.push('me');
        }
        DB.save();
        this.render(); // Re-render to show update state
    },
    comment(id) { Toast.show("评论功能开发中"); this.toggleOpts(id); },
    
    openAdd() {
        $('moments-add-text').value = '';
        $('moments-add-img-in').value = '';
        $('moments-add-img-in').removeAttribute('multiple');
        $('moments-add-img-in').setAttribute('multiple', 'multiple');
        
        // Reset previews
        let con = $('moments-add-preview-container');
        if(!con) {
             let oldP = $('moments-add-preview');
             let parent = oldP.parentNode;
             // Rebuild structure if old one exists
             parent.innerHTML = '';
             con = document.createElement('div');
             con.id = 'moments-add-preview-container';
             con.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px';
             parent.appendChild(con);
             
             let btn = document.createElement('div');
             btn.id = 'moments-add-btn';
             btn.onclick = () => $('moments-add-img-in').click();
             btn.style.cssText = 'width:80px;height:80px;background:#f0f0f0;display:flex;justify-content:center;align-items:center;color:#999;font-size:32px;border-radius:8px;cursor:pointer;';
             btn.innerText = '+';
             parent.appendChild(btn);
             
             let inp = document.createElement('input');
             inp.type = 'file'; inp.id = 'moments-add-img-in'; inp.hidden = true; inp.accept = 'image/*'; inp.multiple = true;
             inp.onchange = (e) => Moments.hAddImg(e.target);
             parent.appendChild(inp);
        }
        
        con.innerHTML = '';
        $('moments-add-btn').style.display = 'flex';
        
        this.tempImgs = [];
        App.o('sub-moments-add');
    },
    hAddImg(inp) {
        if(!inp.files || inp.files.length === 0) return;
        let files = Array.from(inp.files);
        if(this.tempImgs.length + files.length > 9) {
            Toast.show("最多只能选择9张图片");
            files = files.slice(0, 9 - this.tempImgs.length);
        }
        
        files.forEach(f => {
            Utils.b2d(f, d => {
                this.tempImgs.push(d);
                this.renderAddPreview();
            });
        });
        inp.value = '';
    },
    renderAddPreview() {
        let con = $('moments-add-preview-container');
        con.innerHTML = '';
        this.tempImgs.forEach((img, idx) => {
            let div = document.createElement('div');
            div.style.cssText = "position:relative;width:80px;height:80px;overflow:hidden;border-radius:8px";
            div.innerHTML = `<img src="${img}" style="width:100%;height:100%;object-fit:cover"><div style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.5);color:white;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer" onclick="Moments.removeTempImg(${idx})">×</div>`;
            con.appendChild(div);
        });
        $('moments-add-btn').style.display = this.tempImgs.length >= 9 ? 'none' : 'flex';
    },
    removeTempImg(idx) {
        this.tempImgs.splice(idx, 1);
        this.renderAddPreview();
    },
    doPublish() {
        let t = $('moments-add-text').value.trim();
        if(!t && this.tempImgs.length === 0) return;
        let m = {
            id:Date.now(), 
            time:Date.now(), 
            content:t, 
            name:DB.d.userName||'User', 
            // Use moment-specific avatar or fallback to owner avatar
            avatar: DB.d.momentUserAvatar || DB.d.ownerAvatar || Utils.defAv, 
            imgs: this.tempImgs
        };
        if(!DB.d.userMoments) DB.d.userMoments = [];
        DB.d.userMoments.unshift(m);
        DB.save();
        this.render();
        App.b();
        Toast.show("动态已发布");
    },
    editSign() {
        let s = prompt("修改签名:", DB.d.userSign||'');
        if(s!==null) { DB.d.userSign = s; DB.save(); this.render(); }
    },
    hImg(inp) { /* handled inline */ } 
};

// Global click to close popovers
document.addEventListener('click', (e) => {
    if(!e.target.closest('.m-actions') && !e.target.closest('.m-popover') && !e.target.closest('.m-action-btn')) {
        document.querySelectorAll('.m-popover').forEach(el => el.classList.remove('show'));
    }
    if(!e.target.closest('.m-more-btn') && !e.target.closest('.m-menu-pop')) {
        document.querySelectorAll('.m-menu-pop').forEach(el => el.classList.remove('active'));
    }
});


// --- apps/diary.js --- 
const Diary = {
    folderId: null,
    currentEntryId: null,

    render() {
        let container = $('diary-list-container'); 
        if(!container) return;
        container.innerHTML = '';
        
        if (this.folderId) {
            this.renderFolder(this.folderId);
        }

        let contacts = DB.d.contacts.filter(c => !c.isGroup);
        
        container.innerHTML = `<div style="padding:10px 0 20px 0;font-size:24px;font-weight:800;color:#1a1a1a">想念</div>`;
        
        let cardContainer = document.createElement('div');
        cardContainer.className = 'diary-cards-container';
        container.appendChild(cardContainer);

        if (contacts.length === 0) {
            cardContainer.innerHTML = `<div style="text-align:center;color:#999;padding:40px;opacity:0.5"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:40px;height:40px;margin-bottom:10px;display:block;margin:0 auto"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>暂无想念对象</div>`;
        } else {
            contacts.forEach(c => {
                let entries = this.getEntries(c);
                let count = entries.length;
                let lastDate = entries.length > 0 ? entries[entries.length-1].date : '暂无日记';
                
                let item = document.createElement('div');
                item.className = 'card-modern';
                item.style.cssText = 'flex-direction:row;align-items:center;padding:20px;cursor:pointer;margin-bottom:15px';
                item.innerHTML = `
                    <img src="${c.avatar||Utils.defAv}" class="d-book-av" style="width:60px;height:60px;border-radius:18px;object-fit:cover;box-shadow:0 5px 15px rgba(0,0,0,0.05)">
                    <div class="d-book-info" style="flex:1;margin-left:15px">
                        <div class="d-book-title" style="font-size:18px;font-weight:bold;color:#333;margin-bottom:4px">${c.name}</div>
                        <div class="d-book-meta" style="font-size:12px;color:#999">${count} 篇日记 · ${lastDate}</div>
                    </div>
                    <div class="d-book-arrow" style="color:#ccc;font-size:20px">›</div>
                `;
                item.onclick = () => { 
                    this.folderId = c.id; 
                    this.renderFolder(c.id); 
                };
                cardContainer.appendChild(item);
            });
        }
    },

    closeFolder() {
        this.folderId = null;
        $('sub-diary-edit').classList.remove('active'); 
        this.render(); 
    },

    getEntries(c) {
        if (!c.diary) return [];
        if (typeof c.diary === 'string') return []; 
        if (Array.isArray(c.diary)) {
            return c.diary.filter(e => e && typeof e === 'object');
        }
        return [];
    },

    renderFolder(id) {
        let c = DB.getContact(id);
        if(!c) { this.closeFolder(); return; }

        let titleEl = $('diary-nav-title');
        if(titleEl) {
            titleEl.innerText = c.name + " 的想念";
            titleEl.style.fontSize = "16px";
        }
        
        let container = $('diary-entries-list');
        if(!container) return;
        container.innerHTML = '';
        
        let entries = this.getEntries(c);
        entries.sort((a,b) => b.time - a.time);

        if (entries.length === 0) {
            container.innerHTML = `<div style="text-align:center;padding:40px;color:#ccc">暂无日记，点击上方按钮开始</div>`;
        }

        entries.forEach(e => {
            let card = document.createElement('div');
            card.className = 'card-modern';
            card.style.cssText = 'padding:20px;cursor:pointer;margin-bottom:15px';
            let isMe = e.type === 'user';
            
            let preview = e.content.substring(0, 60) + (e.content.length > 60 ? '...' : '');
            let commentCount = (e.comments || []).length;
            
            card.innerHTML = `
                <div class="d-card-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <span class="d-date" style="font-weight:bold;font-size:18px;color:#333;font-family:'SF Pro Display'">${e.date} <span style="font-weight:normal;font-size:14px;color:#999;margin-left:5px">${e.weather||''}</span></span>
                    <span class="d-tag ${isMe?'me':'ai'}" style="font-size:10px;padding:2px 8px;border-radius:10px;font-weight:bold;${isMe ? 'background:#fff0f0;color:#ff3b30' : 'background:#e3f2fd;color:#2196f3'}">${isMe ? '我' : 'TA'}</span>
                </div>
                <div class="d-card-content" style="font-size:14px;color:#555;line-height:1.6;margin-bottom:15px">${Utils.esc(preview)}</div>
                <div class="d-card-footer" style="border-top:1px dashed #eee;padding-top:10px;display:flex;justify-content:space-between;color:#ccc;font-size:12px">
                    <span>${commentCount} 条互动</span>
                    <span>查看详情 ›</span>
                </div>
            `;
            this.addCardEvents(card, e.id, c.id);
            container.appendChild(card);
        });
        
        App.o('sub-diary-edit');
    },

    addCardEvents(card, entryId, contactId) {
        let timer;
        card.addEventListener('touchstart', (ev) => {
            timer = setTimeout(() => {
                this.delEntry(entryId, contactId);
            }, 800);
        });
        card.addEventListener('touchend', () => clearTimeout(timer));
        card.addEventListener('touchmove', () => clearTimeout(timer));
        card.onmousedown = () => {
            timer = setTimeout(() => {
                this.delEntry(entryId, contactId);
            }, 800);
        };
        card.onmouseup = () => clearTimeout(timer);
        card.onmouseleave = () => clearTimeout(timer);

        card.onclick = () => { 
            clearTimeout(timer); 
            this.openEntry(entryId); 
        };
    },

    delEntry(eid, cid) {
        if(confirm("确定删除这篇日记吗？")) {
            let c = DB.getContact(cid);
            c.diary = c.diary.filter(x => x.id !== eid);
            DB.save();
            this.renderFolder(cid);
            Toast.show("日记已删除");
        }
    },

    openEntry(id) {
        this.currentEntryId = id;
        let c = DB.getContact(this.folderId);
        let entry = c.diary.find(e => e.id === id);
        if(!entry) return;
        
        let contentDiv = $('diary-detail-content');
        let isMe = entry.type === 'user';
        
        // Remove Header Image Logic
        let headerImg = $('diary-detail-header-img');
        if(headerImg) headerImg.style.backgroundImage = 'none'; 

        // Update Weather Background
        this.updateWeatherBg(entry.weather || '晴', 'detail');

        contentDiv.innerHTML = `
            <div class="d-detail-paper" style="background:rgba(255,255,255,0.8);backdrop-filter:blur(20px);border-radius:24px;padding:30px;margin:20px;box-shadow:0 10px 40px rgba(0,0,0,0.05)">
                <div class="d-detail-date" style="font-size:24px;font-weight:800;margin-bottom:20px;border-bottom:1px solid #eee;padding-bottom:15px;display:flex;align-items:baseline">${entry.date} <span style="font-size:16px;margin-left:10px;color:#666">${entry.weather || ''}</span> <span style="font-weight:normal;opacity:0.4;margin-left:auto;font-size:12px">${Utils.timeStr(entry.time)}</span></div>
                <div class="d-detail-body" style="font-size:16px;line-height:1.8;white-space:pre-wrap;color:#333">${Utils.esc(entry.content)}</div>
                <div class="d-detail-author" style="text-align:right;margin-top:30px;color:#999;font-size:12px;font-weight:600">
                    — ${isMe ? '我' : c.name}
                </div>
            </div>
        `;
        
        this.renderComments(entry);
        App.o('sub-diary-detail');
    },

    updateWeatherBg(weather, type) { 
        let container = $(`diary-weather-bg-${type}`);
        if(!container) return;
        container.innerHTML = ''; 
        container.className = 'diary-weather-bg'; 

        let themeClass = 'w-sunny';
        if(weather.includes('雨')) themeClass = 'w-rainy';
        else if(weather.includes('雪')) themeClass = 'w-snowy';
        else if(weather.includes('云')) themeClass = 'w-cloudy';
        else if(weather.includes('阴')) themeClass = 'w-yin';
        
        container.classList.add(themeClass);

        if(themeClass === 'w-snowy') {
            for(let i=0; i<30; i++) {
                let el = document.createElement('div');
                el.className = 'snow-flake';
                el.style.left = Math.random()*100 + '%';
                el.style.animationDuration = (Math.random()*3 + 2) + 's';
                el.style.animationDelay = Math.random()*2 + 's';
                el.style.opacity = Math.random();
                container.appendChild(el);
            }
        } else if(themeClass === 'w-rainy') {
            for(let i=0; i<40; i++) {
                let el = document.createElement('div');
                el.className = 'rain-drop';
                el.style.left = Math.random()*100 + '%';
                el.style.animationDuration = (Math.random()*0.5 + 0.5) + 's';
                el.style.animationDelay = Math.random() + 's';
                container.appendChild(el);
            }
        } else if(themeClass === 'w-sunny') {
             for(let i=0; i<20; i++) {
                let el = document.createElement('div');
                el.className = 'sakura-petal';
                el.style.left = Math.random()*100 + '%';
                el.style.animationDuration = (Math.random()*5 + 5) + 's';
                el.style.animationDelay = Math.random()*5 + 's';
                el.style.opacity = Math.random() * 0.5 + 0.5;
                container.appendChild(el);
            }
        }
    },

    renderComments(entry) {
        let list = $('diary-comment-list');
        list.innerHTML = '';
        if(!entry.comments || entry.comments.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:rgba(0,0,0,0.3);padding:20px;font-size:12px">暂无评论，快来互动吧~</div>';
            return;
        }
        
        let c = DB.getContact(this.folderId);
        
        entry.comments.forEach(cm => {
            let isUser = cm.author === 'user';
            let div = document.createElement('div');
            div.className = 'd-comment-item';
            div.innerHTML = `
                <img src="${isUser ? (c.userAvatar||Utils.defAv) : (c.avatar||Utils.defAv)}" class="d-comment-av">
                <div class="d-comment-box ${isUser?'me':'ai'}">
                    <div class="d-comment-name">${isUser ? '我' : c.name}</div>
                    <div class="d-comment-text">${Utils.esc(cm.content)}</div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    writeEntry() {
        if(!this.folderId) return Toast.show("请先选择联系人");
        $('diary-write-input').value = '';
        let now = new Date();
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth() + 1).padStart(2, '0');
        let dd = String(now.getDate()).padStart(2, '0');
        $('diary-date-input').value = `${yyyy}-${mm}-${dd}`;
        $('diary-weather-input').value = '晴'; 
        
        this.updateWeatherBg('晴', 'write');
        App.o('sub-diary-write');
    },

    saveUserEntry() {
        let content = $('diary-write-input').value.trim();
        let date = $('diary-date-input').value;
        let weather = $('diary-weather-input').value;
        
        if(!content) return;
        if(!date) return Toast.show("请选择日期");
        
        let c = DB.getContact(this.folderId);
        if(!c.diary) c.diary = [];
        
        let entry = {
            id: Date.now(),
            time: Date.now(),
            date: date,
            weather: weather,
            type: 'user',
            content: content,
            comments: []
        };
        
        c.diary.push(entry);
        DB.save();
        
        $('sub-diary-write').classList.remove('active');
        this.renderFolder(this.folderId);
        Toast.show("日记已发布");
        
        setTimeout(() => this.triggerAiComment(entry), 3000);
    },

    showGenOptions() {
        if(!this.folderId) return Toast.show("请先进入某人的日记本");
        let div = document.createElement('div');
        div.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)";
        div.innerHTML = `
            <div class="card-modern" style="width:80%;max-width:300px;padding:25px">
                <div style="text-align:center;font-weight:800;font-size:18px;margin-bottom:15px">生成日记选项</div>
                
                <div style="margin-bottom:15px">
                    <div class="label-modern">STYLE</div>
                    <select id="gen-type" class="input-modern">
                        <option value="daily">日常日记 (轻松/生活化)</option>
                        <option value="unspoken">难以说出口的话 (文艺/隐痛)</option>
                    </select>
                </div>
                
                <div style="margin-bottom:20px">
                    <div class="label-modern">PERSPECTIVE</div>
                    <select id="gen-pers" class="input-modern">
                        <option value="1st">第一人称 (我...)</option>
                        <option value="3rd">第三人称 (TA...)</option>
                    </select>
                </div>

                <div style="display:flex;gap:10px">
                    <button class="btn-pill btn-white" onclick="this.closest('div').parentElement.parentElement.remove()" style="flex:1">取消</button>
                    <button class="btn-pill btn-black" id="btn-do-gen" style="flex:1">生成</button>
                </div>
            </div>
        `;
        document.body.appendChild(div);
        
        div.querySelector('#btn-do-gen').onclick = () => {
            let type = div.querySelector('#gen-type').value;
            let pers = div.querySelector('#gen-pers').value;
            div.remove();
            this.genAiEntry(true, type, pers);
        };
    },

    async genAiEntry(force = false, type = 'daily', perspective = '1st') {
        if(!this.folderId) return Toast.show("请先进入某人的日记本");
        
        let refreshBtn = $('btn-diary-refresh');
        if(refreshBtn) {
            let svg = refreshBtn.querySelector('svg');
            if(svg) svg.classList.add('rotating');
        }

        let c = DB.getContact(this.folderId);
        
        let now = new Date();
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth() + 1).padStart(2, '0');
        let dd = String(now.getDate()).padStart(2, '0');
        let today = `${yyyy}-${mm}-${dd}`; 

        let hasToday = c.diary && c.diary.some(e => e.type === 'ai' && e.date === today);
        if(hasToday && !force) {
            if(refreshBtn) refreshBtn.querySelector('svg').classList.remove('rotating');
            return Toast.show("TA 今天已经写过日记了哦");
        }
        
        Toast.show("TA 正在构思日记...");
        
        let p = DB.getPreset();
        if(!p || !p.key) {
            if(refreshBtn) refreshBtn.querySelector('svg').classList.remove('rotating');
            return Toast.show("API未配置");
        }
        
        let summary = c.summary || '无';
        
        // Gather today's context (Schedule & Chat)
        let scheduleContext = c.schedule ? JSON.stringify(c.schedule) : "No schedule for today";
        let todayChat = (c.history || []).filter(m => new Date(m.time).toDateString() === new Date().toDateString()).map(m => `${m.role}: ${m.content}`).join('\n');
        if(!todayChat) todayChat = "No chat today";

        let styleDesc = type === 'daily' ? "Casual, Relaxed, Daily Life (轻松、日常)" : "Literary, Hidden Pain, Deep Feelings (文艺、隐痛)";
        let persDesc = perspective === '1st' ? "First Person ('I')" : `Third Person ('${c.name}' or He/She)`;
        
        let prompt = `Roleplay: You are ${c.name}. Write a diary entry about your day or feelings towards User.
        Persona: ${c.charPersona}
        World: ${c.worldView || 'Modern'}
        
        [Today's Context]:
        Schedule: ${scheduleContext}
        Chat History: ${todayChat}
        Summary of past chat: ${summary}
        
        Task: Write a diary entry based on today's interactions and schedule.
        Requirements:
        1. Style: ${styleDesc}.
        2. Perspective: ${persDesc}.
        3. Content: Only write thoughts/dialogue. Do NOT describe actions/movements in asterisks.
        4. Length: Around 450 characters.
        5. Format: JSON Object { "content": "entry text", "weather": "Sunny/Cloudy/Rainy/Snowy" }
        Language: Simplified Chinese for content.`;
        
        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: [{role:'user', content: prompt}], temperature: 0.85 })
            });
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            let content = reply;
            let weather = "晴"; 
            
            try {
                let start = reply.indexOf('{');
                let end = reply.lastIndexOf('}');
                if(start >= 0 && end > start) {
                    let json = JSON.parse(reply.substring(start, end+1));
                    content = json.content;
                    weather = json.weather || "晴";
                    const wMap = { "Sunny":"晴", "Cloudy":"多云", "Rainy":"雨", "Snowy":"雪" };
                    if(wMap[weather]) weather = wMap[weather];
                }
            } catch(e) {}

            if(!c.diary) c.diary = [];
            let entry = {
                id: Date.now(),
                time: Date.now(),
                date: today,
                weather: weather,
                type: 'ai',
                content: content,
                comments: []
            };
            c.diary.push(entry);
            DB.save();
            
            this.renderFolder(this.folderId);
            Toast.show("TA 写了一篇新日记");
            
        } catch(e) {
            console.error(e);
            Toast.show("生成失败: " + e.message);
        } finally {
            if(refreshBtn) {
                let svg = refreshBtn.querySelector('svg');
                if(svg) svg.classList.remove('rotating');
            }
        }
    },

    submitComment() {
        let val = $('diary-comment-input').value.trim();
        if(!val) return;
        
        let c = DB.getContact(this.folderId);
        let entry = c.diary.find(e => e.id === this.currentEntryId);
        if(!entry) return;
        
        if(!entry.comments) entry.comments = [];
        entry.comments.push({
            id: Date.now(),
            author: 'user',
            content: val,
            time: Date.now()
        });
        DB.save();
        
        $('diary-comment-input').value = '';
        this.renderComments(entry);
        
        setTimeout(() => this.triggerAiReplyToComment(entry, val), 2000);
    },

    async triggerAiComment(entry) {
        let c = DB.getContact(this.folderId);
        let p = DB.getPreset();
        if(!p || !p.key) return;
        
        let prompt = `Roleplay: You are ${c.name}. You peeked at User's diary.
        User's Diary: "${entry.content}"
        
        Task: Write a short comment.
        Requirements:
        1. Reply according to your original Persona and character style.
        2.Use a fragmented, emotional, and highly interactive internet slang style.
        3. Do NOT describe actions. Only reply with spoken words or inner thoughts.`;
        
        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: [{role:'user', content: prompt}], temperature: 0.8 })
            });
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            if(!entry.comments) entry.comments = [];
            entry.comments.push({
                id: Date.now(),
                author: 'ai',
                content: reply,
                time: Date.now()
            });
            DB.save();
            
            if(this.currentEntryId === entry.id && $('sub-diary-detail').classList.contains('active')) {
                this.renderComments(entry);
            }
            Toast.show(`TA 评论了你的日记`);
        } catch(e) {}
    },

    async triggerAiReplyToComment(entry, userComment) {
        let c = DB.getContact(this.folderId);
        let p = DB.getPreset();
        if(!p || !p.key) return;
        
        let prompt = `Roleplay: You are ${c.name}. User commented on your diary.
        Diary: "${entry.content}"
        Comment: "${userComment}"
        
        Task: Reply to comment.
        Requirements:
        1. Reply according to your original Persona and character style.
        2. Do NOT describe actions. Only reply with spoken words or inner thoughts.`;
        
        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: [{role:'user', content: prompt}], temperature: 0.8 })
            });
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            if(!entry.comments) entry.comments = [];
            entry.comments.push({
                id: Date.now(),
                author: 'ai',
                content: reply,
                time: Date.now()
            });
            DB.save();
            
            if(this.currentEntryId === entry.id) {
                this.renderComments(entry);
            }
        } catch(e) {}
    },
    
    openSettings() {
        let c = $('diary-settings-list');
        c.innerHTML = `
            <div class="card-modern">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                    <div class="label-modern" style="margin:0">AUTO GENERATION</div>
                    <span style="font-size:12px;color:#999">勾选以开启</span>
                </div>
                <div id="diary-auto-list" style="width:100%;display:flex;flex-direction:column;gap:15px">
                    <!-- List injected -->
                </div>
                <div style="margin-top:15px;font-size:12px;color:#999;padding-top:15px;border-top:1px dashed #eee">系统将定期为勾选的角色自动生成日记。</div>
            </div>
        `;
        
        let listContainer = c.querySelector('#diary-auto-list');
        let contacts = DB.d.contacts.filter(ct => !ct.isGroup);
        if(!DB.d.diaryAutoList) DB.d.diaryAutoList = []; // Array of IDs
        
        contacts.forEach(ct => {
            let isChecked = DB.d.diaryAutoList.includes(ct.id);
            let row = document.createElement('div');
            row.style.cssText = "display:flex;justify-content:space-between;align-items:center;";
            row.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px">
                    <img src="${ct.avatar||Utils.defAv}" style="width:30px;height:30px;border-radius:10px;object-fit:cover">
                    <span style="font-size:14px;font-weight:600;color:#333">${ct.name}</span>
                </div>
                <input type="checkbox" ${isChecked?'checked':''} style="width:auto">
            `;
            row.querySelector('input').onchange = (e) => this.toggleAutoChar(ct.id, e.target.checked);
            listContainer.appendChild(row);
        });

        App.o('sub-diary-settings');
    },

    toggleAutoChar(id, checked) {
        if(!DB.d.diaryAutoList) DB.d.diaryAutoList = [];
        if(checked) {
            if(!DB.d.diaryAutoList.includes(id)) DB.d.diaryAutoList.push(id);
        } else {
            DB.d.diaryAutoList = DB.d.diaryAutoList.filter(x => x !== id);
        }
        DB.d.diaryAutoUpdate = DB.d.diaryAutoList.length > 0; // Sync master switch
        DB.save();
    },

    applyBg() {}
};


// --- apps/profile.js --- 
const OwnerProfile = {
    render() {
        let p = DB.d.ownerProfile || {};
        let c = $('owner-profile-container');
        if(!c) return;
        
        let bDay = p.birthday || '';
        if(bDay.length === 5 && bDay.indexOf('-') === 2) bDay = '2000-' + bDay;

        let ageOpts = '';
        for(let i=0; i<=100; i++) ageOpts += `<option value="${i}" ${p.age==i?'selected':''}>${i}岁</option>`;
        
        const zodiacs = ['白羊座','金牛座','双子座','巨蟹座','狮子座','处女座','天秤座','天蝎座','射手座','摩羯座','水瓶座','双鱼座'];
        let zodiacOpts = zodiacs.map(z => `<option value="${z}" ${p.zodiac==z?'selected':''}>${z}</option>`).join('');

        let contactOpts = '<option value="">未绑定</option>' + DB.d.contacts.filter(ct => !ct.isGroup).map(ct => `<option value="${ct.id}" ${p.relativeCardId == ct.id ? 'selected' : ''}>${ct.name}</option>`).join('');
        let boundContact = DB.getContact(p.relativeCardId);
        let relativeCardInfo = boundContact ? `
            <div style="margin-top:10px;padding:15px;background:#f0f8ff;border-radius:12px;color:var(--text-main);display:flex;flex-direction:column;gap:5px;border:1px solid #e1f5fe">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="font-size:12px;opacity:0.7">亲属卡余额 (由${boundContact.name}提供)</div>
                    <button class="btn-pill btn-white" style="padding:4px 12px;font-size:10px;height:24px" onclick="OwnerProfile.editRelWallet()">修改</button>
                </div>
                <div style="font-size:24px;font-weight:bold;font-family:'SF Pro Display'">¥${DB.d.walletBalance}</div>
            </div>` : '<div style="font-size:12px;color:#ccc;margin-top:5px">未绑定亲属卡</div>';
        
        c.innerHTML = `
        <div class="card-modern" style="align-items:center;padding:30px 20px">
            <div style="position:relative;cursor:pointer" onclick="Crop.open('owner-av')">
                <img id="owner-av-img" src="${DB.d.ownerAvatar || Utils.defAv}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;box-shadow:0 10px 20px rgba(0,0,0,0.1);border:4px solid white">
                <div style="position:absolute;bottom:0;right:0;background:var(--accent);color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white">📷</div>
            </div>
            <input class="input-modern" value="${p.name||''}" placeholder="设置名字" onchange="OwnerProfile.u('name',this.value)" style="text-align:center;font-size:24px;font-weight:800;margin-top:15px;background:transparent;box-shadow:none">
            <div style="font-size:12px;color:#ccc">点击头像或名字编辑</div>
        </div>

        <div class="card-modern">
             <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                 <div>
                     <div class="label-modern">GENDER</div>
                     <select class="input-modern" onchange="OwnerProfile.u('gender',this.value)">
                        <option value="保密" ${p.gender=='保密'?'selected':''}>保密</option>
                        <option value="男" ${p.gender=='男'?'selected':''}>男</option>
                        <option value="女" ${p.gender=='女'?'selected':''}>女</option>
                     </select>
                 </div>
                 <div>
                     <div class="label-modern">AGE</div>
                     <select class="input-modern" onchange="OwnerProfile.u('age',this.value)">${ageOpts}</select>
                 </div>
                 <div>
                     <div class="label-modern">BIRTHDAY</div>
                     <input type="date" class="input-modern" value="${bDay}" onchange="OwnerProfile.u('birthday',this.value)" style="font-family:inherit">
                 </div>
                 <div>
                     <div class="label-modern">ZODIAC</div>
                     <select class="input-modern" onchange="OwnerProfile.u('zodiac',this.value)">${zodiacOpts}</select>
                 </div>
             </div>
             <div style="margin-top:10px">
                 <div class="label-modern">BIO</div>
                 <textarea class="input-modern" placeholder="写点什么..." onchange="OwnerProfile.u('bio',this.value)" style="height:100px;resize:none">${p.bio||''}</textarea>
             </div>
        </div>

        <div class="card-modern">
            <div class="label-modern">FAMILY CARD</div>
            <select class="input-modern" onchange="OwnerProfile.u('relativeCardId', this.value); OwnerProfile.render();">${contactOpts}</select>
            ${relativeCardInfo}
        </div>

        <div class="card-modern" style="background:#fff8e1;border:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="label-modern" style="color:#8d6e63;margin:0">MY WALLET (PRIVATE)</div>
                <button class="btn-pill btn-white" style="padding:4px 12px;font-size:10px;height:24px;color:#8d6e63" onclick="OwnerProfile.editWallet()">修改余额</button>
            </div>
            <div style="font-size:36px;font-weight:800;margin-top:10px;font-family:'SF Pro Display';color:#5d4037">¥${DB.d.myWallet}</div>
            <div style="font-size:12px;color:#8d6e63;opacity:0.8">Char 转账将自动存入此账户</div>
        </div>
        `;
    },
    u(k, v) {
        if(!DB.d.ownerProfile) DB.d.ownerProfile = {};
        DB.d.ownerProfile[k] = v;
        DB.save();
    },
    editWallet() {
        let n = prompt("修改我的余额:", DB.d.myWallet);
        if(n !== null && !isNaN(n)) {
            DB.d.myWallet = parseFloat(n);
            DB.save();
            this.render();
        }
    },
    editRelWallet() {
        let n = prompt("修改亲属卡余额:", DB.d.walletBalance);
        if(n !== null && !isNaN(n)) {
            DB.d.walletBalance = parseFloat(n);
            DB.save();
            this.render();
        }
    }
};


// --- apps/lifeos.js --- 
const LifeOS = {
    timer: null,
    timeLeft: 0,
    isFocusing: false,
    curYear: new Date().getFullYear(),
    curMonth: new Date().getMonth(),
    selectedDate: null, 
    tips: [
        "如果痛得厉害 要及时吃止痛药 不要硬扛哦。",
        "按合谷穴会减少疼痛：用一只手拇指关节横纹正对另一只手虎口边，拇指按下，指尖所指处即是。",
        "红糖姜茶可以暖宫驱寒，缓解不适。",
        "经期避免剧烈运动，瑜伽舒缓动作是不错的选择。",
        "多吃富含铁质的食物，如菠菜、红肉。",
        "保持心情愉悦，看部轻松的电影吧。",
        "注意保暖，不要贪凉吃冰淇淋哦。"
    ],
    
    init() {
        if(!DB.d.lifeOS) DB.d.lifeOS = { periodData: {}, meds: [], goals: [] };
        if(!DB.d.lifeOS.goals) DB.d.lifeOS.goals = [];
        if(!DB.d.lifeOS.focusAvatar) DB.d.lifeOS.focusAvatar = '';
        
        this.checkMedsReset();
        this.checkGoalsReset();
        this.renderMeds();
        this.renderCalendar();
        this.updateTip();
        if(DB.d.lifeOS.focusAvatar && $('focus-avatar-img')) $('focus-avatar-img').src = DB.d.lifeOS.focusAvatar;
    },
    
    switchTab(tab) {
        document.querySelectorAll('.life-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`lt-${tab}`).classList.add('active');
        
        ['view-focus', 'view-care', 'view-meds'].forEach(v => $(v).style.display = 'none');
        $(`view-${tab}`).style.display = 'flex';
        
        if(tab === 'focus') this.updateTimerDisplay(true);
        if(tab === 'care') this.renderCalendar();
        if(tab === 'meds') this.renderMeds();
    },
    
    // Focus Logic
    updateTimerDisplay(fromInput=false) {
        if(fromInput && !this.isFocusing) {
            let min = parseInt($('focus-duration').value) || 25;
            this.timeLeft = min * 60;
        }
        let m = Math.floor(this.timeLeft / 60);
        let s = this.timeLeft % 60;
        $('focus-display').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    },

    toggleFocus() {
        if(this.isFocusing) {
            clearInterval(this.timer);
            this.isFocusing = false;
            $('focus-btn-txt').innerText = '开始';
            $('focus-circle').classList.remove('active');
        } else {
            let min = parseInt($('focus-duration').value) || 25;
            this.timeLeft = min * 60;
            this.isFocusing = true;
            $('focus-btn-txt').innerText = '结束';
            $('focus-circle').classList.add('active');
            
            this.timer = setInterval(() => {
                this.timeLeft--;
                this.updateTimerDisplay();
                if(this.timeLeft <= 0) {
                    this.toggleFocus();
                    alert("专注时间到！");
                }
            }, 1000);
            this.updateTimerDisplay();
        }
    },

    setFocusAvatar(inp) {
        Utils.b2d(inp.files[0], d => {
            DB.d.lifeOS.focusAvatar = d;
            $('focus-avatar-img').src = d;
            DB.save();
        });
        inp.value = '';
    },
    
    // Goals Logic
    openGoals() {
        App.o('sub-lifeos-goals');
        this.renderGoals();
    },
    
    closeGoals() {
        $('sub-lifeos-goals').classList.remove('active');
    },

    addGoal() {
        let title = prompt("请输入目标名称:");
        if(!title) return;
        let type = confirm("是长期目标吗？(点击确定为长期，取消为短期)") ? 'long' : 'short';
        
        DB.d.lifeOS.goals.push({
            id: Date.now(),
            title: title,
            type: type, // 'long' or 'short'
            checked: false,
            lastCheck: '',
            streak: 0,
            linkedChars: [] // Array of contact IDs
        });
        DB.save();
        this.renderGoals();
    },

    renderGoals() {
        let c = $('lifeos-goals-list');
        c.innerHTML = '';
        if(DB.d.lifeOS.goals.length === 0) c.innerHTML = '<div style="text-align:center;color:#999;padding:20px">暂无目标，点击右上角添加</div>';
        
        DB.d.lifeOS.goals.forEach(g => {
            let item = document.createElement('div');
            item.className = 'card-modern';
            item.style.padding = '15px';
            
            let charNames = g.linkedChars.map(id => {
                let ct = DB.getContact(id);
                return ct ? ct.name : '';
            }).filter(Boolean).join(', ');
            
            let typeBadge = g.type === 'long' ? '<span style="background:#e3f2fd;color:#2196f3;padding:2px 6px;border-radius:4px;font-size:10px;margin-right:5px">长期</span>' : '<span style="background:#e8f5e9;color:#4caf50;padding:2px 6px;border-radius:4px;font-size:10px;margin-right:5px">短期</span>';
            
            item.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div style="font-weight:bold;font-size:16px">${typeBadge}${g.title}</div>
                    <div onclick="LifeOS.delGoal(${g.id})" style="color:#ff3b30;cursor:pointer;font-size:12px">删除</div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                    <div style="font-size:12px;color:#999">
                        坚持: <span style="font-weight:bold;color:#333">${g.streak}</span> 天<br>
                        监督: ${charNames || '无'}
                    </div>
                    <button class="btn-pill ${g.checked ? 'btn-white' : 'btn-black'}" onclick="LifeOS.checkInGoal(${g.id})" style="padding:6px 15px;font-size:12px;height:30px">
                        ${g.checked ? '已打卡' : '打卡'}
                    </button>
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;font-size:12px;color:#666;cursor:pointer" onclick="LifeOS.linkGoalChar(${g.id})">
                    + 关联监督角色
                </div>
            `;
            c.appendChild(item);
        });
    },

    checkInGoal(id) {
        let g = DB.d.lifeOS.goals.find(x => x.id === id);
        if(!g || g.checked) return;
        
        g.checked = true;
        g.lastCheck = new Date().toDateString();
        g.streak++;
        DB.save();
        this.renderGoals();
        Toast.show("打卡成功！");
        
        // Notify linked chars? 
        // Logic: Add a system note to their history so they know user checked in.
        g.linkedChars.forEach(cid => {
            let ct = DB.getContact(cid);
            if(ct) {
                ct.history.push({role:'system', content:`[系统通知] 用户刚刚完成了目标 "${g.title}" 的打卡。坚持天数: ${g.streak}。`, time: Date.now()});
            }
        });
        DB.save();
    },
    
    checkGoalsReset() {
        let today = new Date().toDateString();
        let changed = false;
        if(DB.d.lifeOS.goals) {
            DB.d.lifeOS.goals.forEach(g => {
                if(g.checked && g.lastCheck !== today) {
                    g.checked = false;
                    changed = true;
                    // Note: Logic to detect missed streak could be added here
                }
            });
        }
        if(changed) DB.save();
    },

    linkGoalChar(gid) {
        let g = DB.d.lifeOS.goals.find(x => x.id === gid);
        if(!g) return;
        
        // Simple prompt for now, or could make a modal. 
        // User asked for "Multi-select".
        // Let's use a prompt loop or simple confirm logic for simplicity as I can't easily build a multi-select modal without more HTML.
        // Actually, I can use a simple prompt: "Enter names separated by comma".
        // Or better: Iterate contacts and ask "Link [Name]?"
        
        // Better: Just use the contacts list IDs. 
        // Let's try a simple approach: Show list of names and ask user to type name to toggle.
        
        let contacts = DB.d.contacts.filter(c => !c.isGroup);
        let names = contacts.map(c => c.name).join('\n');
        let input = prompt(`请输入要绑定的角色名字 (当前已绑定: ${g.linkedChars.length}人)\n可选角色:\n${names}`);
        
        if(input) {
            let target = contacts.find(c => c.name === input);
            if(target) {
                if(g.linkedChars.includes(target.id)) {
                    g.linkedChars = g.linkedChars.filter(id => id !== target.id);
                    Toast.show(`已解绑 ${target.name}`);
                } else {
                    g.linkedChars.push(target.id);
                    Toast.show(`已绑定 ${target.name}`);
                }
                DB.save();
                this.renderGoals();
            } else {
                alert("找不到该角色");
            }
        }
    },

    delGoal(id) {
        if(confirm("删除此目标？")) {
            DB.d.lifeOS.goals = DB.d.lifeOS.goals.filter(x => x.id !== id);
            DB.save();
            this.renderGoals();
        }
    },

    // Care Logic
    changeMonth(delta) {
        this.curMonth += delta;
        if(this.curMonth > 11) { this.curMonth = 0; this.curYear++; }
        if(this.curMonth < 0) { this.curMonth = 11; this.curYear--; }
        this.renderCalendar();
    },
    
    renderCalendar() {
        $('care-month-title').innerText = `${this.curYear}年${this.curMonth+1}月`;
        let daysContainer = $('care-calendar-days');
        daysContainer.innerHTML = '';
        
        let firstDay = new Date(this.curYear, this.curMonth, 1).getDay();
        let daysInMonth = new Date(this.curYear, this.curMonth+1, 0).getDate();
        
        let now = new Date();
        let todayStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;

        for(let i=0; i<firstDay; i++) { daysContainer.appendChild($c('div','')); }
        
        for(let d=1; d<=daysInMonth; d++) {
            let dayStr = `${this.curYear}-${(this.curMonth+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            let el = document.createElement('div');
            el.className = 'care-day';
            el.innerText = d;
            
            if(dayStr === todayStr) el.classList.add('today');
            
            let data = DB.d.lifeOS.periodData[dayStr];
            if(data) {
                if(data.type === 'start') el.classList.add('period-start');
                else el.classList.add('period');
            }
            
            el.onclick = () => this.selectDate(dayStr);
            daysContainer.appendChild(el);
        }
    },
    
    selectDate(dateStr) {
        if (this.selectedDate === dateStr && $('care-details-panel').style.display !== 'none') {
            if (DB.d.lifeOS.periodData[dateStr]) {
                delete DB.d.lifeOS.periodData[dateStr];
                Toast.show("标记已取消");
            }
            $('care-details-panel').style.display = 'none';
            this.selectedDate = null;
            DB.save();
            this.renderCalendar();
            return;
        }

        this.selectedDate = dateStr;
        if(!DB.d.lifeOS.periodData[dateStr]) {
            DB.d.lifeOS.periodData[dateStr] = { type: 'period' };
        }
        
        // Show details panel
        $('care-details-panel').style.display = 'block';
        $('care-detail-date').innerText = dateStr;
        
        // Load details into UI
        let d = DB.d.lifeOS.periodData[dateStr] || {};
        this.updateDetailUI('pain', d.pain);
        this.updateDetailUI('flow', d.flow);
        this.updateDetailUI('color', d.color);
        
        DB.save();
        this.renderCalendar();
    },
    
    setDetail(type, val, el) {
        if(!this.selectedDate) return;
        if(!DB.d.lifeOS.periodData[this.selectedDate]) DB.d.lifeOS.periodData[this.selectedDate] = { type: 'period' };
        
        DB.d.lifeOS.periodData[this.selectedDate][type] = val;
        
        this.updateDetailUI(type, val);
    },
    
    updateDetailUI(type, val) {
        document.querySelectorAll(`#opt-${type} .care-tag`).forEach(t => {
            t.classList.toggle('active', t.innerText === val);
        });
    },

    endPeriod() {
        if(this.selectedDate) {
            if(!DB.d.lifeOS.periodData[this.selectedDate]) {
                DB.d.lifeOS.periodData[this.selectedDate] = { type: 'period' };
            }
            DB.d.lifeOS.periodData[this.selectedDate].type = 'end';
            DB.save();
            $('care-details-panel').style.display = 'none';
            Toast.show("已标记为经期结束");
            this.renderCalendar();
        }
    },
    
    saveDetails() {
        DB.save();
        $('care-details-panel').style.display = 'none';
        Toast.show("记录已保存");
        this.renderCalendar();
    },
    
    updateTip() {
        let t = this.tips[Math.floor(Math.random()*this.tips.length)];
        $('care-tip-text').innerText = "💡 " + t;
    },

    // Meds Logic
    renderMeds() {
        let list = $('med-list');
        list.innerHTML = '';
        if(DB.d.lifeOS.meds.length === 0) list.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px">暂无药品</div>';
        DB.d.lifeOS.meds.forEach((m, i) => {
            let el = document.createElement('div');
            el.className = `med-item ${m.done ? 'done' : ''}`;
            el.innerHTML = `
                <div style="display:flex;align-items:center;flex:1">
                    <div class="med-check ${m.done?'checked':''}" onclick="LifeOS.toggleMed(${i})"></div>
                    <div>
                        <div class="med-time">${m.time || '全天'}</div>
                        <div class="med-name">${m.name}</div>
                    </div>
                </div>
                <div onclick="LifeOS.delMed(${i})" style="color:#ff3b30;padding:5px;cursor:pointer">✕</div>`;
            list.appendChild(el);
        });
    },

    addMed() {
        let name = prompt("药品名称:");
        if(!name) return;
        let time = prompt("提醒时间 (例如 09:00, 不填则为全天):");
        DB.d.lifeOS.meds.push({id: Date.now(), name, time: time||'', done: false, lastDate: ''});
        DB.d.lifeOS.meds.sort((a,b) => (a.time||'99:99').localeCompare(b.time||'99:99'));
        DB.save();
        this.renderMeds();
    },

    delMed(i) {
        if(confirm("删除此提醒?")) {
            DB.d.lifeOS.meds.splice(i, 1);
            DB.save();
            this.renderMeds();
        }
    },
    
    toggleMed(i) {
        let m = DB.d.lifeOS.meds[i];
        m.done = !m.done;
        if(m.done) m.lastDate = new Date().toDateString();
        else m.lastDate = '';
        DB.save();
        this.renderMeds();
    },
    
    checkMedsReset() {
        let today = new Date().toDateString();
        let changed = false;
        DB.d.lifeOS.meds.forEach(m => {
            if(m.done && m.lastDate !== today) {
                m.done = false;
                changed = true;
            }
        });
        if(changed) DB.save();
    },
    
    getGoalPrompt(cid) {
        if(!DB.d.lifeOS.goals) return '';
        let myGoals = DB.d.lifeOS.goals.filter(g => g.linkedChars.includes(cid) && !g.checked);
        if(myGoals.length === 0) return '';
        
        let goalTxt = myGoals.map(g => `- ${g.title} (${g.type==='long'?'长期':'短期'})`).join(', ');
        return `[SYSTEM: User's unchecked goals today: ${goalTxt}. You should supervise/remind user.]`;
    }
};


// --- apps/reading.js ---
const SharedReading = {
    currentBook: null,
    currentPage: 0,
    pageSize: 500,
    companionId: null,
    
    init() {
        // No global init needed for books anymore, loaded per contact
    },

    open(cid) {
        this.companionId = cid;
        this.renderShelf();
        $('reading-shelf').classList.add('active');
    },

    closeShelf() {
        $('reading-shelf').classList.remove('active');
    },

    import(inp) {
        let file = inp.files[0];
        if(!file) return;
        let reader = new FileReader();
        reader.onload = (e) => {
            let content = e.target.result;
            let book = {
                id: Date.now(),
                title: file.name.replace('.txt', ''),
                content: content,
                progress: 0,
                theme: { bg: '#e9e5d6', text: '#2c2c2c' },
                history: []
            };
            
            let c = DB.getContact(this.companionId);
            if(!c) return Toast.show('角色数据错误');
            if(!c.books) c.books = [];
            c.books.push(book);
            
            DB.save();
            this.renderShelf();
            Toast.show('导入成功');
        };
        reader.readAsText(file, 'gbk');
        inp.value = '';
    },

    renderShelf() {
        let cEl = $('reading-shelf-list');
        if(!cEl) return;
        cEl.innerHTML = '';
        
        let c = DB.getContact(this.companionId);
        let books = c ? (c.books || []) : [];

        books.forEach(b => {
            let div = document.createElement('div');
            div.className = 'book-item';
            div.innerHTML = `
                <div class="book-cover" style="background:${b.theme?.bg||'#fff'}">${b.title[0]}</div>
                <span class="book-title">${b.title}</span>
                <div class="book-del-btn" onclick="event.stopPropagation();SharedReading.delBook('${b.id}')">✕</div>
            `;
            div.onclick = () => this.read(b.id);
            cEl.appendChild(div);
        });
        
        let addBtn = document.createElement('div');
        addBtn.className = 'book-item';
        addBtn.onclick = () => $('reading-import').click();
        addBtn.innerHTML = `<div class="book-cover add">+</div><span class="book-title">导入书籍</span>`;
        cEl.appendChild(addBtn);
    },

    delBook(id) {
        if(confirm('删除这本书?')) {
            let c = DB.getContact(this.companionId);
            if(c && c.books) {
                c.books = c.books.filter(b => b.id != id);
                DB.save();
                this.renderShelf();
            }
        }
    },

    read(id) {
        let c = DB.getContact(this.companionId);
        if(!c || !c.books) return;
        this.currentBook = c.books.find(b => b.id == id);
        if(!this.currentBook) return;
        
        if (!this.currentBook.content) {
             Toast.show("书籍内容为空或损坏");
             return;
        }

        $('reading-title').innerText = this.currentBook.title;
        this.applyTheme(this.currentBook.theme);
        this.renderPage();
        $('reading-drawer').classList.add('active');
        this.closeShelf();
    },

    closeBook() {
        $('reading-drawer').classList.remove('active');
        $('reading-text-area').classList.remove('shrink');
        $('resonance-chat-box').classList.remove('active');
        let footer = document.querySelector('.reading-footer');
        if(footer) footer.classList.remove('hidden');
        this.currentBook = null;
        this.open(this.companionId); // 返回书架
    },

    renderPage() {
        if(!this.currentBook || !this.currentBook.content) return;
        let start = this.currentBook.progress || 0;
        let end = start + this.pageSize;
        let text = this.currentBook.content.substring(start, end);
        
        $('reading-text-area').innerText = text;
        
        let pct = Math.round((start / this.currentBook.content.length) * 100);
        $('reading-progress-disp').innerText = `${pct}%`;
    },

    prevPage() {
        if(!this.currentBook) return;
        this.currentBook.progress = Math.max(0, (this.currentBook.progress || 0) - this.pageSize);
        DB.save();
        this.renderPage();
    },

    nextPage() {
        if(!this.currentBook) return;
        if(this.currentBook.progress + this.pageSize >= this.currentBook.content.length) return Toast.show('已读完');
        this.currentBook.progress += this.pageSize;
        DB.save();
        this.renderPage();
    },

    toggleSettings() {
        let p = $('reading-settings-panel');
        let o = $('reading-settings-overlay');
        if(p.style.display === 'flex') {
             p.classList.remove('active');
             if(o) o.style.display = 'none';
             setTimeout(() => p.style.display = 'none', 200);
        } else {
             p.style.display = 'flex';
             if(o) o.style.display = 'block';
             // Force reflow
             p.offsetHeight;
             p.classList.add('active');
        }
    },

    setTheme(bg, text) {
        if(!this.currentBook) return;
        this.currentBook.theme = { bg, text };
        DB.save();
        this.applyTheme(this.currentBook.theme);
    },

    applyTheme(t) {
        if(!t) return;
        $('reading-drawer').style.background = t.bg;
        $('reading-text-area').style.color = t.text;
    },

    toggleChat() {
        let box = $('resonance-chat-box');
        let footer = document.querySelector('.reading-footer');
        box.classList.toggle('active');
        $('reading-text-area').classList.toggle('shrink');
        if(box.classList.contains('active')) {
            this.renderChat();
            if(footer) footer.classList.add('hidden');
        } else {
            if(footer) footer.classList.remove('hidden');
        }
    },

    renderChat() {
        let list = $('res-chat-list');
        list.innerHTML = '';
        let history = this.currentBook.history || [];
        history.forEach(msg => {
            let div = document.createElement('div');
            div.className = `res-msg ${msg.role === 'user' ? 'me' : 'ai'}`;
            div.innerText = msg.content;
            list.appendChild(div);
        });
        list.scrollTop = list.scrollHeight;
    },

    async sendReply() {
        let inp = $('res-chat-input');
        let val = inp.value.trim();
        if(!val) return;
        
        if(!this.currentBook.history) this.currentBook.history = [];
        this.currentBook.history.push({ role: 'user', content: val });
        DB.save();
        this.renderChat();
        inp.value = '';
        
        // Removed auto trigger
    },

    async triggerReply(userContext = '') {
        let p = DB.getPreset();
        if(!p || !p.key) return Toast.show('API未配置');
        
        let c = DB.getContact(this.companionId);
        if(!c) return Toast.show('角色数据丢失');

        if(!this.currentBook || !this.currentBook.content) return Toast.show('书籍内容无效');

        Toast.show('TA正在阅读...');
        
        let start = this.currentBook.progress || 0;
        let text = this.currentBook.content.substring(start, start + this.pageSize);
        
        // Get last user message if context is empty
        if (!userContext && this.currentBook.history && this.currentBook.history.length > 0) {
            let last = this.currentBook.history[this.currentBook.history.length - 1];
            if (last.role === 'user') userContext = last.content;
        }

        let prompt = `Roleplay: You are ${c.name}. We are reading a book together.
        Persona: ${c.charPersona}
        Book Title: ${this.currentBook.title}
        Current Text Segment: "${text.substring(0, 300)}..."
        
        User said: "${userContext}"
        
        Task: Reply to User as a reading companion. Share thoughts, feelings, or discuss the text.
        
        【CRITICAL RULES】:
        1. Keep it short and conversational. Use the character's tone.
        2. **Strictly NO action descriptions** (e.g. *smiles*, *nods*, *looks at page*).
        3. **Strictly NO expression descriptions**.
        4. Only output spoken words or internal monologue (if 1st person).
        5. Treat this as an online chat message, not a novel.`;

        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({ model: p.model, messages: [{role:'user', content: prompt}], temperature: 0.7 })
            });
            let d = await res.json();
            let reply = d.choices[0].message.content;
            
            this.currentBook.history.push({ role: 'ai', content: reply });
            DB.save();
            this.renderChat();
            
        } catch(e) {
            console.error(e);
            Toast.show('AI响应失败');
        }
    },

    toggleHistory() {
        let d = $('reading-history');
        d.classList.toggle('active');
        if(d.classList.contains('active')) {
            let list = $('reading-history-list');
            list.innerHTML = '';
            (this.currentBook.history || []).forEach(msg => {
                let div = document.createElement('div');
                div.style.cssText = "padding:10px;background:#f9f9f9;border-radius:8px;font-size:12px;margin-bottom:5px";
                div.innerHTML = `<b>${msg.role==='user'?'我':'TA'}:</b> ${msg.content}`;
                list.appendChild(div);
            });
        }
    }
};

// --- apps/music_together.js ---
const MusicTogether = {
    playlist: [
        { title: "Rainy Day", artist: "Lo-Fi Chill", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", cover: "https://source.unsplash.com/random/300x300?rain", lyrics: ["[00:00.00]Rainy Day - Lo-Fi Chill", "[00:05.00]Listening to the rain...", "[00:10.00]Feeling calm and relaxed...", "[00:20.00]Just you and me...", "[00:30.00]Forever together..."] },
        { title: "Sunny Vibes", artist: "Pop Star", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", cover: "https://source.unsplash.com/random/300x300?sun", lyrics: ["[00:00.00]Sunny Vibes - Pop Star", "[00:05.00]Walking in the sun...", "[00:15.00]Everything is bright...", "[00:25.00]Let's dance together!"] },
        { title: "Night Drive", artist: "Synthwave", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", cover: "https://source.unsplash.com/random/300x300?night", lyrics: ["[00:00.00]Night Drive - Synthwave", "[00:10.00]Driving through the city...", "[00:20.00]Neon lights everywhere...", "[00:40.00]Speeding up..."] }
    ],
    currentIndex: 0,
    isPlaying: false,
    mode: 'sequence', // sequence, loop, random
    audio: null,
    lyrics: [],
    
    init() {
        this.audio = $('global-audio');
        this.audio.addEventListener('timeupdate', () => this.updateProgress());
        this.audio.addEventListener('ended', () => this.next());
        this.loadPlaylist();
    },

    open() {
        App.o('sub-music-together');
        this.updateUI();
        
        // Set Avatars
        let c = DB.getContact(Chat.cid);
        let me = DB.d.ownerProfile;
        $('mt-av-me').src = me.avatar || Utils.defAv;
        $('mt-av-ai').src = c ? (c.avatar || Utils.defAv) : Utils.defAv;
        
        if (!this.audio.src) {
            this.loadSong(0);
        }
    },

    loadSong(index) {
        this.currentIndex = index;
        let song = this.playlist[this.currentIndex];
        this.audio.src = song.src;
        this.parseLyrics(song.lyrics);
        this.updateUI();
        if (this.isPlaying) this.audio.play();
    },

    togglePlay() {
        if (this.audio.paused) {
            this.play();
        } else {
            this.pause();
        }
    },

    play() {
        this.audio.play();
        this.isPlaying = true;
        this.updatePlayIcon();
        $('mt-cover').classList.add('playing');
    },

    pause() {
        this.audio.pause();
        this.isPlaying = false;
        this.updatePlayIcon();
        $('mt-cover').classList.remove('playing');
    },

    prev() {
        this.currentIndex = (this.currentIndex - 1 + this.playlist.length) % this.playlist.length;
        this.loadSong(this.currentIndex);
        this.play();
    },

    next() {
        if (this.mode === 'random') {
            this.currentIndex = Math.floor(Math.random() * this.playlist.length);
        } else if (this.mode === 'loop') {
            this.audio.currentTime = 0;
            this.play();
            return;
        } else {
            this.currentIndex = (this.currentIndex + 1) % this.playlist.length;
        }
        this.loadSong(this.currentIndex);
        this.play();
    },

    seek(val) {
        let time = (val / 100) * this.audio.duration;
        this.audio.currentTime = time;
    },

    toggleMode() {
        const modes = ['sequence', 'loop', 'random'];
        const icons = {
            'sequence': '<path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>', // Refresh icon as sequence/cycle
            'loop': '<path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>', // Repeat
            'random': '<path d="M16 3h5v5"></path><path d="M4 20L21 3"></path><path d="M21 16v5h-5"></path><path d="M15 15l-5 5"></path><path d="M4 4l5 5"></path>' // Shuffle
        };
        
        let idx = modes.indexOf(this.mode);
        this.mode = modes[(idx + 1) % modes.length];
        $('mt-mode-icon').innerHTML = icons[this.mode];
        
        let modeNames = {'sequence': '列表循环', 'loop': '单曲循环', 'random': '随机播放'};
        Toast.show(modeNames[this.mode]);
    },

    updateUI() {
        let song = this.playlist[this.currentIndex];
        $('mt-song-title').innerText = song.title;
        $('mt-song-artist').innerText = song.artist;
        $('mt-cover').src = song.cover;
        $('mt-bg-layer').style.backgroundImage = `url(${song.cover})`;
        this.updatePlayIcon();
        this.renderPlaylist();
    },

    updatePlayIcon() {
        let icon = this.isPlaying ?
            '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>' :
            '<polygon points="5 3 19 12 5 21 5 3"></polygon>';
        $('mt-play-icon').innerHTML = icon;
    },

    updateProgress() {
        if (!this.audio.duration) return;
        let curr = this.audio.currentTime;
        let dur = this.audio.duration;
        let pct = (curr / dur) * 100;
        
        $('mt-prog-bar').value = pct;
        $('mt-time-curr').innerText = this.fmtTime(curr);
        $('mt-time-total').innerText = this.fmtTime(dur);
        
        this.updateLyrics(curr);
    },

    fmtTime(s) {
        let m = Math.floor(s / 60);
        let sec = Math.floor(s % 60);
        return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    },

    parseLyrics(lrcArr) {
        this.lyrics = lrcArr.map(line => {
            let match = line.match(/\[(\d{2}):(\d{2}\.\d{2})\](.*)/);
            if (match) {
                return {
                    time: parseInt(match[1]) * 60 + parseFloat(match[2]),
                    text: match[3]
                };
            }
            return null;
        }).filter(l => l);
        
        let scroll = $('mt-lyrics-scroll');
        scroll.innerHTML = '';
        this.lyrics.forEach((l, i) => {
            let div = document.createElement('div');
            div.className = 'mt-lyric-line';
            div.id = `lyric-${i}`;
            div.innerText = l.text;
            scroll.appendChild(div);
        });
    },

    updateLyrics(time) {
        let activeIdx = -1;
        for (let i = 0; i < this.lyrics.length; i++) {
            if (time >= this.lyrics[i].time) {
                activeIdx = i;
            } else {
                break;
            }
        }
        
        if (activeIdx !== -1) {
            document.querySelectorAll('.mt-lyric-line').forEach(el => el.classList.remove('active'));
            let el = $(`lyric-${activeIdx}`);
            if (el) {
                el.classList.add('active');
                let scroll = $('mt-lyrics-scroll');
                // Center the active line
                let offset = el.offsetTop - scroll.offsetHeight / 2 + el.offsetHeight / 2;
                scroll.style.transform = `translateY(-${Math.max(0, offset)}px)`;
            }
        }
    },

    showPlaylist() {
        $('mt-playlist-drawer').style.transform = 'translateY(0)';
    },

    renderPlaylist() {
        let c = $('mt-playlist-content');
        c.innerHTML = '';
        this.playlist.forEach((s, i) => {
            let div = document.createElement('div');
            div.className = `mt-list-item ${i === this.currentIndex ? 'active' : ''}`;
            div.innerHTML = `
                <div style="font-size:14px;font-weight:bold;color:${i === this.currentIndex ? 'var(--accent)' : 'white'}" class="mt-list-title">${s.title}</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-left:auto">${s.artist}</div>
            `;
            div.onclick = () => {
                this.loadSong(i);
                this.play();
            };
            c.appendChild(div);
        });
    },
    
    loadPlaylist() {
        // In a real app, this might load from DB or API
        this.renderPlaylist();
    },

    recommend() {
        let song = this.playlist[this.currentIndex];
        let c = DB.getContact(Chat.cid);
        if (!c) return Toast.show("请先选择聊天对象");
        
        if (confirm(`向 ${c.name} 推荐歌曲《${song.title}》?`)) {
            Chat.send(null, 'text', {content: `我正在听《${song.title}》，觉得很适合你~ 🎵`});
            Toast.show("已推荐");
            
            // AI Reaction Simulation
            setTimeout(() => {
                Chat.triggerAI(`[SYSTEM: User recommended a song "${song.title}" by ${song.artist}. Listen to it and give a short comment.]`);
            }, 2000);
        }
    }
};

// --- apps/world.js ---
const World = {
    eid: null,
    new() { 
        this.eid = null; 
        $('world-key').value=''; 
        $('world-content').value=''; 
        $('world-global-cb').checked = false;
        App.o('sub-world-edit'); 
    },
    e(id) { 
        this.eid = id; 
        let w = DB.d.world.find(x=>x.id==id); 
        $('world-key').value=w.key; 
        $('world-content').value=w.content; 
        $('world-global-cb').checked = w.isGlobal || false;
        App.o('sub-world-edit'); 
    },
    s() {
        let k = $('world-key').value.trim(), c = $('world-content').value.trim();
        let isGlobal = $('world-global-cb').checked;
        if(!k) return alert('标题不能为空');
        if(this.eid) { 
            let w = DB.d.world.find(x=>x.id==this.eid); 
            w.key = k; 
            w.content = c; 
            w.isGlobal = isGlobal;
        } else { 
            DB.d.world.push({id: Date.now(), key: k, content: c, isGlobal: isGlobal}); 
        }
        DB.save(); this.render(); App.b();
    },
    del() { if(this.eid && confirm('删除此世界设定?')) { DB.d.world = DB.d.world.filter(x=>x.id!=this.eid); DB.save(); this.render(); App.b(); } },
    render() {
        let c = $('world-list'); if(!c) return; c.innerHTML = '';
        
        let globals = DB.d.world.filter(w => w.isGlobal);
        let normals = DB.d.world.filter(w => !w.isGlobal);
        
        const renderGroup = (title, list) => {
            if(list.length === 0) return;
            let label = document.createElement('div');
            label.style.cssText = "padding:10px 5px;font-size:12px;color:#999;font-weight:bold";
            label.innerText = title;
            c.appendChild(label);
            
            list.forEach(w => {
                let div = document.createElement('div');
                div.className = 'world-card-item';
                div.style.cssText = `
                    background: #fff; 
                    border-radius: 16px; 
                    padding: 15px; 
                    margin-bottom: 15px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
                    border: 1px solid rgba(0,0,0,0.05);
                    transition: transform 0.2s;
                `;
                div.innerHTML = `
                    <div style="display:flex;width:100%;justify-content:space-between;align-items:center;cursor:pointer" onclick="World.toggle(${w.id})">
                        <b style="font-size:16px;color:#333">${w.key}</b>
                        <div style="display:flex;align-items:center;gap:15px">
                             <div onclick="event.stopPropagation();World.e(${w.id})" style="color:#ccc;cursor:pointer;padding:5px">✎</div>
                             <span id="world-arrow-${w.id}" style="font-size:12px;color:#ccc;transition:transform 0.3s">▼</span>
                        </div>
                    </div>
                    <div id="world-body-${w.id}" style="display:none;width:100%;padding-top:15px;border-top:1px dashed #eee;margin-top:10px">
                        <div style="font-size: calc(14px * var(--app-font-scale));color:#555;line-height:1.6;white-space:pre-wrap;">${w.content}</div>
                    </div>
                `;
                div.active = () => { div.style.transform = 'scale(0.98)'; };
                div.onmousedown = div.active; div.ontouchstart = div.active;
                div.onmouseup = () => div.style.transform = 'scale(1)'; div.ontouchend = () => div.style.transform = 'scale(1)';
                
                c.appendChild(div);
            });
        };
        
        renderGroup("全局设定 (默认生效)", globals);
        renderGroup("可选设定 (需手动绑定)", normals);

        if(DB.d.world.length === 0) c.innerHTML = '<div style="text-align:center;padding:40px;color:#ccc">暂无世界设定<br>点击右上角 + 添加</div>';
    },
    toggle(id) {
        let body = $(`world-body-${id}`);
        let arrow = $(`world-arrow-${id}`);
        if(body.style.display === 'none') {
            body.style.display = 'block';
            arrow.style.transform = 'rotate(180deg)';
        } else {
            body.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
        }
    }
};


// --- apps/schedule.js --- 
const ScheduleApp = {
    curCid: null,
    open() {
        App.o('app-schedule');
        this.renderList();
        $('sc-char-select').style.display = 'block';
        $('sc-detail-view').style.display = 'none';
    },
    renderList() {
        let grid = $('sc-char-list');
        grid.innerHTML = '';
        let chars = DB.d.contacts.filter(c => !c.isGroup);
        if (chars.length === 0) {
            grid.innerHTML = '<div style="grid-column:span 3;text-align:center;color:#999">暂无角色，请先添加联系人</div>';
            return;
        }
        chars.forEach(c => {
            let div = document.createElement('div');
            div.className = 'char-sel-item';
            div.innerHTML = `<img src="${c.avatar||Utils.defAv}" class="char-sel-av"><span class="char-sel-name">${c.name}</span>`;
            div.onclick = () => this.view(c.id);
            grid.appendChild(div);
        });
    },
    view(cid) {
        this.curCid = cid;
        $('sc-char-select').style.display = 'none';
        $('sc-detail-view').style.display = 'block';
        let c = DB.getContact(cid);
        $('sc-cur-av').src = c.avatar || Utils.defAv;
        $('sc-cur-name').innerText = c.name;
        
        if (!c.schedule || !c.scheduleDate || c.scheduleDate !== new Date().toDateString()) {
            $('sc-timeline').innerHTML = '<div style="padding:40px;text-align:center;color:#999">暂无今日行程<br>点击右上角生成</div>';
            $('sc-cur-status').innerText = '未生成';
        } else {
            this.renderTimeline(c.schedule);
        }
    },
    async generate(force=false) {
        let c = DB.getContact(this.curCid);
        let p = DB.getPreset();
        
        $('sc-cur-status').innerText = '正在推演今日行程...';
        $('sc-timeline').innerHTML = '<div style="padding:20px;text-align:center;color:#999">AI 正在根据人设、作息和昨日经历推演今日行程...<br>这可能需要几秒钟。</div>';
        
        if (!p || !p.key) {
            Toast.show('请先配置API');
            return;
        }

        let summary = c.summary || '无';
        let history = c.history.slice(-10).map(m=>`${m.role}: ${m.content}`).join('\n');
        
        let prompt = `Roleplay Engine: Generate a daily schedule for character "${c.name}".
        
        Character Persona: ${c.charPersona}
        Current World/Context: ${c.worldView || 'Modern Daily Life'}
        Recent Chat Summary: ${summary}
        Recent History: ${history}
        
        Task:
        1. Analyze the character's routine, job, and recent events (Butterfly Effect). 
        2. If they stayed up late chatting, they might wake up late. If they had unfinished work, they might be stressed today.
        3. Generate a timeline of 5-8 key events for TODAY.
        
        Format strictly as a JSON array of objects:
        [
            { "time": "08:00", "activity": "Title", "desc": "Details...", "status": "done/pending", "impact": "Consequence/Mood" }
        ]
        
        "status": use "done" for past events (before now), "pending" for future.
        "impact": Brief note on how this affects them (e.g. "Feeling sleepy due to late chat", "Excited about date").
        
        Do not include markdown or explanations. Only JSON.`;

        try {
            let res = await fetch(`${p.url}/chat/completions`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${p.key}`},
                body: JSON.stringify({
                    model: p.model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: 0.7
                })
            });
            let d = await res.json();
            let content = d.choices[0].message.content;
            content = content.replace(/```json/g, '').replace(/```/g, '').trim();
            
            let schedule = JSON.parse(content);
            c.schedule = schedule;
            c.scheduleDate = new Date().toDateString();
            DB.save();
            
            this.renderTimeline(schedule);
            $('sc-cur-status').innerText = `今日行程 (${new Date().toLocaleDateString()})`;
            
        } catch(e) {
            console.error(e);
            $('sc-timeline').innerHTML = '<div style="text-align:center;color:red;padding:20px">生成失败，请重试</div>';
            $('sc-cur-status').innerText = '生成失败';
        }
    },
    renderTimeline(schedule) {
        let con = $('sc-timeline');
        con.innerHTML = '';
        if(!schedule) return;
        
        let nowH = new Date().getHours();
        
        schedule.forEach(item => {
            let timeH = parseInt(item.time.split(':')[0]);
            let isPast = timeH < nowH;
            let statusClass = isPast ? 'done' : (timeH === nowH ? 'current' : '');
            
            let div = document.createElement('div');
            div.className = `timeline-item ${statusClass}`;
            div.innerHTML = `
                <div class="tl-time">${item.time}</div>
                <div class="tl-dot"></div>
                <div class="tl-card">
<div class="tl-title">${item.activity}</div>
                    <div class="tl-desc">${item.desc}</div>
                    ${item.impact ? `<div class="tl-impact"><svg viewBox="0 0 24 24" fill="currentColor" style="width:14px;height:14px;flex-shrink:0"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg> ${item.impact}</div>` : ''}
                </div>
            `;
            con.appendChild(div);
        });
    }
};


// --- apps/xhs.js --- 
const XhsApp = { init() {} };


// --- apps/settings.js --- 
const Settings = {
    eid:null,
    init(){ this.render(); this.setupDrafts(); this.loadDrafts(); },
    setupDrafts() { ['pre-name', 'pre-url', 'pre-key', 'pre-model-manual'].forEach(id => { const el = $(id); if(el) { el.addEventListener('input', (e) => { const drafts = JSON.parse(localStorage.getItem('api_draft_v2') || '{}'); drafts[id] = e.target.value; localStorage.setItem('api_draft_v2', JSON.stringify(drafts)); }); } }); },
    loadDrafts() { const drafts = JSON.parse(localStorage.getItem('api_draft_v2') || '{}'); ['pre-name', 'pre-url', 'pre-key', 'pre-model-manual'].forEach(id => { const el = $(id); if (el && drafts[id] !== undefined) { el.value = drafts[id]; } }); },  
    render(){
        let d=$('preset-list'), a=DB.d.activePid; d.innerHTML='';
        DB.d.presets.forEach(p=>{
            let isActive = p.id == a;
            d.appendChild($c('div',`list-item ${isActive?'active-preset':''}`,`<div onclick="Settings.use(${p.id})" style="flex:1;cursor:pointer"><span>${p.name}</span><span class="preset-tag">${p.model}</span></div><div onclick="Settings.e(${p.id})" style="padding:10px;color:#999;cursor:pointer">✎</div>`));      
        });
        Appearance.uCheck();
    },
    e(id){ this.eid=id; let p=DB.d.presets.find(x=>x.id==id); $('pre-name').value=p.name; $('pre-url').value=p.url; $('pre-key').value=p.key; $('pre-model-select').innerHTML=`<option>${p.model}</option>`; $('pre-temp').value = p.temperature || 0.7; $('pre-temp-val').innerText = p.temperature || 0.7; App.o('sub-preset-edit'); },
    nP(){ this.eid=null; this.loadDrafts(); $('pre-temp').value = 0.7; $('pre-temp-val').innerText = 0.7; App.o('sub-preset-edit'); },
    async fM(){ Toast.show('正在连接 API...'); try{ let u=$('pre-url').value, k=$('pre-key').value, r=await fetch(`${u}/models`,{headers:{'Authorization':`Bearer ${k}`}}), d=await r.json(), s=$('pre-model-select'); s.innerHTML=''; (d.data||d).forEach(m=>s.add(new Option(m.id,m.id))); Toast.show('列表已更新'); }catch(e){Toast.show('连接失败');} },
    async saveAndUse() {
        const name = $('pre-name').value.trim(); const url = $('pre-url').value.trim(); if (!name || !url) { Toast.show('名称和URL不能为空'); return; }
        let o={ name: name, url: url, key:$('pre-key').value.trim(), model:$('pre-model-select').value||$('pre-model-manual').value||'gpt-3.5-turbo', temperature: parseFloat($('pre-temp').value) };
        if(this.eid) { Object.assign(DB.d.presets.find(x=>x.id==this.eid), o); } else { const newId = Date.now(); this.eid = newId; DB.d.presets.push({id:newId,...o}); localStorage.removeItem('api_draft_v2'); ['pre-name', 'pre-url', 'pre-key', 'pre-model-manual'].forEach(id => $(id).value = ''); }
        DB.d.activePid = this.eid; await DB.save(); this.render(); App.b(); Toast.show('API 预设已保存并设为当前');
    },
    async use(id){ let pid = id || this.eid; if(pid){ DB.d.activePid=pid; await DB.save(); this.render(); if(!id) App.b(); let p = DB.d.presets.find(x=>x.id==pid); Toast.show(`${p?p.name:'未知'} 已设为当前`); } },
    async delP(){ if(this.eid){ DB.d.presets=DB.d.presets.filter(x=>x.id!=this.eid); await DB.save(); this.render(); App.b(); Toast.show('预设已删除'); } },
    exp(){ let b=new Blob([JSON.stringify(DB.d)],{type:'application/json'}), u=URL.createObjectURL(b), a=document.createElement('a'); a.href=u; a.download='AIOS_Backup.json'; a.click(); Toast.show('数据导出中...'); },
    imp(i){ let r=new FileReader(); r.onload=async e=>{ try{ DB.d=JSON.parse(e.target.result); await DB.save(); Toast.show('数据恢复成功，正在刷新...'); setTimeout(()=>location.reload(), 1500); }catch(x){Toast.show('文件格式错误');} }; r.readAsText(i.files[0]); i.value=''; }
};


// --- apps/line.js --- 
const LineApp = {
    sw(idx, el) {
        let tabs = document.querySelectorAll('#app-line .tab-content');
        let navs = document.querySelectorAll('#app-line .nav-tab');
        let bottomNav = document.querySelector('#app-line .bottom-nav');
        
        tabs.forEach((t,i) => t.classList.toggle('active', i===idx));
        navs.forEach((t,i) => t.classList.toggle('active', i===idx));
        
        // Hide bottom nav if Moments (idx 2) is active
        if(bottomNav) {
            bottomNav.style.display = idx === 2 ? 'none' : 'flex';
        }
        
        if(idx===4) { // Me Tab
            OwnerProfile.render();
        }
        if(idx===3) Diary.render();
        if(idx===2) Moments.render();
        if(idx===0) Contacts.render();
    }
};


// --- boot.js ---
$('chat-input').addEventListener('keydown', e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();Chat.handleSendBtn()}});
DB.init().then(()=>{ Contacts.render(); Settings.init(); XhsApp.init(); World.render(); LifeOS.init(); SharedReading.init(); MusicTogether.init(); setInterval(() => { try { App.tick(); } catch(e) { console.error(e); } }, 1000); App.tick(); });

</script>
</body>
</html>
